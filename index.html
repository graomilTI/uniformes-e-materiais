<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gestor ‚Äì Uniformes e Materiais</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <style>
    body{ margin:0; font-family:Arial,sans-serif; background:#f5f6f7; }
    .wrap{ max-width:1100px; margin:auto; padding:14px 14px 120px; }
    .card{ background:#fff; border-radius:14px; padding:14px; margin-bottom:12px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    h2,h3{ margin:0 0 8px; }
    .muted{ color:#6b7280; font-size:12px; white-space:pre-line; }

    input,select,button{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid #d1d5db;
      font-size:14px;
      box-sizing:border-box;
    }
    button{
      cursor:pointer;
      border:none;
      background:#166534;
      color:#fff;
      font-weight:800;
    }
    button.secondary{ background:#374151; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1; min-width:220px; }

    .topbar{ display:flex; justify-content:space-between; gap:10px; }
    .logoutBtn{ width:auto; background:#111827; }

    .item{
      display:grid;
      grid-template-columns:1fr 220px;
      gap:10px;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }

    .nm{ font-weight:800; font-size:13px; }
    .sub{ font-size:11px; color:#6b7280; }

    .bottomBar{
      position:fixed; left:0; right:0; bottom:0;
      background:#f5f6f7;
      border-top:1px solid #e5e7eb;
      padding:10px;
    }
    .bottomBar .inner{
      max-width:1100px;
      margin:auto;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .pdfArea a{
      display:inline-block;
      margin-top:8px;
      font-weight:800;
      color:#166534;
      text-decoration:none;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:90px;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-size:13px;
      font-weight:800;
      opacity:0;
      transition:.2s;
      z-index:9999;
    }
    .toast.show{ opacity:1; }

    @media(max-width:720px){
      .item{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h2>Login do Gestor</h2>
    <div class="muted">Informe seu <b>PIN (4 d√≠gitos)</b></div>

    <div class="row" style="margin-top:10px;">
      <div class="col">
        <input id="pin" placeholder="PIN" inputmode="numeric" maxlength="4">
      </div>
      <div class="col">
        <button id="btnLogin" onclick="login()">Entrar</button>
      </div>
    </div>

    <div id="loginStatus" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;">

    <div class="card">
      <div class="topbar">
        <div>
          <h3>Portal do Gestor</h3>
          <div id="topInfo" class="muted"></div>
          <div id="dataInfo" class="muted"></div>
        </div>
        <button class="logoutBtn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div id="screenUniformes" class="card">
      <h3>Uniformes</h3>
      <div class="muted">Defina o tamanho por colaborador</div>

      <div id="listaUniformes"></div>

      <div class="pdfArea" id="pdfArea"></div>
      <div id="saveStatusUniformes" class="muted"></div>
    </div>

  </div>
</div>

<div class="bottomBar" id="bottomBar" style="display:none;">
  <div class="inner">
    <button onclick="salvarUniformes()">Salvar e Gerar PDF</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ================= CONFIG ================= */
const API_BASE = "https://uniformes-e-materiais.tecnologia-f0c.workers.dev/";
let token = localStorage.getItem("TAM_TOKEN") || "";
let ctx = null;
let formUniformes = {};

/* ================= HELPERS ================= */
function onlyDigits(s){ return String(s||"").replace(/\D/g,""); }
function esc(s){ return String(s||"").replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),2500);
}

function b64ToBlob(b64){
  const bin=atob(b64);
  const arr=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
  return new Blob([arr],{type:"application/pdf"});
}

/* ================= API ================= */
async function api(action,args){
  const payload={ action, ...(args||{}) };
  if(token) payload.token=token;

  const r=await fetch(API_BASE,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body:JSON.stringify(payload)
  });
  return JSON.parse(await r.text());
}

/* ================= LOGIN ================= */
async function login(){
  const pin=onlyDigits(pinInput.value).slice(0,4);
  loginStatus.textContent="Entrando...";
  const r=await api("loginPIN",{ pin });
  if(!r.ok){ loginStatus.textContent=r.error; return; }
  token=r.token;
  localStorage.setItem("TAM_TOKEN",token);
  loginCard.style.display="none";
  app.style.display="block";
  bottomBar.style.display="block";
  bootstrap();
}

function logout(){
  localStorage.removeItem("TAM_TOKEN");
  location.reload();
}

/* ================= BOOT ================= */
async function bootstrap(){
  const r=await api("carregarListaRecente",{});
  ctx=r;
  topInfo.textContent=`Gestor: ${r.gestor.nome} | Coordena√ß√£o: ${r.gestor.coordenacao}`;
  dataInfo.textContent=`Data refer√™ncia: ${r.dataRef}`;

  formUniformes={};
  r.colaboradores.forEach(c=>{
    formUniformes[c.colaborador]={ tamanho:"M" };
  });

  renderUniformes();
}

/* ================= UI ================= */
function renderUniformes(){
  pdfArea.innerHTML="";
  saveStatusUniformes.textContent="";

  listaUniformes.innerHTML=ctx.colaboradores.map(c=>`
    <div class="item">
      <div>
        <div class="nm">${esc(c.colaborador)}</div>
        <div class="sub">${esc(c.supervisao||"")}</div>
      </div>
      <select onchange="formUniformes['${esc(c.colaborador)}'].tamanho=this.value">
        ${ctx.tamanhos.map(t=>`<option>${t}</option>`).join("")}
      </select>
    </div>
  `).join("");
}

/* ================= SALVAR + PDF ================= */
async function salvarUniformes(){
  saveStatusUniformes.textContent="Salvando e gerando PDF...";

  const itens=Object.keys(formUniformes).map(n=>({
    colaborador:n,
    tamanho:formUniformes[n].tamanho
  }));

  const r=await api("salvarTamanhos",{ payload:{ dataRef:ctx.dataRef, itens }});
  if(!r.ok){ saveStatusUniformes.textContent=r.error; return; }

  showToast("PDF gerado com sucesso!");

  /* üöÄ DOWNLOAD AUTOM√ÅTICO */
  if(r.pdf?.b64){
    const blob=b64ToBlob(r.pdf.b64);
    const url=URL.createObjectURL(blob);

    pdfArea.innerHTML=`
      <a id="pdfLink" href="${url}" download="${esc(r.pdf.fileName)}">
        ‚¨áÔ∏è Baixar PDF
      </a>
      <div class="muted">Se n√£o baixar automaticamente, clique no link.</div>
    `;

    setTimeout(()=>{
      document.getElementById("pdfLink")?.click();
      setTimeout(()=>URL.revokeObjectURL(url),30000);
    },100);
  }
}

/* ================= INIT ================= */
const pinInput=document.getElementById("pin");
const loginStatus=document.getElementById("loginStatus");

if(token){
  api("ping",{}).then(r=>{
    if(r.ok){
      loginCard.style.display="none";
      app.style.display="block";
      bottomBar.style.display="block";
      bootstrap();
    }
  });
}
</script>
</body>
</html>
