<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gestor ‚Äì Uniformes, Materiais e EPIs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <style>
    :root{
      --bg:#0b0f19;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --brand:#22c55e;
      --brand2:#16a34a;
      --danger:#ef4444;
      --warn:#f59e0b;

      --radius:18px;
      --radius2:14px;
      --shadow: 0 20px 50px rgba(0,0,0,.45);
      --shadow2: 0 10px 20px rgba(0,0,0,.25);
      --max:1200px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 500px at 90% 0%, rgba(59,130,246,.14), transparent 60%),
        radial-gradient(1200px 700px at 50% 120%, rgba(168,85,247,.10), transparent 55%),
        var(--bg);
      color:var(--txt);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a{ color:rgba(34,197,94,.95); font-weight:900; text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{ max-width:var(--max); margin:auto; padding:16px 16px 140px; }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(11,15,25,.65);
      backdrop-filter: blur(14px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .topbar .inner{
      max-width:var(--max); margin:auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:1000; letter-spacing:.2px;
    }
    .brand .dot{
      width:36px; height:36px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(135deg, rgba(34,197,94,1), rgba(22,163,74,1));
      box-shadow: var(--shadow2);
    }
    .pill{
      display:flex; gap:10px; align-items:center;
      padding:8px 12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      background: rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
    }
    .pill b{ color:var(--txt); font-weight:1000; }

    .card{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding:16px;
      margin-bottom:14px;
      box-shadow: var(--shadow2);
    }
    h2,h3{ margin:0 0 10px; }
    h2{ font-size:18px; font-weight:1000; }
    h3{ font-size:13px; font-weight:1000; color: rgba(255,255,255,.86); }
    .muted{ color:var(--muted); font-size:12.5px; line-height:1.35; white-space:pre-line; }
    .small{ font-size:12px; color:var(--muted); }
    .ok{ color: #86efac; font-weight:1000; }
    .err{ color: #fecaca; font-weight:1000; }
    .warn{ color: #fde68a; font-weight:1000; }

    .line{ height:1px; background: rgba(255,255,255,.10); margin:14px 0; }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    @media (max-width:900px){
      .grid2,.grid3{ grid-template-columns:1fr; }
      .pill{ display:none; }
    }

    input,select,button,textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      font-size:14px;
      outline:none;
      transition: box-shadow .2s ease, border-color .2s ease, transform .06s ease;
    }
    input::placeholder,textarea::placeholder{ color: rgba(255,255,255,.45); }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(34,197,94,.35);
      box-shadow: 0 0 0 4px rgba(34,197,94,.14);
      background: rgba(255,255,255,.08);
    }
    textarea{ min-height:72px; resize:vertical; }

    button{ cursor:pointer; border:none; }
    button:active{ transform: translateY(1px); }

    .btn{
      background: linear-gradient(135deg, rgba(34,197,94,1), rgba(22,163,74,1));
      color:#04110a;
      font-weight:1000;
      box-shadow: 0 18px 40px rgba(34,197,94,.18);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }
    .btn2{
      background: rgba(255,255,255,.88);
      color:#0b1220;
      font-weight:1000;
      box-shadow: 0 14px 30px rgba(0,0,0,.25);
    }
    .btnGhost{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.90);
      font-weight:1000;
    }
    .danger{
      background: linear-gradient(135deg, rgba(239,68,68,1), rgba(153,27,27,1));
      color:#fff;
      font-weight:1000;
      box-shadow: 0 16px 34px rgba(239,68,68,.16);
    }

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:8px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      background: rgba(255,255,255,.04);
    }
    .tab{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-weight:1000;
      font-size:13px;
      color: rgba(255,255,255,.88);
      user-select:none;
    }
    .tab.active{
      background: rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.25);
      color:#d1fae5;
    }

    /* Collapsible sections */
    details{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding:10px 12px;
    }
    details + details{ margin-top:10px; }
    summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:1000;
      color: rgba(255,255,255,.92);
    }
    summary::-webkit-details-marker{ display:none; }
    summary .hint{ font-size:12px; color: var(--muted); font-weight:1000; }
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.84);
      font-size:12px;
      font-weight:1000;
      white-space:nowrap;
    }
    .chipRow{ display:flex; flex-wrap:wrap; gap:8px; }

    /* Uniformes list */
    .uniRow{
      display:grid;
      grid-template-columns: 22px 1fr 130px 80px 120px;
      gap:10px;
      align-items:center;
      padding:12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(255,255,255,.04);
    }
    .uniRow input[type="checkbox"]{
      width:18px; height:18px;
      accent-color: var(--brand);
    }
    .nm{ font-weight:1000; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }

    @media (max-width:900px){
      .uniRow{ grid-template-columns: 22px 1fr; }
      .uniRow select{ margin-top:8px; }
    }

    .itemCard{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
      margin-top:10px;
    }

    .footerBar{
      position:fixed; left:0; right:0; bottom:0; z-index:60;
      background: rgba(11,15,25,.65);
      backdrop-filter: blur(14px);
      border-top:1px solid rgba(255,255,255,.10);
    }
    .footerBar .inner{
      max-width:var(--max); margin:auto; padding:12px 16px;
      display:flex; gap:10px;
    }
    .footerBar .inner button{ padding:12px; border-radius:16px; }
    @media (max-width:700px){
      .footerBar .inner{ display:grid; grid-template-columns:1fr; }
    }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:96px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
      padding:12px 16px;
      border-radius:999px;
      font-weight:1000;
      z-index:9999;
      display:none;
      box-shadow: var(--shadow);
      max-width:92vw;
      text-align:center;
    }
    .busy{
      position:fixed; inset:0; display:none; z-index:9998;
      background:rgba(0,0,0,.50);
      align-items:center; justify-content:center;
    }
    .busy .box{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding:14px 16px;
      border-radius:18px;
      font-weight:1000;
      color: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="dot">üì¶</div>
        <div>
          Gestor ‚Äì Compras
          <div class="small">Uniformes ‚Ä¢ Materiais ‚Ä¢ EPIs ‚Ä¢ Patrim√¥nios</div>
        </div>
      </div>

      <div class="pill">
        <span>DataRef:</span> <b id="pillDataRef">‚Äî</b>
        <span style="margin-left:8px;">Gestor:</span> <b id="pillGestor">‚Äî</b>
      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- LOGIN -->
    <div class="card" id="cardLogin">
      <h2>üîê Login</h2>
      <div class="muted">Informe seu PIN (4 d√≠gitos) para carregar colaboradores e supervis√µes.</div>

      <div class="grid2" style="margin-top:12px;">
        <input id="pin" inputmode="numeric" placeholder="PIN (4 d√≠gitos)" maxlength="4" />
        <button class="btn" onclick="login()">Entrar</button>
      </div>
      <div class="small" id="loginStatus" style="margin-top:10px;"></div>
    </div>

    <!-- APP -->
    <div id="app" style="display:none;">

      <div class="card">
        <div class="chipRow" style="justify-content:space-between; align-items:center;">
          <div class="chip">üóìÔ∏è DataRef: <b id="badgeDataRef">‚Äî</b></div>
          <div class="chip">üë§ <b id="gestorNome">‚Äî</b></div>
          <div class="chip">üè∑Ô∏è <b id="gestorCoord">‚Äî</b></div>
        </div>
        <div class="muted" id="gestorSups" style="margin-top:10px;">‚Äî</div>
      </div>

      <div class="card">
        <div class="tabs">
          <div class="tab active" id="tabUniformes" onclick="setTab('uniformes')">üëï Uniformes</div>
          <div class="tab" id="tabMateriais" onclick="setTab('materiais')">üì¶ Materiais</div>
          <div class="tab" id="tabEPIs" onclick="setTab('epis')">ü¶∫ EPIs</div>
          <div class="tab" id="tabPatrimonios" onclick="setTab('patrimonios')">üßæ Patrim√¥nios</div>
        </div>
        <div class="muted" style="margin-top:10px;">
          Dica: use <b>√öltimo pedido</b> quando for apenas ajustar algo ‚Äî evita refazer tudo.
        </div>
      </div>

      <!-- ================= UNIFORMES ================= -->
      <div class="card" id="paneUniformes">
        <h2>üëï Uniformes</h2>

        <div class="grid2">
          <div>
            <div class="small">Supervis√£o</div>
            <select id="supUniformes" onchange="onChangeSup('uniformes')"></select>
          </div>
          <div>
            <div class="small">Buscar colaborador</div>
            <input id="buscaUniformes" placeholder="Digite um nome..." oninput="renderUniformes()" />
          </div>
        </div>

        <div class="line"></div>

        <div class="chipRow" style="justify-content:space-between;">
          <div class="chip" id="uniResumo">Resumo: ‚Äî</div>
          <div class="chipRow">
            <button class="btnGhost" style="width:auto; padding:10px 12px;" onclick="setAllUniformes(true)">Marcar todos</button>
            <button class="btnGhost" style="width:auto; padding:10px 12px;" onclick="setAllUniformes(false)">Desmarcar</button>
          </div>
        </div>

        <div style="margin-top:12px;">
          <details>
            <summary>
              <span>‚öôÔ∏è A√ß√µes avan√ßadas</span>
              <span class="hint">√öltimo pedido ‚Ä¢ PDF ‚Ä¢ PedidoId</span>
            </summary>

            <div class="line"></div>

            <div class="grid3">
              <div>
                <div class="small">Modo</div>
                <select id="modoUniformes" onchange="modo.uniformes=this.value">
                  <option value="NOVA">NOVO PEDIDO</option>
                  <option value="ATUALIZAR">ALTERAR PEDIDO</option>
                </select>
              </div>
              <div>
                <div class="small">PedidoId (ALTERAR)</div>
                <input id="pedidoIdUniformes" placeholder="(auto ao carregar √∫ltimo pedido)" />
              </div>
              <div>
                <div class="small">A√ß√µes</div>
                <div class="grid2">
                  <button class="btnGhost" onclick="carregarUltimoPedido('uniformes')">‚Ü©Ô∏è √öltimo pedido</button>
                  <button class="btnGhost" onclick="refreshUltimoPDF('uniformes')">üìÑ √öltimo PDF</button>
                </div>
              </div>
            </div>

            <div class="small" id="infoUltimoUniformes" style="margin-top:10px;"></div>
          </details>

          <details style="margin-top:10px;">
            <summary>
              <span>‚ûï OUTROS (extras)</span>
              <span class="hint">Itens fora da lista</span>
            </summary>

            <div class="line"></div>

            <div class="grid3">
              <div>
                <div class="small">Tamanho</div>
                <select id="outUniTam"></select>
              </div>
              <div>
                <div class="small">Qtd</div>
                <select id="outUniQtd">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                </select>
              </div>
              <div>
                <div class="small">Cor</div>
                <select id="outUniCor"></select>
              </div>
            </div>

            <button class="btn" style="margin-top:10px;" onclick="addOutroUniforme()">Adicionar</button>
            <div id="outrosUniformesList" style="margin-top:10px;"></div>
          </details>
        </div>

        <div class="line"></div>

        <h3>Colaboradores</h3>
        <div class="muted" id="uniHint"></div>
        <div id="listaUniformes" style="margin-top:10px;"></div>

        <div class="small" id="saveStatusUniformes" style="margin-top:12px;"></div>
      </div>

      <!-- ================= MATERIAIS ================= -->
      <div class="card" id="paneMateriais" style="display:none;">
        <h2>üì¶ Materiais</h2>

        <div class="grid2">
          <div>
            <div class="small">Supervis√£o</div>
            <select id="supMateriais" onchange="onChangeSup('materiais')"></select>
          </div>
          <div class="muted" style="display:flex; align-items:end;">
            Preencha quantidades. OUTROS fica recolhido para n√£o poluir.
          </div>
        </div>

        <div class="line"></div>

        <details>
          <summary>
            <span>‚öôÔ∏è A√ß√µes avan√ßadas</span>
            <span class="hint">√öltimo pedido ‚Ä¢ PDF ‚Ä¢ PedidoId</span>
          </summary>

          <div class="line"></div>

          <div class="grid3">
            <div>
              <div class="small">Modo</div>
              <select id="modoMateriais" onchange="modo.materiais=this.value">
                <option value="NOVA">NOVO PEDIDO</option>
                <option value="ATUALIZAR">ALTERAR PEDIDO</option>
              </select>
            </div>
            <div>
              <div class="small">PedidoId (ALTERAR)</div>
              <input id="pedidoIdMateriais" placeholder="(auto ao carregar √∫ltimo pedido)" />
            </div>
            <div>
              <div class="small">A√ß√µes</div>
              <div class="grid2">
                <button class="btnGhost" onclick="carregarUltimoPedido('materiais')">‚Ü©Ô∏è √öltimo pedido</button>
                <button class="btnGhost" onclick="refreshUltimoPDF('materiais')">üìÑ √öltimo PDF</button>
              </div>
            </div>
          </div>

          <div class="small" id="infoUltimoMateriais" style="margin-top:10px;"></div>
        </details>

        <div class="line"></div>

        <h3>Lista fixa</h3>
        <div class="muted">Preencha a quantidade de cada item.</div>
        <div id="listaMateriaisFixos" style="margin-top:10px;"></div>

        <div class="line"></div>

        <details>
          <summary>
            <span>‚ûï OUTROS</span>
            <span class="hint">Descri√ß√£o + quantidade</span>
          </summary>

          <div class="line"></div>

          <div class="grid2">
            <input id="matOutroDesc" placeholder="Descri√ß√£o (ex.: Cabo USB)" />
            <input id="matOutroQtd" inputmode="numeric" placeholder="Qtd" />
          </div>
          <div class="grid2" style="margin-top:10px;">
            <button class="btn" onclick="addMaterialOutro()">Adicionar</button>
            <button class="btnGhost" onclick="clearMateriaisOutros()">Limpar</button>
          </div>

          <div id="listaMateriaisOutros" style="margin-top:10px;"></div>
        </details>

        <div class="small" id="saveStatusMateriais" style="margin-top:12px;"></div>
      </div>

      <!-- ================= EPIs ================= -->
      <div class="card" id="paneEPIs" style="display:none;">
        <h2>ü¶∫ EPIs</h2>

        <div class="grid2">
          <div>
            <div class="small">Supervis√£o</div>
            <select id="supEPIs" onchange="onChangeSup('epis')"></select>
          </div>
          <div class="muted" style="display:flex; align-items:end;">
            Fixos + Botinas por tamanho ficam limpos e organizados.
          </div>
        </div>

        <div class="line"></div>

        <details>
          <summary>
            <span>‚öôÔ∏è A√ß√µes avan√ßadas</span>
            <span class="hint">√öltimo pedido ‚Ä¢ PDF ‚Ä¢ PedidoId</span>
          </summary>

          <div class="line"></div>

          <div class="grid3">
            <div>
              <div class="small">Modo</div>
              <select id="modoEPIs" onchange="modo.epis=this.value">
                <option value="NOVA">NOVO PEDIDO</option>
                <option value="ATUALIZAR">ALTERAR PEDIDO</option>
              </select>
            </div>
            <div>
              <div class="small">PedidoId (ALTERAR)</div>
              <input id="pedidoIdEPIs" placeholder="(auto ao carregar √∫ltimo pedido)" />
            </div>
            <div>
              <div class="small">A√ß√µes</div>
              <div class="grid2">
                <button class="btnGhost" onclick="carregarUltimoPedido('epis')">‚Ü©Ô∏è √öltimo pedido</button>
                <button class="btnGhost" onclick="refreshUltimoPDF('epis')">üìÑ √öltimo PDF</button>
              </div>
            </div>
          </div>

          <div class="small" id="infoUltimoEPIs" style="margin-top:10px;"></div>
        </details>

        <div class="line"></div>

        <h3>Lista fixa</h3>
        <div class="muted">Preencha a quantidade de cada EPI.</div>
        <div id="listaEPIsFixos" style="margin-top:10px;"></div>

        <div class="line"></div>

        <details open>
          <summary>
            <span>üëû Botinas</span>
            <span class="hint">V√°rios tamanhos</span>
          </summary>

          <div class="line"></div>

          <div class="grid3">
            <input id="botTam" placeholder="Tamanho (ex.: 40)" />
            <input id="botQtd" inputmode="numeric" placeholder="Qtd" />
            <button class="btn" onclick="addBotina()">Adicionar</button>
          </div>
          <div class="grid2" style="margin-top:10px;">
            <button class="btnGhost" onclick="clearBotinas()">Limpar botinas</button>
            <div></div>
          </div>

          <div id="listaBotinas" style="margin-top:10px;"></div>
        </details>

        <div class="small" id="saveStatusEPIs" style="margin-top:12px;"></div>
      </div>

      <!-- ================= PATRIMONIOS ================= -->
      <div class="card" id="panePatrimonios" style="display:none;">
        <h2>üßæ Patrim√¥nios</h2>

        <div class="grid2">
          <div>
            <div class="small">Supervis√£o</div>
            <select id="supPatrimonios"></select>
          </div>
          <div>
            <div class="small">A√ß√£o</div>
            <button class="btn" onclick="carregarPatrimonios()">Consultar</button>
          </div>
        </div>

        <div class="line"></div>

        <div class="chipRow">
          <button id="btnPatModoLista" class="btnGhost" style="width:auto; padding:10px 12px;" onclick="setPatModo('LISTA')">üìã Lista</button>
          <button id="btnPatModoColab" class="btnGhost" style="width:auto; padding:10px 12px;" onclick="setPatModo('COLABORADOR')">üë§ Colaborador</button>
          <div class="chip" id="patriInfo" style="margin-left:auto;">‚Äî</div>
        </div>

        <div id="listaPatrimonios" style="margin-top:12px;"></div>
      </div>

    </div><!-- /app -->
  </div><!-- /wrap -->

  <div class="footerBar" id="footerBar" style="display:none;">
    <div class="inner">
      <button class="btnGhost" onclick="reloadAll()">Recarregar</button>
      <button class="btn" onclick="salvarAtual()">Salvar e Baixar PDF</button>
      <button class="danger" onclick="logout()">Sair</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div class="busy" id="busy"><div class="box">Processando‚Ä¶</div></div>

<script>
/** =============================
 * CONFIG
 * ============================= */
const WEBAPP_URL = "https://uniformes-e-materiais.tecnologia-f0c.workers.dev/"; // ‚úÖ seu Worker

const CORES_UNIFORME = ["VERDE","CINZA"];
const TAMANHOS_FALLBACK = ["PP","P","M","G","GG","XG","G1","G2","G3"];

const MATERIAIS_FIXOS = [
  "BALAN√áA",
  "IMPRESSORA DE LAUDO",
  "CALADOR",
  "KIT DE PENEIRAS",
  "QUARTEADOR",
  "ALICATE DE CORTE"
];

const EPIS_FIXOS = [
  "Capacete",
  "Protetor auricular",
  "√ìculos Transparente",
  "Luva Multitato PU",
  "Mascara PFF2"
];

let token = "";
let ctx = { dataRef:"", gestor:{}, colaboradores:[], tamanhos:[] };
const modo = { uniformes:"NOVA", materiais:"NOVA", epis:"NOVA" };
let tab = "uniformes";
let patModo = "LISTA";

/** =============================
 * ESTADO (Formul√°rios)
 * ============================= */
// Uniformes
let formUniformes = {};     // key(nome norm) => {nome,on,tamanho,qtd,cor, supervisao, coordenacao}
let outrosUniformes = [];   // [{tamanho,qtd,cor}]

// Materiais
let materiaisFixosQtd = {}; // nome => qtd
let materiaisOutros = [];   // [{desc,qtd}]

// EPIs
let episFixosQtd = {};      // nome => qtd
let botinas = [];           // [{tamanho,qtd}]

/** =============================
 * HELPERS
 * ============================= */
function normKey(s){
  return String(s||"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g," ")
    .trim().toUpperCase();
}
function esc(s){
  return String(s||"").replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));
}
function isSemSup_(s){
  const v = normKey(s);
  return !v || v === normKey("SEM SUPERVIS√ÉO");
}
function colKey_(nome){ return normKey(nome||""); }

function showToast(msg){
  const el = document.getElementById("toast");
  el.textContent = String(msg||"");
  el.style.display = "block";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> el.style.display="none", 2600);
}
function setBusy(v){
  document.getElementById("busy").style.display = v ? "flex" : "none";
}
function setBtnDisabled(v){
  document.querySelectorAll("button").forEach(b=> b.disabled = !!v);
}

/** ‚úÖ base URL sem query/hash */
function getDefaultPostUrl_(){
  return (window.location.origin + window.location.pathname);
}

/**
 * ‚úÖ API robusta (text/plain) + parse JSON
 */
async function api(action, payloadObj){
  const url = (WEBAPP_URL && WEBAPP_URL.trim()) ? WEBAPP_URL.trim() : getDefaultPostUrl_();
  const body = { action, token, ...(payloadObj||{}) };

  let res, text="";
  try{
    res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(body)
    });
    text = await res.text();
  }catch(e){
    return { ok:false, error:"Falha de rede/CORS", raw:String(e?.message||e) };
  }

  try{
    return JSON.parse(text);
  }catch(_){
    console.log("API NON-JSON:", { httpStatus: res?.status, url, preview: String(text||"").slice(0,400) });
    return { ok:false, error:`Resposta inv√°lida do servidor (HTTP ${res?.status||"?"}).`, raw:text };
  }
}

/** =============================
 * DOWNLOAD PDF (FOR√áADO)
 * ============================= */
function extractDriveId_(url){
  const s = String(url||"");
  let m = s.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if(m && m[1]) return m[1];
  m = s.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if(m && m[1]) return m[1];
  return "";
}
function toDirectDownloadUrl_(url){
  const id = extractDriveId_(url);
  if(!id) return String(url||"");
  return "https://drive.google.com/uc?export=download&id=" + encodeURIComponent(id);
}
function forceDownload_(url, filename){
  const a = document.createElement("a");
  a.href = toDirectDownloadUrl_(url);
  a.download = filename || "";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/** =============================
 * TABS
 * ============================= */
function setTab(t){
  tab = t;

  document.getElementById("tabUniformes").classList.toggle("active", t==="uniformes");
  document.getElementById("tabMateriais").classList.toggle("active", t==="materiais");
  document.getElementById("tabEPIs").classList.toggle("active", t==="epis");
  document.getElementById("tabPatrimonios").classList.toggle("active", t==="patrimonios");

  document.getElementById("paneUniformes").style.display = (t==="uniformes") ? "" : "none";
  document.getElementById("paneMateriais").style.display = (t==="materiais") ? "" : "none";
  document.getElementById("paneEPIs").style.display = (t==="epis") ? "" : "none";
  document.getElementById("panePatrimonios").style.display = (t==="patrimonios") ? "" : "none";
}

function setPatModo(m){
  patModo = m;
  document.getElementById("btnPatModoLista").style.opacity = (m==="LISTA") ? "1" : ".75";
  document.getElementById("btnPatModoColab").style.opacity = (m==="COLABORADOR") ? "1" : ".75";
  renderPatrimonios(lastPatrimoniosCache || []);
}

/** =============================
 * LOGIN / LOAD
 * ============================= */
async function login(){
  const pin = document.getElementById("pin").value.trim();
  document.getElementById("loginStatus").textContent = "Validando‚Ä¶";
  setBusy(true); setBtnDisabled(true);

  const res = await api("loginPIN", { pin });

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    document.getElementById("loginStatus").innerHTML = `<span class="err">${esc(res.error||"Falha no login")}</span>`;
    showToast(res.error || "Falha no login");
    return;
  }

  token = res.token;
  document.getElementById("loginStatus").innerHTML = `<span class="ok">OK</span>`;
  await bootstrap();
}

async function bootstrap(){
  setBusy(true); setBtnDisabled(true);

  const res = await api("carregarListaRecente");

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    showToast(res.error || "Falha ao carregar lista.");
    return;
  }

  ctx = res;

  // UI
  document.getElementById("cardLogin").style.display = "none";
  document.getElementById("app").style.display = "";
  document.getElementById("footerBar").style.display = "";

  document.getElementById("pillDataRef").textContent = ctx.dataRef || "‚Äî";
  document.getElementById("pillGestor").textContent = (ctx.gestor?.nome || "‚Äî");
  document.getElementById("badgeDataRef").textContent = ctx.dataRef || "‚Äî";

  document.getElementById("gestorNome").textContent = ctx.gestor?.nome || "‚Äî";
  document.getElementById("gestorCoord").textContent = ctx.gestor?.coordenacao || "‚Äî";
  document.getElementById("gestorSups").textContent =
    "Supervis√µes liberadas: " + ((ctx.gestor?.supervisoesLiberadas||[]).join("; ") || "‚Äî");

  // combos
  const sups = buildSupList();
  fillSelect("supUniformes", sups);
  fillSelect("supMateriais", sups);
  fillSelect("supEPIs", sups);
  fillSelect("supPatrimonios", sups);

  // combos uniformes OUTROS
  const tams = (ctx.tamanhos||[]).length ? ctx.tamanhos : TAMANHOS_FALLBACK;
  fillSelect("outUniTam", tams);
  fillSelect("outUniCor", CORES_UNIFORME);

  initStateFromCtx_();

  setTab("uniformes");
  renderUniformes();
  renderMateriais();
  renderEPIs();
  showToast("Lista carregada!");
}

function initStateFromCtx_(){
  formUniformes = {};
  (ctx.colaboradores||[]).forEach(c=>{
    const nome = String(c?.colaborador||"").trim();
    if(!nome) return;
    const k = colKey_(nome);
    formUniformes[k] = {
      nome,
      on:true,
      tamanho:(String(c?.tamanho||"M").trim() || "M").toUpperCase(),
      qtd:1,
      cor:"VERDE",
      supervisao:String(c?.supervisao||"").trim(),
      coordenacao:String(c?.coordenacao||"").trim()
    };
  });
  outrosUniformes = [];

  materiaisFixosQtd = {};
  MATERIAIS_FIXOS.forEach(n=> materiaisFixosQtd[n]=0);
  materiaisOutros = [];

  episFixosQtd = {};
  EPIS_FIXOS.forEach(n=> episFixosQtd[n]=0);
  botinas = [];
}

function buildSupList(){
  const set = new Set();

  const supsLib = Array.isArray(ctx?.gestor?.supervisoesLiberadas) ? ctx.gestor.supervisoesLiberadas : [];
  if(supsLib.length){
    supsLib.forEach(s=> set.add(String(s||"").trim() || "SEM SUPERVIS√ÉO"));
  }else{
    (ctx.colaboradores||[]).forEach(c=>{
      const s = String(c?.supervisao||"").trim() || "SEM SUPERVIS√ÉO";
      s.split(/[;,]/g).map(x=>String(x||"").trim()).filter(Boolean).forEach(x=> set.add(x));
      if(!s.trim()) set.add("SEM SUPERVIS√ÉO");
    });
  }

  const arr = Array.from(set);
  const sem = arr.find(x=>isSemSup_(x));
  const rest = arr.filter(x=>!isSemSup_(x)).sort((a,b)=>normKey(a).localeCompare(normKey(b)));
  return [sem || "SEM SUPERVIS√ÉO"].concat(rest);
}
function fillSelect(id, list){
  const el = document.getElementById(id);
  el.innerHTML = (list||[]).map(v=> `<option value="${esc(v)}">${esc(v)}</option>`).join("");
}

/** =============================
 * SUP CHANGE
 * ============================= */
function onChangeSup(tipo){
  if(tipo==="uniformes"){ renderUniformes(); refreshUltimoPDF("uniformes"); }
  if(tipo==="materiais"){ renderMateriais(); refreshUltimoPDF("materiais"); }
  if(tipo==="epis"){ renderEPIs(); refreshUltimoPDF("epis"); }
}

/** =============================
 * FILTRO colaboradores por Supervis√£o
 * ============================= */
function listColsBySup_(supSel){
  const arr = Array.isArray(ctx?.colaboradores) ? ctx.colaboradores : [];
  const supN = normKey(supSel||"");

  return arr.filter(c=>{
    const s = String(c?.supervisao||"").trim();
    if(isSemSup_(supSel)) return isSemSup_(s);

    const parts = String(s||"").split(/[;,]/g).map(x=>String(x||"").trim()).filter(Boolean);
    if(!parts.length) return false;
    return parts.some(p => normKey(p) === supN);
  });
}

/** =============================
 * UNIFORMES ‚Äî sele√ß√£o em massa + resumo
 * ============================= */
function setAllUniformes(on){
  const supSel = document.getElementById("supUniformes").value || "SEM SUPERVIS√ÉO";
  const list = listColsBySup_(supSel);

  // respeita o filtro de busca atual
  const q = normKey(document.getElementById("buscaUniformes").value || "");
  list.forEach(c=>{
    const nome = String(c.colaborador||"").trim();
    if(!nome) return;
    if(q && !normKey(nome).includes(q)) return;

    const k = colKey_(nome);
    if(!formUniformes[k]) formUniformes[k] = { nome, on:true, tamanho:"M", qtd:1, cor:"VERDE" };
    formUniformes[k].on = !!on;
  });

  renderUniformes();
}

function calcUniformesResumo_(supSel){
  const list = listColsBySup_(supSel);
  let sel=0, itens=0;
  list.forEach(c=>{
    const nome = String(c.colaborador||"").trim();
    const k = colKey_(nome);
    const st = formUniformes[k];
    if(st?.on){
      sel++;
      itens += (Number(st.qtd||1)||1);
    }
  });
  // OUTROS soma no total de itens
  (outrosUniformes||[]).forEach(o=>{ itens += (Number(o.qtd||0)||0); });
  return { total:list.length, selecionados:sel, itens };
}

/** =============================
 * UNIFORMES ‚Äî RENDER + OUTROS
 * ============================= */
function renderUniformes(){
  const supSel = document.getElementById("supUniformes").value || "SEM SUPERVIS√ÉO";
  let list = listColsBySup_(supSel);

  const q = normKey(document.getElementById("buscaUniformes").value || "");
  if(q){
    list = list.filter(c => normKey(c.colaborador||"").includes(q));
  }

  const el = document.getElementById("listaUniformes");
  const hint = document.getElementById("uniHint");
  hint.textContent = `Supervis√£o: ${supSel} | Nesta supervis√£o: ${list.length}`;

  const r = calcUniformesResumo_(supSel);
  document.getElementById("uniResumo").textContent =
    `Resumo: ${r.selecionados}/${r.total} selecionados ‚Ä¢ ${r.itens} itens`;

  if(!list.length){
    el.innerHTML = `<div class="muted">Nenhum colaborador encontrado.</div>`;
    return;
  }

  list.sort((a,b)=> normKey(a.colaborador).localeCompare(normKey(b.colaborador)));

  const tamanhos = (ctx.tamanhos||[]).length ? ctx.tamanhos : TAMANHOS_FALLBACK;

  el.innerHTML = list.map(c=>{
    const nome = String(c.colaborador||"").trim();
    const k = colKey_(nome);

    if(!formUniformes[k]){
      formUniformes[k] = { nome, on:true, tamanho:"M", qtd:1, cor:"VERDE", supervisao:supSel, coordenacao:String(c.coordenacao||"") };
    }
    const st = formUniformes[k];

    return `
      <div class="uniRow">
        <input type="checkbox" ${st.on ? "checked":""}
          onchange="formUniformes['${esc(k)}'].on = this.checked; renderUniformes()">

        <div>
          <div class="nm">${esc(nome)}</div>
          <div class="sub">${esc(String(c.supervisao||""))}</div>
        </div>

        <select onchange="formUniformes['${esc(k)}'].tamanho = this.value">
          ${tamanhos.map(t=>`<option value="${esc(t)}" ${String(st.tamanho).toUpperCase()===String(t).toUpperCase()?"selected":""}>${esc(t)}</option>`).join("")}
        </select>

        <select onchange="formUniformes['${esc(k)}'].qtd = Number(this.value)||1; renderUniformes()">
          ${[1,2].map(n=>`<option value="${n}" ${Number(st.qtd)===n?"selected":""}>${n}</option>`).join("")}
        </select>

        <select onchange="formUniformes['${esc(k)}'].cor = this.value">
          ${CORES_UNIFORME.map(cor=>`<option value="${esc(cor)}" ${String(st.cor).toUpperCase()===String(cor).toUpperCase()?"selected":""}>${esc(cor)}</option>`).join("")}
        </select>
      </div>
    `;
  }).join("");

  renderOutrosUniformes();
}

function addOutroUniforme(){
  const tamanho = document.getElementById("outUniTam").value;
  const qtd = Number(document.getElementById("outUniQtd").value)||0;
  const cor = document.getElementById("outUniCor").value || "VERDE";

  if(!tamanho){ showToast("Selecione um tamanho."); return; }
  if(qtd<=0){ showToast("Qtd deve ser > 0."); return; }

  outrosUniformes.push({ tamanho, qtd, cor });
  renderOutrosUniformes();
  renderUniformes();
  showToast("OUTROS adicionado.");
}

function removeOutroUniforme(i){
  outrosUniformes.splice(i,1);
  renderOutrosUniformes();
  renderUniformes();
}

function renderOutrosUniformes(){
  const el = document.getElementById("outrosUniformesList");
  if(!outrosUniformes.length){
    el.innerHTML = `<div class="muted">Nenhum OUTROS adicionado.</div>`;
    return;
  }
  el.innerHTML = outrosUniformes.map((o,i)=>`
    <div class="itemCard">
      <div class="grid3">
        <div><b>Tam:</b> ${esc(o.tamanho)}</div>
        <div><b>Qtd:</b> ${esc(o.qtd)}</div>
        <div><b>Cor:</b> ${esc(o.cor)}</div>
      </div>
      <div style="margin-top:10px;">
        <button class="btnGhost" onclick="removeOutroUniforme(${i})">Remover</button>
      </div>
    </div>
  `).join("");
}

/** =============================
 * MATERIAIS ‚Äî FIXOS + OUTROS
 * ============================= */
function renderMateriais(){
  const elFix = document.getElementById("listaMateriaisFixos");
  elFix.innerHTML = MATERIAIS_FIXOS.map(nome=>{
    const v = Number(materiaisFixosQtd[nome]||0);
    return `
      <div class="itemCard">
        <div class="grid2" style="align-items:center;">
          <div><b>${esc(nome)}</b><div class="muted">Quantidade</div></div>
          <input inputmode="numeric" value="${esc(v)}"
            onchange="materiaisFixosQtd['${esc(nome)}']=Number(this.value)||0" />
        </div>
      </div>
    `;
  }).join("");

  renderMateriaisOutros();
}

function addMaterialOutro(){
  const desc = document.getElementById("matOutroDesc").value.trim();
  const qtd = Number(document.getElementById("matOutroQtd").value)||0;
  if(!desc || qtd<=0){
    showToast("Informe descri√ß√£o e qtd > 0.");
    return;
  }
  materiaisOutros.push({ desc, qtd });
  document.getElementById("matOutroDesc").value = "";
  document.getElementById("matOutroQtd").value = "";
  renderMateriaisOutros();
}

function clearMateriaisOutros(){
  materiaisOutros = [];
  renderMateriaisOutros();
}

function removeMaterialOutro(i){
  materiaisOutros.splice(i,1);
  renderMateriaisOutros();
}

function renderMateriaisOutros(){
  const el = document.getElementById("listaMateriaisOutros");
  if(!materiaisOutros.length){
    el.innerHTML = `<div class="muted">Nenhum OUTROS adicionado.</div>`;
    return;
  }
  el.innerHTML = materiaisOutros.map((o,i)=>`
    <div class="itemCard">
      <div><b>${esc(o.desc)}</b></div>
      <div class="muted">Qtd: <b>${esc(o.qtd)}</b></div>
      <div style="margin-top:10px;">
        <button class="btnGhost" onclick="removeMaterialOutro(${i})">Remover</button>
      </div>
    </div>
  `).join("");
}

/** =============================
 * EPIs ‚Äî FIXOS + BOTINAS
 * ============================= */
function renderEPIs(){
  const elFix = document.getElementById("listaEPIsFixos");
  elFix.innerHTML = EPIS_FIXOS.map(nome=>{
    const v = Number(episFixosQtd[nome]||0);
    return `
      <div class="itemCard">
        <div class="grid2" style="align-items:center;">
          <div><b>${esc(nome)}</b><div class="muted">Quantidade</div></div>
          <input inputmode="numeric" value="${esc(v)}"
            onchange="episFixosQtd['${esc(nome)}']=Number(this.value)||0" />
        </div>
      </div>
    `;
  }).join("");

  renderBotinas();
}

function addBotina(){
  const tamanho = document.getElementById("botTam").value.trim();
  const qtd = Number(document.getElementById("botQtd").value)||0;
  if(!tamanho || qtd<=0){
    showToast("Informe tamanho e qtd > 0.");
    return;
  }
  botinas.push({ tamanho, qtd });
  document.getElementById("botTam").value = "";
  document.getElementById("botQtd").value = "";
  renderBotinas();
}

function clearBotinas(){
  botinas = [];
  renderBotinas();
}

function removeBotina(i){
  botinas.splice(i,1);
  renderBotinas();
}

function renderBotinas(){
  const el = document.getElementById("listaBotinas");
  if(!botinas.length){
    el.innerHTML = `<div class="muted">Nenhuma botina adicionada.</div>`;
    return;
  }
  el.innerHTML = botinas.map((b,i)=>`
    <div class="itemCard">
      <div class="grid2">
        <div><b>Tamanho:</b> ${esc(b.tamanho)}</div>
        <div><b>Qtd:</b> ${esc(b.qtd)}</div>
      </div>
      <div style="margin-top:10px;">
        <button class="btnGhost" onclick="removeBotina(${i})">Remover</button>
      </div>
    </div>
  `).join("");
}

/** =============================
 * SALVAR (Uniformes / Materiais / EPIs) + PDF DOWNLOAD
 * ============================= */
async function salvarAtual(){
  if(tab==="uniformes") return salvarUniformes();
  if(tab==="materiais") return salvarMateriaisUI();
  if(tab==="epis") return salvarEPIsUI();
  if(tab==="patrimonios") return showToast("Patrim√¥nios √© somente consulta.");
}

async function salvarUniformes(){
  const sup = document.getElementById("supUniformes").value || "SEM SUPERVIS√ÉO";
  const pedidoId = document.getElementById("pedidoIdUniformes").value.trim();
  const modoSel = document.getElementById("modoUniformes").value;

  const list = listColsBySup_(sup).sort((a,b)=> normKey(a.colaborador).localeCompare(normKey(b.colaborador)));

  const itens = [];
  list.forEach(c=>{
    const nome = String(c.colaborador||"").trim();
    const k = colKey_(nome);
    const st = formUniformes[k];
    if(!st || !st.on) return;

    itens.push({
      colaborador: nome,
      supervisao: sup,
      coordenacao: String(c.coordenacao||"").trim(),
      tamanho: String(st.tamanho||"M").toUpperCase(),
      qtd: Number(st.qtd||1)||1,
      cor: String(st.cor||"VERDE").toUpperCase()
    });
  });

  const payload = {
    dataRef: ctx.dataRef,
    modo: modoSel,
    supervisao: sup,
    pedidoId: (modoSel==="ATUALIZAR" ? pedidoId : ""),
    itens,
    outros: outrosUniformes.slice()
  };

  document.getElementById("saveStatusUniformes").textContent = "Salvando‚Ä¶";
  setBusy(true); setBtnDisabled(true);

  const res = await api("salvarTamanhos", { payload });

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    const msg = res.error || "Erro ao salvar.";
    document.getElementById("saveStatusUniformes").innerHTML = `<span class="err">${esc(msg)}</span>`;
    showToast(msg);
    return;
  }

  if(res.pedidoId) document.getElementById("pedidoIdUniformes").value = res.pedidoId;

  document.getElementById("saveStatusUniformes").innerHTML = `<span class="ok">${esc(res.message||"Salvo!")}</span>`;
  showToast("Salvo! Baixando PDF‚Ä¶");

  const pdf = res.pdfUrlDownload || res.pdfUrl || "";
  if(pdf){
    const fname = res.pdfFileName || `Uniformes_${String(ctx.dataRef||"").replaceAll("/","-")}.pdf`;
    forceDownload_(pdf, fname);
  }else{
    await refreshUltimoPDF("uniformes");
  }
}

async function salvarMateriaisUI(){
  const sup = document.getElementById("supMateriais").value || "SEM SUPERVIS√ÉO";
  const pedidoId = document.getElementById("pedidoIdMateriais").value.trim();
  const modoSel = document.getElementById("modoMateriais").value;

  const fixos = MATERIAIS_FIXOS.map(n=>({ material:n, un:Number(materiaisFixosQtd[n]||0)||0 }))
    .filter(x=>x.un>0);

  const outros = materiaisOutros.slice()
    .map(o=>({ material:o.desc, un:Number(o.qtd||0)||0 }))
    .filter(x=>x.material && x.un>0);

  const payload = {
    dataRef: ctx.dataRef,
    modo: modoSel,
    supervisao: sup,
    pedidoId: (modoSel==="ATUALIZAR" ? pedidoId : ""),
    itens: fixos.concat(outros)
  };

  document.getElementById("saveStatusMateriais").textContent = "Salvando‚Ä¶";
  setBusy(true); setBtnDisabled(true);

  const res = await api("salvarMateriais", { payload });

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    const msg = res.error || "Erro ao salvar.";
    document.getElementById("saveStatusMateriais").innerHTML = `<span class="err">${esc(msg)}</span>`;
    showToast(msg);
    return;
  }

  if(res.pedidoId) document.getElementById("pedidoIdMateriais").value = res.pedidoId;

  document.getElementById("saveStatusMateriais").innerHTML = `<span class="ok">${esc(res.message||"Salvo!")}</span>`;
  showToast("Salvo! Baixando PDF‚Ä¶");

  const pdf = res.pdfUrlDownload || res.pdfUrl || "";
  if(pdf){
    const fname = res.pdfFileName || `Materiais_${String(ctx.dataRef||"").replaceAll("/","-")}.pdf`;
    forceDownload_(pdf, fname);
  }else{
    await refreshUltimoPDF("materiais");
  }
}

async function salvarEPIsUI(){
  const sup = document.getElementById("supEPIs").value || "SEM SUPERVIS√ÉO";
  const pedidoId = document.getElementById("pedidoIdEPIs").value.trim();
  const modoSel = document.getElementById("modoEPIs").value;

  const itens = [];
  EPIS_FIXOS.forEach(n=>{
    const un = Number(episFixosQtd[n]||0)||0;
    if(un>0) itens.push({ epi:n, un });
  });

  botinas.forEach(b=>{
    const tam = String(b.tamanho||"").trim();
    const un = Number(b.qtd||0)||0;
    if(tam && un>0) itens.push({ epi:"Botina", tamanho:tam, un });
  });

  const payload = {
    dataRef: ctx.dataRef,
    modo: modoSel,
    supervisao: sup,
    pedidoId: (modoSel==="ATUALIZAR" ? pedidoId : ""),
    itens
  };

  document.getElementById("saveStatusEPIs").textContent = "Salvando‚Ä¶";
  setBusy(true); setBtnDisabled(true);

  const res = await api("salvarEPIs", { payload });

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    const msg = res.error || "Erro ao salvar.";
    document.getElementById("saveStatusEPIs").innerHTML = `<span class="err">${esc(msg)}</span>`;
    showToast(msg);
    return;
  }

  if(res.pedidoId) document.getElementById("pedidoIdEPIs").value = res.pedidoId;

  document.getElementById("saveStatusEPIs").innerHTML = `<span class="ok">${esc(res.message||"Salvo!")}</span>`;
  showToast("Salvo! Baixando PDF‚Ä¶");

  const pdf = res.pdfUrlDownload || res.pdfUrl || "";
  if(pdf){
    const fname = res.pdfFileName || `EPIs_${String(ctx.dataRef||"").replaceAll("/","-")}.pdf`;
    forceDownload_(pdf, fname);
  }else{
    await refreshUltimoPDF("epis");
  }
}

/** =============================
 * √öLTIMO PEDIDO / √öLTIMO PDF
 * ============================= */
function getSupByTipo(tipo){
  if(tipo==="uniformes") return document.getElementById("supUniformes").value || "SEM SUPERVIS√ÉO";
  if(tipo==="materiais") return document.getElementById("supMateriais").value || "SEM SUPERVIS√ÉO";
  if(tipo==="epis") return document.getElementById("supEPIs").value || "SEM SUPERVIS√ÉO";
  return "SEM SUPERVIS√ÉO";
}

async function refreshUltimoPDF(tipo){
  const sup = getSupByTipo(tipo);
  const res = await api("carregarUltimoPDF", { payload:{ tipo, supervisao:sup } });
  if(!res.ok) return;

  const pdfUrl = res.pdfUrlDownload || res.pdfUrl || "";
  const elId = (tipo==="uniformes") ? "infoUltimoUniformes" : (tipo==="materiais") ? "infoUltimoMateriais" : "infoUltimoEPIs";
  const el = document.getElementById(elId);

  if(!pdfUrl){
    el.innerHTML = `<span class="muted">Nenhum PDF encontrado para esta supervis√£o.</span>`;
    return;
  }
  el.innerHTML = `√öltimo PDF: <a href="${esc(pdfUrl)}" target="_blank" rel="noopener">abrir</a>`;
}

async function carregarUltimoPedido(tipo){
  const sup = getSupByTipo(tipo);

  setBusy(true); setBtnDisabled(true);
  const res = await api("carregarUltimoPedido", { payload:{ tipo, supervisao:sup } });
  setBusy(false); setBtnDisabled(false);

  const elId = (tipo==="uniformes") ? "infoUltimoUniformes" : (tipo==="materiais") ? "infoUltimoMateriais" : "infoUltimoEPIs";
  const el = document.getElementById(elId);

  if(!res.ok){
    el.innerHTML = `<span class="err">${esc(res.error||"Erro")}</span>`;
    showToast(res.error || "Erro ao carregar √∫ltimo pedido.");
    return;
  }
  if(!res.last){
    el.innerHTML = `<span class="muted">Nenhum pedido anterior encontrado.</span>`;
    showToast("Nenhum pedido anterior.");
    return;
  }

  const pedidoId = res.last.pedidoId || "";
  const data = res.last.data || {};

  if(tipo==="uniformes"){
    document.getElementById("modoUniformes").value = "ATUALIZAR";
    modo.uniformes = "ATUALIZAR";
    document.getElementById("pedidoIdUniformes").value = pedidoId;

    const itens = Array.isArray(data.itens) ? data.itens : [];
    const outros = Array.isArray(data.outros) ? data.outros : [];

    Object.keys(formUniformes).forEach(k=> formUniformes[k].on = false);

    itens.forEach(it=>{
      const nome = String(it.colaborador||"").trim();
      const k = colKey_(nome);
      if(!formUniformes[k]) formUniformes[k] = { nome, on:true, tamanho:"M", qtd:1, cor:"VERDE" };
      formUniformes[k].on = true;
      formUniformes[k].tamanho = String(it.tamanho||"M").toUpperCase();
      formUniformes[k].qtd = Number(it.qtd||1)||1;
      formUniformes[k].cor = String(it.cor||"VERDE").toUpperCase();
    });

    outrosUniformes = outros.map(o=>({
      tamanho:String(o.tamanho||o.tam||"").trim(),
      qtd:Number(o.qtd||o.un||0)||0,
      cor:String(o.cor||"VERDE").toUpperCase()
    })).filter(o=>o.tamanho && o.qtd>0);

    renderUniformes();
  }

  if(tipo==="materiais"){
    document.getElementById("modoMateriais").value = "ATUALIZAR";
    modo.materiais = "ATUALIZAR";
    document.getElementById("pedidoIdMateriais").value = pedidoId;

    MATERIAIS_FIXOS.forEach(n=> materiaisFixosQtd[n]=0);
    materiaisOutros = [];

    const itens = Array.isArray(data.itens) ? data.itens : [];
    itens.forEach(it=>{
      const nome = String(it.material||"").trim().toUpperCase();
      const un = Number(it.un||0)||0;
      if(!nome || un<=0) return;
      if(MATERIAIS_FIXOS.includes(nome)){
        materiaisFixosQtd[nome] = un;
      }else{
        materiaisOutros.push({ desc:nome, qtd:un });
      }
    });

    renderMateriais();
  }

  if(tipo==="epis"){
    document.getElementById("modoEPIs").value = "ATUALIZAR";
    modo.epis = "ATUALIZAR";
    document.getElementById("pedidoIdEPIs").value = pedidoId;

    EPIS_FIXOS.forEach(n=> episFixosQtd[n]=0);
    botinas = [];

    const itens = Array.isArray(data.itens) ? data.itens : [];
    itens.forEach(it=>{
      const epi = String(it.epi||"").trim();
      if(!epi) return;

      if(normKey(epi)===normKey("Botina")){
        const tam = String(it.tamanho||"").trim();
        const un = Number(it.un||0)||0;
        if(tam && un>0) botinas.push({ tamanho:tam, qtd:un });
        return;
      }

      const found = EPIS_FIXOS.find(x=> normKey(x)===normKey(epi));
      const un = Number(it.un||0)||0;
      if(found && un>0) episFixosQtd[found] = un;
    });

    renderEPIs();
  }

  el.innerHTML = `<span class="ok">Carregado pedidoId: ${esc(pedidoId)}</span>`;
  showToast("√öltimo pedido carregado!");
}

/** =============================
 * PATRIMONIOS (LISTA / COLABORADOR) ‚Äî COLAB MINIMIZADO ‚úÖ
 * ============================= */
let lastPatrimoniosCache = [];

async function carregarPatrimonios(){
  const sup = document.getElementById("supPatrimonios").value || "SEM SUPERVIS√ÉO";

  document.getElementById("patriInfo").textContent = "Consultando‚Ä¶";
  document.getElementById("listaPatrimonios").innerHTML = "";
  setBusy(true); setBtnDisabled(true);

  const res = await api("carregarPatrimonios", { payload:{ supervisao:sup } });

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    document.getElementById("patriInfo").textContent = "Erro";
    showToast(res.error || "Erro ao consultar.");
    return;
  }

  const itens = Array.isArray(res.itens) ? res.itens : [];
  lastPatrimoniosCache = itens;

  document.getElementById("patriInfo").textContent =
    `Itens: ${itens.length} ‚Ä¢ Modo: ${patModo}`;

  renderPatrimonios(itens);
}

function renderPatrimonios(itens){
  const el = document.getElementById("listaPatrimonios");
  if(!Array.isArray(itens) || !itens.length){
    el.innerHTML = `<div class="muted">Nenhum item encontrado.</div>`;
    return;
  }

  const arr = itens.map(it=>{
    const d = Number(it.diasSemLeitura||it.dias||0) || 0;
    return {
      ...it,
      _dias:d,
      _colName: String(it.funcionario||it.colaborador||"").trim() || "(Sem nome)",
      _colKey: normKey(it.funcionario||it.colaborador||"")
    };
  });

  if(patModo === "LISTA"){
    arr.sort((a,b)=> (b._dias - a._dias) || normKey(a.patrimonio).localeCompare(normKey(b.patrimonio)));
    el.innerHTML = arr.slice(0,400).map(it=>`
      <div class="itemCard">
        <div style="font-weight:1000;">${esc(it.patrimonio||"-")} ‚Äî ${esc(it.identificacao||"")}</div>
        <div class="muted">
          ${esc(it._colName)} ‚Ä¢ ${esc(it.supervisao||"")} ‚Ä¢ ${esc(it.coordenacao||"")}<br>
          √öltima leitura: ${esc(it.ultimaLeitura||"-")} ‚Ä¢ Dias sem leitura: <b>${esc(it._dias)}</b>
        </div>
      </div>
    `).join("");
    return;
  }

  // ‚úÖ COLABORADOR: acorde√£o minimizado
  const map = new Map();
  arr.forEach(it=>{
    if(!map.has(it._colKey)) map.set(it._colKey, { nome: it._colName, itens: [] });
    map.get(it._colKey).itens.push(it);
  });

  const groups = Array.from(map.values())
    .sort((a,b)=> normKey(a.nome).localeCompare(normKey(b.nome)));

  el.innerHTML = groups.map(g=>{
    g.itens.sort((a,b)=> (b._dias - a._dias) || normKey(a.patrimonio).localeCompare(normKey(b.patrimonio)));
    const maxDias = g.itens.reduce((m,x)=>Math.max(m, Number(x._dias||0)), 0);
    const count = g.itens.length;

    return `
      <details class="itemCard">
        <summary>
          <span>üë§ ${esc(g.nome)}</span>
          <span class="hint">${count} itens ‚Ä¢ m√°x ${esc(maxDias)} dias</span>
        </summary>

        <div class="line"></div>

        <div>
          ${g.itens.map(it=>`
            <div style="padding:10px 0; border-top:1px solid rgba(255,255,255,.10);">
              <div style="font-weight:1000;">${esc(it.patrimonio||"-")} ‚Äî ${esc(it.identificacao||"")}</div>
              <div class="muted">
                √öltima leitura: ${esc(it.ultimaLeitura||"-")} ‚Ä¢ Dias sem leitura: <b>${esc(it._dias)}</b>
              </div>
            </div>
          `).join("")}
        </div>
      </details>
    `;
  }).join("");
}

/** =============================
 * FOOTER ACTIONS
 * ============================= */
async function reloadAll(){
  if(!token){ location.reload(); return; }
  await bootstrap();
}
function logout(){
  token = "";
  location.reload();
}
</script>

</body>
</html>
