<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gestor ‚Äì Uniformes, Materiais e EPIs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <!-- ‚úÖ evita favicon 404 -->
  <link rel="icon" href="data:,">

  <style>
    :root{
      --bg:#f5f6f7; --card:#fff; --txt:#0f172a; --muted:#6b7280;
      --border:#d1d5db; --brand:#166534; --brand2:#0b3d1a;
      --danger:#b91c1c; --warn:#b45309;
    }
    body{ margin:0; font-family:Arial, sans-serif; background:var(--bg); color:var(--txt); }
    .wrap{ max-width:1200px; margin:auto; padding:14px 14px 140px; }
    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(245,246,247,.95); backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(0,0,0,.05);
    }
    .topbar .inner{ max-width:1200px; margin:auto; padding:10px 14px; display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .brand{ font-weight:800; color:var(--brand2); }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; font-size:12px; color:var(--muted); }
    .pill b{ color:var(--txt); }
    .card{ background:var(--card); border-radius:14px; padding:14px; margin-bottom:12px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    h2,h3{ margin:0 0 8px; }
    h2{ font-size:18px; }
    h3{ font-size:15px; }
    .muted{ color:var(--muted); font-size:12px; white-space:pre-line; }
    .row{ display:grid; grid-template-columns: 1fr; gap:10px; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    @media (max-width:820px){
      .grid2,.grid3{ grid-template-columns:1fr; }
    }
    input,select,button,textarea{
      width:100%; padding:10px; border-radius:12px; border:1px solid var(--border);
      font-size:14px; background:#fff;
    }
    textarea{ min-height:70px; resize:vertical; }
    button{ cursor:pointer; border:none; }
    .btn{
      background:var(--brand); color:#fff; font-weight:800;
      box-shadow:0 1px 2px rgba(0,0,0,.12);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .btn2{ background:#111827; color:#fff; font-weight:800; }
    .btnGhost{ background:#fff; border:1px solid var(--border); font-weight:800; }
    .danger{ background:var(--danger); color:#fff; font-weight:800; }
    .inline{ display:flex; gap:10px; align-items:center; }
    .inline > *{ flex:1; }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
    .tab{
      padding:10px 12px; border-radius:999px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:800; font-size:13px;
    }
    .tab.active{ background:var(--brand); border-color:var(--brand); color:#fff; }
    .footerBar{
      position:fixed; left:0; right:0; bottom:0; z-index:60;
      background:#ffffffcc; backdrop-filter: blur(10px);
      border-top:1px solid rgba(0,0,0,.08);
    }
    .footerBar .inner{
      max-width:1200px; margin:auto; padding:10px 14px;
      display:flex; gap:10px;
    }
    .footerBar .inner button{ padding:12px; border-radius:14px; }
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:90px; background:#111827; color:#fff; padding:12px 16px;
      border-radius:999px; font-weight:800; z-index:9999; display:none;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      max-width:92vw; text-align:center;
    }
    .busy{
      position:fixed; inset:0; display:none; z-index:9998;
      background:rgba(0,0,0,.25);
      align-items:center; justify-content:center;
    }
    .busy .box{
      background:#fff; padding:14px 16px; border-radius:14px;
      font-weight:800; box-shadow:0 10px 30px rgba(0,0,0,.25);
    }

    /* listas */
    .uniRow{
      display:grid;
      grid-template-columns: 26px 1fr 130px 80px 120px;
      gap:10px; align-items:center;
      padding:10px 0; border-bottom:1px solid rgba(0,0,0,.06);
    }
    .uniRow:last-child{ border-bottom:none; }
    .nm{ font-weight:800; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }

    @media (max-width:900px){
      .uniRow{ grid-template-columns: 26px 1fr; }
      .uniRow select{ margin-top:8px; }
      .uniRow .controls{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    }

    .line{ height:1px; background:rgba(0,0,0,.06); margin:12px 0; }
    .small{ font-size:12px; color:var(--muted); }
    .ok{ color:#166534; font-weight:800; }
    .err{ color:var(--danger); font-weight:800; }
    .warn{ color:var(--warn); font-weight:800; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">üì¶ Gestor ‚Äì Compras</div>
      <div class="pill">
        <span>DataRef:</span> <b id="pillDataRef">‚Äî</b>
        <span style="margin-left:8px;">Gestor:</span> <b id="pillGestor">‚Äî</b>
      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- LOGIN -->
    <div class="card" id="cardLogin">
      <h2>üîê Login</h2>
      <div class="muted">Informe seu PIN (4 d√≠gitos) para carregar colaboradores e suas supervis√µes.</div>
      <div class="row" style="margin-top:10px;">
        <input id="pin" inputmode="numeric" placeholder="PIN (4 d√≠gitos)" maxlength="4" />
        <button class="btn" onclick="login()">Entrar</button>
        <div class="small" id="loginStatus"></div>
      </div>
    </div>

    <!-- APP -->
    <div id="app" style="display:none;">

      <div class="card">
        <h2>üë§ Sess√£o</h2>
        <div class="grid3">
          <div>
            <div class="small">Gestor</div>
            <div style="font-weight:800;" id="gestorNome">‚Äî</div>
          </div>
          <div>
            <div class="small">Coordena√ß√£o</div>
            <div style="font-weight:800;" id="gestorCoord">‚Äî</div>
          </div>
          <div>
            <div class="small">Supervis√µes liberadas</div>
            <div class="muted" id="gestorSups">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="tabs">
          <div class="tab active" id="tabUniformes" onclick="setTab('uniformes')">üëï Uniformes</div>
          <div class="tab" id="tabMateriais" onclick="setTab('materiais')">üì¶ Materiais</div>
          <div class="tab" id="tabEPIs" onclick="setTab('epis')">ü¶∫ EPIs</div>
          <div class="tab" id="tabPatrimonios" onclick="setTab('patrimonios')">üßæ Patrim√¥nios</div>
        </div>
        <div class="muted" style="margin-top:6px;">
          Dica: selecione a supervis√£o e clique em <b>Carregar √∫ltimo pedido</b> para reaproveitar.
        </div>
      </div>

      <!-- UNIFORMES -->
      <div class="card" id="paneUniformes">
        <h2>üëï Uniformes</h2>

        <div class="grid3">
          <div>
            <div class="small">Supervis√£o</div>
            <select id="supUniformes" onchange="onChangeSup('uniformes')"></select>
          </div>
          <div>
            <div class="small">Modo</div>
            <select id="modoUniformes" onchange="modo.uniformes=this.value">
              <option value="NOVA">NOVA</option>
              <option value="ATUALIZAR">ATUALIZAR</option>
            </select>
          </div>
          <div>
            <div class="small">PedidoId (ATUALIZAR)</div>
            <input id="pedidoIdUniformes" placeholder="(auto ao carregar √∫ltimo pedido)" />
          </div>
        </div>

        <div class="line"></div>

        <div class="grid2">
          <button class="btnGhost" onclick="carregarUltimoPedido('uniformes')">‚Ü©Ô∏è Carregar √∫ltimo pedido</button>
          <button class="btnGhost" onclick="refreshUltimoPDF('uniformes')">üìÑ Ver √∫ltimo PDF</button>
        </div>
        <div class="small" id="infoUltimoUniformes" style="margin-top:8px;"></div>

        <div class="line"></div>

        <div class="grid2">
          <div>
            <h3>Outros (por tamanho)</h3>
            <div class="muted">Use para extras fora da lista de colaboradores.</div>
          </div>
          <div class="grid3">
            <div>
              <div class="small">Tamanho</div>
              <select id="outTam"></select>
            </div>
            <div>
              <div class="small">Qtd</div>
              <select id="outQtd">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
              </select>
            </div>
            <div>
              <div class="small">Cor</div>
              <select id="outCor"></select>
            </div>
          </div>
          <button class="btn2" onclick="setOutrosUniformes()">Adicionar/Atualizar OUTROS</button>
        </div>
        <div class="small" id="outrosPreview" style="margin-top:8px;"></div>

        <div class="line"></div>

        <h3>Lista de colaboradores</h3>
        <div class="muted" id="uniHint"></div>
        <div id="listaUniformes" style="margin-top:6px;"></div>

        <div class="small" id="saveStatusUniformes" style="margin-top:10px;"></div>
      </div>

      <!-- MATERIAIS -->
      <div class="card" id="paneMateriais" style="display:none;">
        <h2>üì¶ Materiais</h2>

        <div class="grid3">
          <div>
            <div class="small">Supervis√£o</div>
            <select id="supMateriais" onchange="onChangeSup('materiais')"></select>
          </div>
          <div>
            <div class="small">Modo</div>
            <select id="modoMateriais" onchange="modo.materiais=this.value">
              <option value="NOVA">NOVA</option>
              <option value="ATUALIZAR">ATUALIZAR</option>
            </select>
          </div>
          <div>
            <div class="small">PedidoId (ATUALIZAR)</div>
            <input id="pedidoIdMateriais" placeholder="(auto ao carregar √∫ltimo pedido)" />
          </div>
        </div>

        <div class="line"></div>

        <div class="grid2">
          <button class="btnGhost" onclick="carregarUltimoPedido('materiais')">‚Ü©Ô∏è Carregar √∫ltimo pedido</button>
          <button class="btnGhost" onclick="refreshUltimoPDF('materiais')">üìÑ Ver √∫ltimo PDF</button>
        </div>
        <div class="small" id="infoUltimoMateriais" style="margin-top:8px;"></div>

        <div class="line"></div>

        <h3>Itens</h3>
        <div class="grid2">
          <div>
            <div class="small">Material</div>
            <input id="matNome" placeholder="Ex.: Prancheta" />
          </div>
          <div>
            <div class="small">Un</div>
            <input id="matUn" inputmode="numeric" placeholder="Ex.: 2" />
          </div>
        </div>
        <div class="grid2" style="margin-top:10px;">
          <button class="btn2" onclick="addMaterial()">Adicionar</button>
          <button class="btnGhost" onclick="clearMateriais()">Limpar lista</button>
        </div>

        <div id="listaMateriais" style="margin-top:12px;"></div>
        <div class="small" id="saveStatusMateriais" style="margin-top:10px;"></div>
      </div>

      <!-- EPIs -->
      <div class="card" id="paneEPIs" style="display:none;">
        <h2>ü¶∫ EPIs</h2>

        <div class="grid3">
          <div>
            <div class="small">Supervis√£o</div>
            <select id="supEPIs" onchange="onChangeSup('epis')"></select>
          </div>
          <div>
            <div class="small">Modo</div>
            <select id="modoEPIs" onchange="modo.epis=this.value">
              <option value="NOVA">NOVA</option>
              <option value="ATUALIZAR">ATUALIZAR</option>
            </select>
          </div>
          <div>
            <div class="small">PedidoId (ATUALIZAR)</div>
            <input id="pedidoIdEPIs" placeholder="(auto ao carregar √∫ltimo pedido)" />
          </div>
        </div>

        <div class="line"></div>

        <div class="grid2">
          <button class="btnGhost" onclick="carregarUltimoPedido('epis')">‚Ü©Ô∏è Carregar √∫ltimo pedido</button>
          <button class="btnGhost" onclick="refreshUltimoPDF('epis')">üìÑ Ver √∫ltimo PDF</button>
        </div>
        <div class="small" id="infoUltimoEPIs" style="margin-top:8px;"></div>

        <div class="line"></div>

        <h3>Fixos</h3>
        <div id="listaEPIsFixos"></div>

        <div class="line"></div>

        <h3>Botina (por tamanho)</h3>
        <div class="grid2">
          <input id="botTam" placeholder="Tamanho (ex.: 40)" />
          <input id="botQtd" inputmode="numeric" placeholder="Qtd" />
        </div>
        <div class="grid2" style="margin-top:10px;">
          <button class="btn2" onclick="addBotina()">Adicionar</button>
          <button class="btnGhost" onclick="clearBotina()">Limpar botinas</button>
        </div>
        <div id="listaBotina" style="margin-top:10px;"></div>

        <div class="line"></div>

        <h3>Outros (at√© 4)</h3>
        <div class="grid2">
          <input id="epiOutroNome" placeholder="Nome do item" />
          <input id="epiOutroQtd" inputmode="numeric" placeholder="Qtd" />
        </div>
        <div class="grid2" style="margin-top:10px;">
          <button class="btn2" onclick="addEpiOutro()">Adicionar</button>
          <button class="btnGhost" onclick="clearEpiOutros()">Limpar outros</button>
        </div>
        <div id="listaEpiOutros" style="margin-top:10px;"></div>

        <div class="small" id="saveStatusEPIs" style="margin-top:10px;"></div>
      </div>

      <!-- PATRIMONIOS -->
      <div class="card" id="panePatrimonios" style="display:none;">
        <h2>üßæ Patrim√¥nios</h2>

        <div class="grid2">
          <div>
            <div class="small">Supervis√£o</div>
            <select id="supPatrimonios"></select>
          </div>
          <div>
            <div class="small">A√ß√£o</div>
            <button class="btn" onclick="carregarPatrimonios()">Consultar</button>
          </div>
        </div>

        <div class="small" id="patriInfo" style="margin-top:10px;"></div>
        <div id="listaPatrimonios" style="margin-top:10px;"></div>
      </div>

    </div><!-- /app -->
  </div><!-- /wrap -->

  <div class="footerBar" id="footerBar" style="display:none;">
    <div class="inner">
      <button class="btnGhost" onclick="reloadAll()">Recarregar</button>
      <button class="btn" onclick="salvarAtual()">Salvar e Gerar PDF</button>
      <button class="danger" onclick="logout()">Sair</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div class="busy" id="busy"><div class="box">Processando‚Ä¶</div></div>

<script>
/** =============================
 * CONFIG
 * ============================= */
/**
 * ‚úÖ Voc√™ j√° tem um WORKER apontando pro GAS.
 * Ent√£o o front DEVE postar no Worker (n√£o no site).
 */
const WEBAPP_URL = "https://uniformes-e-materiais.tecnologia-f0c.workers.dev/";

const CORES_UNIFORME = ["VERDE","CINZA"];
const EPIS_FIXOS = ["Capacete","Protetor auricular","√ìculos Transparente","Luva PU","Mascara PFF2","Botina"];

let token = "";
let ctx = { dataRef:"", gestor:{}, colaboradores:[], tamanhos:[] };

const modo = { uniformes:"NOVA", materiais:"NOVA", epis:"NOVA" };

// estado
let tab = "uniformes";

// uniformes
let formUniformes = {}; // key(normalizada) => {nome,on,tamanho,qtd,cor}
let formOutrosUni = {}; // tamanho => {qtd, cor}

// materiais
let materiais = []; // {material, un}

// epis
let episFixos = {}; // nome => un
let botinaItens = []; // {tam,qtd}
let epiOutros = []; // {nome, un}

/** =============================
 * HELPERS
 * ============================= */
function normKey(s){
  return String(s||"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g," ")
    .trim().toUpperCase();
}
function esc(s){
  return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
function isSemSup_(s){
  const v = normKey(s);
  return !v || v === normKey("SEM SUPERVIS√ÉO");
}
function colKey_(nome){ return normKey(nome||""); }

function showToast(msg){
  const el = document.getElementById("toast");
  el.textContent = String(msg||"");
  el.style.display = "block";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> el.style.display="none", 2600);
}
function setBusy(v){
  document.getElementById("busy").style.display = v ? "flex" : "none";
}
function setBtnDisabled(v){
  document.querySelectorAll("button").forEach(b=> b.disabled = !!v);
}

/**
 * ‚úÖ API robusta
 * - Envia JSON como text/plain
 * - L√™ text() e tenta JSON.parse
 * - Se vier HTML/erro, retorna ok:false e deixa preview no console
 */
async function api(action, payloadObj){
  if(!WEBAPP_URL || !WEBAPP_URL.trim()){
    return { ok:false, error:"WEBAPP_URL n√£o configurado." };
  }
  const url = WEBAPP_URL.trim();
  const body = { action, token, ...(payloadObj||{}) };

  let res, text = "";
  try{
    res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(body)
    });
    text = await res.text();
  }catch(e){
    console.log("API fetch erro:", e);
    return { ok:false, error:"Falha de rede/CORS", raw:String(e?.message||e) };
  }

  try{
    return JSON.parse(text);
  }catch(_){
    console.log("API NON-JSON:", {
      httpStatus: res?.status,
      url,
      preview: String(text||"").slice(0, 400)
    });
    return { ok:false, error:`Resposta inv√°lida do servidor (HTTP ${res?.status||"?"}). Veja Console.`, raw:text };
  }
}

/** =============================
 * TABS
 * ============================= */
function setTab(t){
  tab = t;

  document.getElementById("tabUniformes").classList.toggle("active", t==="uniformes");
  document.getElementById("tabMateriais").classList.toggle("active", t==="materiais");
  document.getElementById("tabEPIs").classList.toggle("active", t==="epis");
  document.getElementById("tabPatrimonios").classList.toggle("active", t==="patrimonios");

  document.getElementById("paneUniformes").style.display = (t==="uniformes") ? "" : "none";
  document.getElementById("paneMateriais").style.display = (t==="materiais") ? "" : "none";
  document.getElementById("paneEPIs").style.display = (t==="epis") ? "" : "none";
  document.getElementById("panePatrimonios").style.display = (t==="patrimonios") ? "" : "none";
}

/** =============================
 * LOGIN / LOAD
 * ============================= */
async function login(){
  const pin = document.getElementById("pin").value.trim();
  document.getElementById("loginStatus").textContent = "Validando‚Ä¶";
  setBusy(true); setBtnDisabled(true);

  const res = await api("loginPIN", { pin });

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    document.getElementById("loginStatus").innerHTML = `<span class="err">${esc(res.error||"Falha no login")}</span>`;
    showToast(res.error || "Falha no login");
    return;
  }

  token = res.token;
  document.getElementById("loginStatus").innerHTML = `<span class="ok">OK</span>`;
  await bootstrap();
}

async function bootstrap(){
  setBusy(true); setBtnDisabled(true);

  const res = await api("carregarListaRecente");
  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    showToast(res.error || "Falha ao carregar lista.");
    return;
  }

  ctx = res;

  // UI
  document.getElementById("cardLogin").style.display = "none";
  document.getElementById("app").style.display = "";
  document.getElementById("footerBar").style.display = "";

  document.getElementById("pillDataRef").textContent = ctx.dataRef || "‚Äî";
  document.getElementById("pillGestor").textContent = (ctx.gestor?.nome || "‚Äî");

  document.getElementById("gestorNome").textContent = ctx.gestor?.nome || "‚Äî";
  document.getElementById("gestorCoord").textContent = ctx.gestor?.coordenacao || "‚Äî";
  document.getElementById("gestorSups").textContent = (ctx.gestor?.supervisoesLiberadas||[]).join("; ") || "‚Äî";

  // combos
  const sups = buildSupList();
  fillSelect("supUniformes", sups);
  fillSelect("supMateriais", sups);
  fillSelect("supEPIs", sups);
  fillSelect("supPatrimonios", sups);

  // tamanhos/cores
  fillSelect("outTam", (ctx.tamanhos||[]).length ? ctx.tamanhos : ["PP","P","M","G","GG","XG","G1","G2","G3"]);
  fillSelect("outCor", CORES_UNIFORME);

  // init fixos
  EPIS_FIXOS.forEach(e=>{ episFixos[e] = 0; });
  renderEPIsFixos();

  // monta formUniformes (chave normalizada)
  formUniformes = {};
  (ctx.colaboradores||[]).forEach(c=>{
    const nome = String(c?.colaborador||"").trim();
    if(!nome) return;
    const k = colKey_(nome);
    formUniformes[k] = { nome, on:true, tamanho:"M", qtd:1, cor:"VERDE" };
  });

  formOutrosUni = {};
  updateOutrosPreview();

  // render inicial
  setTab("uniformes");
  renderUniformes();
  renderMateriais();
  renderEPIs();
  showToast("Lista carregada!");
}

function buildSupList(){
  // tenta usar supervis√µes liberadas; se vazio, deriva da lista de colaboradores
  const set = new Set();

  const supsLib = Array.isArray(ctx?.gestor?.supervisoesLiberadas) ? ctx.gestor.supervisoesLiberadas : [];
  if(supsLib.length){
    supsLib.forEach(s=> set.add(String(s||"").trim() || "SEM SUPERVIS√ÉO"));
  }else{
    (ctx.colaboradores||[]).forEach(c=>{
      const s = String(c?.supervisao||"").trim() || "SEM SUPERVIS√ÉO";
      // se vier "A;B" ou "A,B", quebra e adiciona
      s.split(/[;,]/g).map(x=>String(x||"").trim()).filter(Boolean).forEach(x=> set.add(x));
      if(!s.trim()) set.add("SEM SUPERVIS√ÉO");
    });
  }

  const arr = Array.from(set);
  // garante SEM SUPERVIS√ÉO no topo
  const sem = arr.find(x=>isSemSup_(x));
  const rest = arr.filter(x=>!isSemSup_(x)).sort((a,b)=>normKey(a).localeCompare(normKey(b)));
  return [sem || "SEM SUPERVIS√ÉO"].concat(rest);
}

function fillSelect(id, list){
  const el = document.getElementById(id);
  el.innerHTML = (list||[]).map(v=> `<option value="${esc(v)}">${esc(v)}</option>`).join("");
}

/** =============================
 * SUP CHANGE
 * ============================= */
function onChangeSup(tipo){
  if(tipo==="uniformes"){
    renderUniformes();
    refreshUltimoPDF("uniformes");
  }
  if(tipo==="materiais"){
    renderMateriais();
    refreshUltimoPDF("materiais");
  }
  if(tipo==="epis"){
    renderEPIs();
    refreshUltimoPDF("epis");
  }
}

/** =============================
 * UNIFORMES
 * ============================= */
function listColsBySup_(supSel){
  const arr = Array.isArray(ctx?.colaboradores) ? ctx.colaboradores : [];
  const supN = normKey(supSel||"");

  return arr.filter(c=>{
    const s = String(c?.supervisao||"").trim();
    if(isSemSup_(supSel)) return isSemSup_(s);

    // aceita se a c√©lula tiver m√∫ltiplas sups "A;B"
    const parts = String(s||"").split(/[;,]/g).map(x=>String(x||"").trim()).filter(Boolean);
    if(!parts.length) return false;

    return parts.some(p => normKey(p) === supN);
  });
}

function renderUniformes(){
  const supSel = document.getElementById("supUniformes").value || "SEM SUPERVIS√ÉO";
  const list = listColsBySup_(supSel);

  const el = document.getElementById("listaUniformes");
  const hint = document.getElementById("uniHint");
  hint.textContent = `Supervis√£o selecionada: ${supSel} | Total no backend: ${(ctx.colaboradores||[]).length} | Nesta supervis√£o: ${list.length}`;

  if(!list.length){
    el.innerHTML = `<div class="muted">Nenhum colaborador encontrado para esta supervis√£o.</div>`;
    return;
  }

  list.sort((a,b)=> normKey(a.colaborador).localeCompare(normKey(b.colaborador)));

  const tamanhos = (ctx.tamanhos||[]).length ? ctx.tamanhos : ["PP","P","M","G","GG","XG","G1","G2","G3"];

  el.innerHTML = list.map(c=>{
    const nome = String(c.colaborador||"").trim();
    const k = colKey_(nome);

    if(!formUniformes[k]){
      formUniformes[k] = { nome, on:true, tamanho:"M", qtd:1, cor:"VERDE" };
    }
    const st = formUniformes[k];

    return `
      <div class="uniRow">
        <input type="checkbox" ${st.on ? "checked":""}
          onchange="formUniformes['${esc(k)}'].on = this.checked">

        <div>
          <div class="nm">${esc(nome)}</div>
          <div class="sub">${esc(String(c.supervisao||""))}</div>
        </div>

        <select onchange="formUniformes['${esc(k)}'].tamanho = this.value">
          ${tamanhos.map(t=>`<option value="${esc(t)}" ${String(st.tamanho).toUpperCase()===String(t).toUpperCase()?"selected":""}>${esc(t)}</option>`).join("")}
        </select>

        <select onchange="formUniformes['${esc(k)}'].qtd = Number(this.value)||1">
          ${[1,2].map(n=>`<option value="${n}" ${Number(st.qtd)===n?"selected":""}>${n}</option>`).join("")}
        </select>

        <select onchange="formUniformes['${esc(k)}'].cor = this.value">
          ${CORES_UNIFORME.map(cor=>`<option value="${esc(cor)}" ${String(st.cor).toUpperCase()===String(cor).toUpperCase()?"selected":""}>${esc(cor)}</option>`).join("")}
        </select>
      </div>
    `;
  }).join("");
}

function setOutrosUniformes(){
  const t = document.getElementById("outTam").value;
  const qtd = Number(document.getElementById("outQtd").value)||0;
  const cor = document.getElementById("outCor").value || "VERDE";

  if(!t){ showToast("Selecione um tamanho."); return; }

  if(qtd<=0){
    delete formOutrosUni[t];
  }else{
    formOutrosUni[t] = { qtd, cor };
  }
  updateOutrosPreview();
  showToast("OUTROS atualizado.");
}

function updateOutrosPreview(){
  const keys = Object.keys(formOutrosUni||{}).sort((a,b)=>a.localeCompare(b));
  if(!keys.length){
    document.getElementById("outrosPreview").innerHTML = `<span class="muted">Nenhum OUTROS adicionado.</span>`;
    return;
  }
  document.getElementById("outrosPreview").innerHTML =
    `<b>OUTROS:</b> ` + keys.map(k=>{
      const o = formOutrosUni[k];
      return `${esc(k)} = ${esc(o.qtd)} (${esc(o.cor||"VERDE")})`;
    }).join(" | ");
}

/** ‚úÖ SALVAR UNIFORMES -> action = salvarTamanhos */
async function salvarUniformes(){
  const sup = document.getElementById("supUniformes").value || "SEM SUPERVIS√ÉO";
  const pedidoId = document.getElementById("pedidoIdUniformes").value.trim();
  const modoSel = document.getElementById("modoUniformes").value;

  const list = listColsBySup_(sup).sort((a,b)=> normKey(a.colaborador).localeCompare(normKey(b.colaborador)));

  const itens = [];
  list.forEach(c=>{
    const nome = String(c.colaborador||"").trim();
    const k = colKey_(nome);
    const st = formUniformes[k];
    if(!st || !st.on) return;

    itens.push({
      colaborador: nome,
      supervisao: sup,
      coordenacao: String(c.coordenacao||"").trim(),
      tamanho: String(st.tamanho||"M").toUpperCase(),
      qtd: Number(st.qtd||1)||1,
      cor: String(st.cor||"VERDE").toUpperCase()
    });
  });

  const payload = {
    dataRef: ctx.dataRef,
    modo: modoSel,
    supervisao: sup,
    pedidoId: (modoSel==="ATUALIZAR" ? pedidoId : ""),
    itens,
    outros: formOutrosUni
  };

  document.getElementById("saveStatusUniformes").textContent = "Salvando‚Ä¶";
  setBusy(true); setBtnDisabled(true);

  const res = await api("salvarTamanhos", { payload });

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    const msg = res.error || "Erro ao salvar.";
    document.getElementById("saveStatusUniformes").innerHTML = `<span class="err">${esc(msg)}</span>`;
    showToast(msg);
    console.log("salvarTamanhos ->", res);
    return;
  }

  if(res.pedidoId) document.getElementById("pedidoIdUniformes").value = res.pedidoId;
  document.getElementById("saveStatusUniformes").innerHTML = `<span class="ok">${esc(res.message||"Salvo!")}</span>`;
  showToast("Salvo e PDF gerado!");
  await refreshUltimoPDF("uniformes");
}

/** =============================
 * MATERIAIS
 * ============================= */
function addMaterial(){
  const nome = document.getElementById("matNome").value.trim();
  const un = Number(document.getElementById("matUn").value)||0;
  if(!nome || un<=0){
    showToast("Preencha material e un > 0.");
    return;
  }
  materiais.push({ material:nome, un });
  document.getElementById("matNome").value = "";
  document.getElementById("matUn").value = "";
  renderMateriais();
}
function clearMateriais(){
  materiais = [];
  renderMateriais();
}
function renderMateriais(){
  const el = document.getElementById("listaMateriais");
  if(!materiais.length){
    el.innerHTML = `<div class="muted">Nenhum material adicionado.</div>`;
    return;
  }
  el.innerHTML = materiais.map((m,i)=>`
    <div class="card" style="margin:10px 0;">
      <div style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
        <div><b>${esc(m.material)}</b><div class="muted">Un: ${esc(m.un)}</div></div>
        <button class="btnGhost" onclick="materiais.splice(${i},1);renderMateriais();">Remover</button>
      </div>
    </div>
  `).join("");
}

/** ‚úÖ SALVAR MATERIAIS -> action = salvarMateriais */
async function salvarMateriaisUI(){
  const sup = document.getElementById("supMateriais").value || "SEM SUPERVIS√ÉO";
  const pedidoId = document.getElementById("pedidoIdMateriais").value.trim();
  const modoSel = document.getElementById("modoMateriais").value;

  const payload = {
    dataRef: ctx.dataRef,
    modo: modoSel,
    supervisao: sup,
    pedidoId: (modoSel==="ATUALIZAR" ? pedidoId : ""),
    itens: materiais.slice()
  };

  document.getElementById("saveStatusMateriais").textContent = "Salvando‚Ä¶";
  setBusy(true); setBtnDisabled(true);

  const res = await api("salvarMateriais", { payload });

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    const msg = res.error || "Erro ao salvar.";
    document.getElementById("saveStatusMateriais").innerHTML = `<span class="err">${esc(msg)}</span>`;
    showToast(msg);
    console.log("salvarMateriais ->", res);
    return;
  }

  if(res.pedidoId) document.getElementById("pedidoIdMateriais").value = res.pedidoId;
  document.getElementById("saveStatusMateriais").innerHTML = `<span class="ok">${esc(res.message||"Salvo!")}</span>`;
  showToast("Salvo e PDF gerado!");
  await refreshUltimoPDF("materiais");
}

/** =============================
 * EPIs
 * ============================= */
function renderEPIsFixos(){
  const el = document.getElementById("listaEPIsFixos");
  el.innerHTML = EPIS_FIXOS.filter(x=>normKey(x)!==normKey("Botina")).map(nome=>{
    const v = Number(episFixos[nome]||0);
    return `
      <div class="grid2" style="margin-top:8px;">
        <div><b>${esc(nome)}</b><div class="muted">Quantidade</div></div>
        <input inputmode="numeric" value="${esc(v)}" onchange="episFixos['${esc(nome)}']=Number(this.value)||0"/>
      </div>
    `;
  }).join("");
}

function addBotina(){
  const tam = document.getElementById("botTam").value.trim();
  const qtd = Number(document.getElementById("botQtd").value)||0;
  if(!tam || qtd<=0){
    showToast("Informe tamanho e qtd > 0.");
    return;
  }
  botinaItens.push({ tam, qtd });
  document.getElementById("botTam").value = "";
  document.getElementById("botQtd").value = "";
  renderBotina();
}
function clearBotina(){ botinaItens = []; renderBotina(); }
function renderBotina(){
  const el = document.getElementById("listaBotina");
  if(!botinaItens.length){
    el.innerHTML = `<div class="muted">Nenhuma botina adicionada.</div>`;
    return;
  }
  el.innerHTML = botinaItens.map((b,i)=>`
    <div class="card" style="margin:10px 0;">
      <div style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
        <div><b>Tam ${esc(b.tam)}</b><div class="muted">Qtd: ${esc(b.qtd)}</div></div>
        <button class="btnGhost" onclick="botinaItens.splice(${i},1);renderBotina();">Remover</button>
      </div>
    </div>
  `).join("");
}

function addEpiOutro(){
  const nome = document.getElementById("epiOutroNome").value.trim();
  const un = Number(document.getElementById("epiOutroQtd").value)||0;
  if(!nome || un<=0){
    showToast("Informe nome e qtd > 0.");
    return;
  }
  if(epiOutros.length >= 4){
    showToast("M√°ximo 4 itens em OUTROS.");
    return;
  }
  epiOutros.push({ nome, un });
  document.getElementById("epiOutroNome").value = "";
  document.getElementById("epiOutroQtd").value = "";
  renderEpiOutros();
}
function clearEpiOutros(){ epiOutros = []; renderEpiOutros(); }
function renderEpiOutros(){
  const el = document.getElementById("listaEpiOutros");
  if(!epiOutros.length){
    el.innerHTML = `<div class="muted">Nenhum outro item.</div>`;
    return;
  }
  el.innerHTML = epiOutros.map((o,i)=>`
    <div class="card" style="margin:10px 0;">
      <div style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
        <div><b>${esc(o.nome)}</b><div class="muted">Qtd: ${esc(o.un)}</div></div>
        <button class="btnGhost" onclick="epiOutros.splice(${i},1);renderEpiOutros();">Remover</button>
      </div>
    </div>
  `).join("");
}

function renderEPIs(){
  renderEPIsFixos();
  renderBotina();
  renderEpiOutros();
}

/** ‚úÖ SALVAR EPIs -> action = salvarEPIs */
async function salvarEPIsUI(){
  const sup = document.getElementById("supEPIs").value || "SEM SUPERVIS√ÉO";
  const pedidoId = document.getElementById("pedidoIdEPIs").value.trim();
  const modoSel = document.getElementById("modoEPIs").value;

  const itens = [];

  // fixos (menos botina)
  Object.keys(episFixos||{}).forEach(k=>{
    if(normKey(k) === normKey("Botina")) return;
    const un = Number(episFixos[k]||0);
    if(un>0) itens.push({ epi:k, un });
  });

  // botinas
  botinaItens.forEach(b=>{
    const tam = String(b.tam||"").trim();
    const un = Number(b.qtd||0);
    if(tam && un>0) itens.push({ epi:"Botina", tamanho:tam, un });
  });

  const payload = {
    dataRef: ctx.dataRef,
    modo: modoSel,
    supervisao: sup,
    pedidoId: (modoSel==="ATUALIZAR" ? pedidoId : ""),
    itens,
    outros: epiOutros.slice()
  };

  document.getElementById("saveStatusEPIs").textContent = "Salvando‚Ä¶";
  setBusy(true); setBtnDisabled(true);

  const res = await api("salvarEPIs", { payload });

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    const msg = res.error || "Erro ao salvar.";
    document.getElementById("saveStatusEPIs").innerHTML = `<span class="err">${esc(msg)}</span>`;
    showToast(msg);
    console.log("salvarEPIs ->", res);
    return;
  }

  if(res.pedidoId) document.getElementById("pedidoIdEPIs").value = res.pedidoId;
  document.getElementById("saveStatusEPIs").innerHTML = `<span class="ok">${esc(res.message||"Salvo!")}</span>`;
  showToast("Salvo e PDF gerado!");
  await refreshUltimoPDF("epis");
}

/** =============================
 * √öLTIMO PEDIDO / √öLTIMO PDF
 * ============================= */
function getSupByTipo(tipo){
  if(tipo==="uniformes") return document.getElementById("supUniformes").value || "SEM SUPERVIS√ÉO";
  if(tipo==="materiais") return document.getElementById("supMateriais").value || "SEM SUPERVIS√ÉO";
  if(tipo==="epis") return document.getElementById("supEPIs").value || "SEM SUPERVIS√ÉO";
  return "SEM SUPERVIS√ÉO";
}

async function refreshUltimoPDF(tipo){
  const sup = getSupByTipo(tipo);
  const res = await api("carregarUltimoPDF", { payload:{ tipo, supervisao:sup } });
  if(!res.ok) return;

  const pdfUrl = res.pdfUrl || "";
  const elId = (tipo==="uniformes") ? "infoUltimoUniformes" : (tipo==="materiais") ? "infoUltimoMateriais" : "infoUltimoEPIs";
  const el = document.getElementById(elId);

  if(!pdfUrl){
    el.innerHTML = `<span class="muted">Nenhum PDF encontrado para esta supervis√£o.</span>`;
    return;
  }
  el.innerHTML = `√öltimo PDF: <a href="${esc(pdfUrl)}" target="_blank" rel="noopener">Abrir</a>`;
}

async function carregarUltimoPedido(tipo){
  const sup = getSupByTipo(tipo);

  setBusy(true); setBtnDisabled(true);
  const res = await api("carregarUltimoPedido", { payload:{ tipo, supervisao:sup } });
  setBusy(false); setBtnDisabled(false);

  const elId = (tipo==="uniformes") ? "infoUltimoUniformes" : (tipo==="materiais") ? "infoUltimoMateriais" : "infoUltimoEPIs";
  const el = document.getElementById(elId);

  if(!res.ok){
    el.innerHTML = `<span class="err">${esc(res.error||"Erro")}</span>`;
    showToast(res.error || "Erro ao carregar √∫ltimo pedido.");
    return;
  }

  if(!res.last){
    el.innerHTML = `<span class="muted">Nenhum pedido anterior encontrado.</span>`;
    showToast("Nenhum pedido anterior.");
    return;
  }

  const pedidoId = res.last.pedidoId || "";

  // preenche pedidoId e modo
  if(tipo==="uniformes"){
    document.getElementById("modoUniformes").value = "ATUALIZAR";
    modo.uniformes = "ATUALIZAR";
    document.getElementById("pedidoIdUniformes").value = pedidoId;

    // aplicar itens
    const data = res.last.data || {};
    const itens = Array.isArray(data.itens) ? data.itens : [];
    const outros = data.outros || {};

    // reset marca√ß√µes (mant√©m default mas desliga)
    Object.keys(formUniformes).forEach(k=> formUniformes[k].on = false);

    itens.forEach(it=>{
      const nome = String(it.colaborador||"").trim();
      const k = colKey_(nome);
      if(!formUniformes[k]) formUniformes[k] = { nome, on:true, tamanho:"M", qtd:1, cor:"VERDE" };
      formUniformes[k].on = true;
      formUniformes[k].tamanho = String(it.tamanho||"M").toUpperCase();
      formUniformes[k].qtd = Number(it.qtd||1)||1;
      formUniformes[k].cor = String(it.cor||"VERDE").toUpperCase();
    });

    formOutrosUni = outros || {};
    updateOutrosPreview();
    renderUniformes();
  }

  if(tipo==="materiais"){
    document.getElementById("modoMateriais").value = "ATUALIZAR";
    modo.materiais = "ATUALIZAR";
    document.getElementById("pedidoIdMateriais").value = pedidoId;

    const data = res.last.data || {};
    const itens = Array.isArray(data.itens) ? data.itens : [];
    materiais = itens.map(x=>({ material:String(x.material||"").trim(), un:Number(x.un||0)||0 })).filter(x=>x.material && x.un>0);
    renderMateriais();
  }

  if(tipo==="epis"){
    document.getElementById("modoEPIs").value = "ATUALIZAR";
    modo.epis = "ATUALIZAR";
    document.getElementById("pedidoIdEPIs").value = pedidoId;

    // reset
    Object.keys(episFixos).forEach(k=> episFixos[k]=0);
    botinaItens = [];
    epiOutros = [];

    const data = res.last.data || {};
    const itens = Array.isArray(data.itens) ? data.itens : [];
    const outros = Array.isArray(data.outros) ? data.outros : [];

    itens.forEach(it=>{
      const epi = String(it.epi||"").trim();
      if(!epi) return;
      if(normKey(epi)===normKey("Botina")){
        const tam = String(it.tamanho||"").trim();
        const un = Number(it.un||0)||0;
        if(tam && un>0) botinaItens.push({ tam, qtd:un });
        return;
      }
      const un = Number(it.un||0)||0;
      if(un>0) episFixos[epi] = un;
    });

    outros.forEach(o=>{
      const nome = String(o.nome||"").trim();
      const un = Number(o.un||0)||0;
      if(nome && un>0 && epiOutros.length<4) epiOutros.push({ nome, un });
    });

    renderEPIs();
  }

  el.innerHTML = `<span class="ok">Carregado pedidoId: ${esc(pedidoId)}</span>`;
  showToast("√öltimo pedido carregado!");
}

/** =============================
 * PATRIMONIOS
 * ============================= */
async function carregarPatrimonios(){
  const sup = document.getElementById("supPatrimonios").value || "SEM SUPERVIS√ÉO";

  document.getElementById("patriInfo").textContent = "Consultando‚Ä¶";
  document.getElementById("listaPatrimonios").innerHTML = "";
  setBusy(true); setBtnDisabled(true);

  const res = await api("carregarPatrimonios", { payload:{ supervisao:sup } });

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    document.getElementById("patriInfo").innerHTML = `<span class="err">${esc(res.error||"Erro")}</span>`;
    showToast(res.error || "Erro ao consultar.");
    return;
  }

  const itens = res.itens || [];
  document.getElementById("patriInfo").innerHTML = `<span class="ok">Itens: ${itens.length}</span> <span class="muted">| Filtro: ${esc(res.filtro||"-")}</span>`;

  if(!itens.length){
    document.getElementById("listaPatrimonios").innerHTML = `<div class="muted">Nenhum item encontrado.</div>`;
    return;
  }

  document.getElementById("listaPatrimonios").innerHTML = itens.slice(0,200).map(it=>`
    <div class="card" style="margin:10px 0;">
      <div style="font-weight:800;">${esc(it.patrimonio||"-")} ‚Äî ${esc(it.identificacao||"")}</div>
      <div class="muted">
        ${esc(it.funcionario||"")} ‚Ä¢ ${esc(it.supervisao||"")} ‚Ä¢ ${esc(it.coordenacao||"")}<br>
        √öltima leitura: ${esc(it.ultimaLeitura||"-")} ‚Ä¢ Dias sem leitura: <b>${esc(it.diasSemLeitura||"-")}</b>
      </div>
    </div>
  `).join("");
}

/** =============================
 * FOOTER ACTION
 * ============================= */
function salvarAtual(){
  if(tab==="uniformes") return salvarUniformes();
  if(tab==="materiais") return salvarMateriaisUI();
  if(tab==="epis") return salvarEPIsUI();
  if(tab==="patrimonios") return showToast("Patrim√¥nios √© somente consulta.");
}

async function reloadAll(){
  if(!token){ location.reload(); return; }
  await bootstrap();
}

function logout(){
  token = "";
  location.reload();
}
</script>
</body>
</html>
