/****************************************************
 * WEB APP – UNIFORMES + MATERIAIS
 * PIN -> lista mais recente -> salva -> PDF b64
 ****************************************************/

/************ IDS / ABAS ************/
const DESPESAS_SPREADSHEET_ID = "1lamDPJfXtaOaRYQZts9XpPQbbTIsVgFu0aGjDhhpPVU";
const ABA_GESTORES = "Gestores";

// histórico diário (cada aba = dd/MM/yyyy)
const COLAB_ATIVOS_SPREADSHEET_ID = "1zSRANpSVVi861X5siY2Ivg6v45SCXxi8Nxtwlzm68v8";

// destino (mesma para uniformes e materiais)
const DEST_SPREADSHEET_ID = "17RU_ocNZX9dSKj6CTRZiHcqW78Tkec2ZyGGJwy7eXYU";
const DEST_ABA_COLAB = "Colaboradores";
const DEST_ABA_SUP   = "Supervisão";
const DEST_ABA_MAT   = "Materiais";

const TAMANHOS = ["PP","P","M","G","GG","XG","G1","G2","G3"];

/************ WEB APP ************/
function doGet() {
  return ContentService
    .createTextOutput(JSON.stringify({ ok:true, service:"uniformes-e-materiais-webapp" }))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e){
  try{
    const raw = e?.postData?.contents || "";
    const body = raw ? JSON.parse(raw) : {};
    const action = String(body.action || "").trim();
    if(!action) return json_({ ok:false, error:"Ação inválida: ''" });

    if(action === "loginPIN") return json_(loginPIN(body.pin));
    if(action === "ping") return json_(ping(body.token));

    if(action === "carregarListaRecente") return json_(carregarListaRecente(body.token));

    if(action === "salvarTamanhos") return json_(salvarTamanhos(body.token, body.payload));
    if(action === "gerarPDFTamanhos") return json_(gerarPDFTamanhos(body.token, body.dataRef));

    if(action === "salvarMateriais") return json_(salvarMateriais(body.token, body.payload));

    return json_({ ok:false, error:`Ação inválida: '${action}'` });
  }catch(err){
    return json_({ ok:false, error:String(err?.message || err) });
  }
}

function json_(obj){
  return ContentService
    .createTextOutput(JSON.stringify(obj || {}))
    .setMimeType(ContentService.MimeType.JSON);
}

/************ HELPERS ************/
function responder_(ok, extra){ return Object.assign({ ok:!!ok }, extra||{}); }

function norm_(s) {
  return String(s || "")
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .trim()
    .toUpperCase();
}

function limparDigitos_(s){ return String(s||"").replace(/\D/g,""); }

function formatDateDMY_(d) {
  const tz = Session.getScriptTimeZone();
  return Utilities.formatDate(d, tz, "dd/MM/yyyy");
}

function parseDateDMY_(s) {
  const m = String(s || "").trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if (!m) return null;
  const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
  const d = new Date(yy, mm - 1, dd);
  if (d.getFullYear() !== yy || d.getMonth() !== (mm - 1) || d.getDate() !== dd) return null;
  return d;
}

function cellToDMY_(v) {
  if (v instanceof Date) return formatDateDMY_(v);
  if (typeof v === "number") {
    const d = new Date(Math.round((v - 25569) * 86400 * 1000));
    return formatDateDMY_(d);
  }
  const s = String(v || "").trim();
  const d = parseDateDMY_(s);
  return d ? formatDateDMY_(d) : s;
}

function mapHeaders_(headerRow) {
  const map = {};
  headerRow.forEach((h, i) => {
    const k = String(h || "").trim();
    if (k) map[k] = i + 1;
  });
  return map;
}

/************ SESSÃO / TOKEN ************/
function makeToken_(){ return Utilities.getUuid().replace(/-/g,""); }
function cache_(){ return CacheService.getScriptCache(); }

function setSession_(token, obj){ cache_().put(`TAM_SESS_${token}`, JSON.stringify(obj), 6*60*60); }
function getSession_(token){
  const raw = cache_().get(`TAM_SESS_${token}`);
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch(_){ return null; }
}
function requireSession_(token){
  const s = getSession_(token);
  if(!s) throw new Error("Sessão expirada. Faça login novamente.");
  return s;
}

function ping(token){
  try{ requireSession_(token); return { ok:true }; }
  catch(e){ return { ok:false, error:String(e.message||e) }; }
}

/************ GESTORES ************/
function getGestoresSheet_(){
  const ss = SpreadsheetApp.openById(DESPESAS_SPREADSHEET_ID);
  const sh = ss.getSheetByName(ABA_GESTORES);
  if(!sh) throw new Error(`Aba "${ABA_GESTORES}" não encontrada.`);
  return sh;
}

function loginPIN(pinRaw){
  try{
    const pin = limparDigitos_(pinRaw).slice(0,4);
    if(!pin || pin.length < 4) return responder_(false, { error:"Informe o PIN (4 dígitos)." });

    const sh = getGestoresSheet_();
    const values = sh.getDataRange().getValues();
    if(values.length < 2) return responder_(false, { error:"Aba Gestores está vazia." });

    const headers = values[0].map(v => String(v||"").trim());
    const hm = mapHeaders_(headers);

    if(!hm["PIN"]) return responder_(false, { error:"Coluna PIN não encontrada na aba Gestores." });
    if(!hm["Coordenação"]) return responder_(false, { error:"Coluna Coordenação não encontrada na aba Gestores." });

    const cPIN  = hm["PIN"] - 1;
    const cNome = hm["Nome"] ? (hm["Nome"] - 1) : null;
    const cCoord= hm["Coordenação"] - 1;
    const cSup  = hm["Supervisão"] ? (hm["Supervisão"] - 1) : null;
    const cSit  = hm["Situação"] ? (hm["Situação"] - 1) : null;

    let found = null;
    for(let i=1;i<values.length;i++){
      const r = values[i];
      const p = limparDigitos_(r[cPIN]);
      if(p === pin){
        const sit = cSit!=null ? String(r[cSit]||"").trim() : "";
        if(sit && norm_(sit) !== "ATIVO") return responder_(false, { error:"Gestor não está ativo na aba Gestores." });

        found = {
          nome: cNome!=null ? String(r[cNome]||"").trim() : "GESTOR",
          coordenacao: String(r[cCoord]||"").trim(),
          supervisao: cSup!=null ? String(r[cSup]||"").trim() : ""
        };
        break;
      }
    }

    if(!found) return responder_(false, { error:"PIN não encontrado na aba Gestores." });
    if(!found.coordenacao) return responder_(false, { error:"Gestor sem Coordenação preenchida." });

    const token = makeToken_();
    setSession_(token, { type:"GESTOR", nome: found.nome, coordenacao: found.coordenacao, supervisao: found.supervisao||"" });
    return responder_(true, { token });

  }catch(e){
    return responder_(false, { error:String(e.message||e) });
  }
}

/************ HISTÓRICO – pegar data mais recente ************/
function getUltimaAbaData_(ss){
  const sheets = ss.getSheets().map(s => s.getName());
  let best = null; // {name, date}
  sheets.forEach(name=>{
    const d = parseDateDMY_(name);
    if(!d) return;
    if(!best || d.getTime() > best.date.getTime()){
      best = { name, date: d };
    }
  });
  return best; // pode ser null
}

function carregarAtivosPorData_(dataRef){
  const ss = SpreadsheetApp.openById(COLAB_ATIVOS_SPREADSHEET_ID);
  const sh = ss.getSheetByName(dataRef);
  if(!sh) throw new Error(`Aba "${dataRef}" não encontrada no histórico.`);

  const values = sh.getDataRange().getValues();
  if(values.length < 2) return [];

  const headers = values[0].map(h => String(h||"").trim());
  const hm = mapHeaders_(headers);

  const colNome = (hm["Nome"] || hm["NOME"] || hm["Funcionário"] || hm["FUNCIONÁRIO"] || hm["Funcionario"] || hm["FUNCIONARIO"] || hm["Colaborador"] || hm["COLABORADOR"]);
  const colCoord = (hm["Coordenação"] || hm["COORDENAÇÃO"] || hm["Coordenacao"] || hm["COORDENACAO"]);
  const colSup = (hm["Supervisão"] || hm["SUPERVISÃO"] || hm["Supervisao"] || hm["SUPERVISAO"]);
  const colSit = (hm["Situação"] || hm["SITUAÇÃO"] || hm["Situacao"] || hm["SITUACAO"]);

  if(!colNome) throw new Error("Não achei a coluna Nome/Colaborador no histórico.");
  if(!colCoord) throw new Error("Não achei a coluna Coordenação no histórico.");

  const out = [];
  for(let i=1;i<values.length;i++){
    const r = values[i];
    const nome = String(r[colNome-1]||"").trim();
    if(!nome) continue;

    if(colSit){
      const st = String(r[colSit-1]||"").trim();
      if(st && norm_(st) !== "ATIVO") continue;
    }

    out.push({
      colaborador: nome,
      coordenacao: String(r[colCoord-1]||"").trim(),
      supervisao: colSup ? String(r[colSup-1]||"").trim() : ""
    });
  }
  return out;
}

/************ API – carregar lista da data mais recente ************/
function carregarListaRecente(token){
  try{
    const sess = requireSession_(token);

    const ssHist = SpreadsheetApp.openById(COLAB_ATIVOS_SPREADSHEET_ID);
    const ultima = getUltimaAbaData_(ssHist);
    if(!ultima) throw new Error("Não encontrei nenhuma aba dd/MM/yyyy no histórico.");

    const dataRef = ultima.name;
    const all = carregarAtivosPorData_(dataRef);

    const coordAlvo = String(sess.coordenacao||"").trim();
    const supAlvo   = String(sess.supervisao||"").trim();

    const filtrados = all.filter(x=>{
      if(norm_(x.coordenacao) !== norm_(coordAlvo)) return false;
      if(supAlvo && norm_(String(x.supervisao||"")) !== norm_(supAlvo)) return false;
      return true;
    });

    filtrados.sort((a,b)=> norm_(a.colaborador).localeCompare(norm_(b.colaborador)));

    return responder_(true, {
      dataRef,
      gestor: { nome: sess.nome, coordenacao: sess.coordenacao, supervisao: sess.supervisao||"" },
      colaboradores: filtrados,
      tamanhos: TAMANHOS
    });

  }catch(e){
    return responder_(false, { error:String(e.message||e) });
  }
}

/************ DESTINO – garantir abas/cabeçalhos ************/
function ensureSheet_(ss, name, headers){
  let sh = ss.getSheetByName(name);
  if(!sh) sh = ss.insertSheet(name);

  const need = headers.length;
  const lastCol = Math.max(sh.getLastColumn(), need);
  const cur = sh.getRange(1,1,1,lastCol).getValues()[0].map(v=>String(v||"").trim());

  const ok = cur.slice(0,need).join("|") === headers.join("|");
  if(!ok){
    sh.getRange(1,1,1,need).setValues([headers]);
    sh.setFrozenRows(1);
  }
  return sh;
}

function deleteRowsByFilter_(sh, predicateFn){
  const lastRow = sh.getLastRow();
  const lastCol = sh.getLastColumn();
  if(lastRow < 2) return 0;

  const values = sh.getRange(2,1,lastRow-1,lastCol).getValues();
  const toDelete = [];
  for(let i=0;i<values.length;i++){
    if(predicateFn(values[i])) toDelete.push(i+2);
  }
  toDelete.sort((a,b)=>b-a).forEach(r=>sh.deleteRow(r));
  return toDelete.length;
}

/************ UNIFORMES – SALVAR ************/
function salvarTamanhos(token, payload){
  try{
    const sess = requireSession_(token);

    const dataRef = String(payload?.dataRef || "").trim();
    if(!parseDateDMY_(dataRef)) throw new Error("dataRef inválida (dd/MM/aaaa).");

    const itens = Array.isArray(payload?.itens) ? payload.itens : [];
    if(!itens.length) throw new Error("Nenhum item para salvar.");

    // OUTROS: { "P": 2, "M": 1, ... }
    const outros = payload?.outros || {};

    // valida tamanhos (itens)
    itens.forEach(it=>{
      const t = String(it?.tamanho||"").trim().toUpperCase();
      if(!TAMANHOS.includes(t)) throw new Error(`Tamanho inválido: ${t}`);
    });

    // valida tamanhos (outros)
    Object.keys(outros || {}).forEach(t=>{
      const T = String(t||"").trim().toUpperCase();
      if(!TAMANHOS.includes(T)) throw new Error(`Tamanho inválido em OUTROS: ${T}`);
      const qtd = Number(outros[t] || 0) || 0;
      if(qtd < 0) throw new Error(`Quantidade inválida em OUTROS (${T}).`);
    });

    const coord = String(sess.coordenacao||"").trim();
    const supSess = String(sess.supervisao||"").trim();

    const ss = SpreadsheetApp.openById(DEST_SPREADSHEET_ID);
    const shColab = ensureSheet_(ss, DEST_ABA_COLAB, ["Data","Coordenação","Supervisão","Colaborador","Tamanho"]);
    const shSup   = ensureSheet_(ss, DEST_ABA_SUP,   ["Data","Coordenação","Supervisão","Quantidade","Tamanho"]);

    // remove lançamentos anteriores desse gestor/data (para permitir reenvio)
    deleteRowsByFilter_(shColab, (r)=>{
      const d = String(cellToDMY_(r[0])||"").trim();
      const c = String(r[1]||"").trim();
      const s = String(r[2]||"").trim();
      if(d !== dataRef) return false;
      if(norm_(c) !== norm_(coord)) return false;
      if(supSess && norm_(s) !== norm_(supSess)) return false;
      return true;
    });

    deleteRowsByFilter_(shSup, (r)=>{
      const d = String(cellToDMY_(r[0])||"").trim();
      const c = String(r[1]||"").trim();
      const s = String(r[2]||"").trim();
      if(d !== dataRef) return false;
      if(norm_(c) !== norm_(coord)) return false;
      if(supSess && norm_(s) !== norm_(supSess)) return false;
      return true;
    });

    // grava Colaboradores
    const rowsColab = itens.map(it=> ([
      dataRef,
      coord,
      String(it.supervisao||"").trim() || supSess || "",
      String(it.colaborador||"").trim(),
      String(it.tamanho||"").trim().toUpperCase()
    ]));

    shColab.getRange(shColab.getLastRow()+1, 1, rowsColab.length, 5).setValues(rowsColab);

    // agrega Supervisão x Tamanho (quantidade = count * 2)
    const agg = new Map(); // key = sup|tam => count

    rowsColab.forEach(r=>{
      const sup = String(r[2]||"").trim() || "SEM SUPERVISÃO";
      const tam = String(r[4]||"").trim().toUpperCase();
      const key = `${norm_(sup)}|${tam}`;
      agg.set(key, (agg.get(key)||0) + 1);
    });

    // ✅ soma OUTROS no resumo (considera quantidade de pessoas por tamanho)
    Object.keys(outros || {}).forEach(tam=>{
      const qtd = Number(outros[tam] || 0) || 0;
      if(qtd <= 0) return;

      const sup = (supSess || "SEM SUPERVISÃO");
      const key = `${norm_(sup)}|${String(tam).toUpperCase()}`;
      agg.set(key, (agg.get(key)||0) + qtd);
    });

    const rowsSup = [];
    agg.forEach((count, key)=>{
      const parts = key.split("|");
      const supNorm = parts[0];
      const tam = parts[1];

      let supPretty = "";
      for(const r of rowsColab){
        const s = String(r[2]||"").trim() || "SEM SUPERVISÃO";
        if(norm_(s) === supNorm){ supPretty = s; break; }
      }
      if(!supPretty){
        // se veio só de OUTROS
        supPretty = (supSess || "SEM SUPERVISÃO");
      }

      rowsSup.push([ dataRef, coord, supPretty, Number(count)*2, tam ]);
    });

    rowsSup.sort((a,b)=>{
      const s = norm_(a[2]).localeCompare(norm_(b[2]));
      if(s !== 0) return s;
      return String(a[4]).localeCompare(String(b[4]));
    });

    if(rowsSup.length){
      shSup.getRange(shSup.getLastRow()+1, 1, rowsSup.length, 5).setValues(rowsSup);
    }

    const pdf = gerarPDFTamanhos_(sess, dataRef, rowsColab, rowsSup);

    return responder_(true, {
      saved_colaboradores: rowsColab.length,
      saved_supervisao: rowsSup.length,
      message: "Uniformes enviados com sucesso!",
      pdf
    });

  }catch(e){
    return responder_(false, { error:String(e.message||e) });
  }
}

/************ MATERIAIS – SALVAR ************/
function salvarMateriais(token, payload){
  try{
    const sess = requireSession_(token);

    const dataRef = String(payload?.dataRef || "").trim();
    if(!parseDateDMY_(dataRef)) throw new Error("dataRef inválida (dd/MM/aaaa).");

    const itens = Array.isArray(payload?.itens) ? payload.itens : [];
    if(!itens.length) throw new Error("Nenhum material informado.");

    const gestorNome = String(sess?.nome || "GESTOR").trim();
    const coord = String(sess?.coordenacao || "").trim();
    const supSess = String(sess?.supervisao || "").trim();

    if(!coord) throw new Error("Gestor sem Coordenação.");

    // valida
    const normItems = [];
    itens.forEach(it=>{
      const mat = String(it?.material||"").trim();
      const un = Number(it?.un || 0) || 0;
      if(!mat) return;
      if(un <= 0) return;
      normItems.push({ material: mat, un: Math.floor(un) });
    });

    if(!normItems.length) throw new Error("Nenhum material com quantidade > 0.");

    const ss = SpreadsheetApp.openById(DEST_SPREADSHEET_ID);
    const sh = ensureSheet_(ss, DEST_ABA_MAT, ["Data","Coordenação","Supervisão","Un","Material","Solicitado por"]);

    // remove lançamentos anteriores desse gestor/data (para permitir reenvio)
    deleteRowsByFilter_(sh, (r)=>{
      const d = String(cellToDMY_(r[0])||"").trim();
      const c = String(r[1]||"").trim();
      const s = String(r[2]||"").trim();
      const sol = String(r[5]||"").trim();

      if(d !== dataRef) return false;
      if(norm_(c) !== norm_(coord)) return false;
      if(supSess && norm_(s) !== norm_(supSess)) return false;
      if(norm_(sol) !== norm_(gestorNome)) return false;
      return true;
    });

    const rows = normItems.map(it=> ([
      dataRef,
      coord,
      supSess || "",
      it.un,
      it.material,
      gestorNome
    ]));

    sh.getRange(sh.getLastRow()+1, 1, rows.length, 6).setValues(rows);

    return responder_(true, {
      saved: rows.length,
      message: "Materiais enviados com sucesso!"
    });

  }catch(e){
    return responder_(false, { error:String(e.message||e) });
  }
}

/************ PDF (HTML -> Blob -> base64) ************/
function esc_(s){
  return String(s||"")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}

function gerarPDFTamanhos(token, dataRefRaw){
  try{
    const sess = requireSession_(token);
    const dataRef = String(dataRefRaw||"").trim();
    if(!parseDateDMY_(dataRef)) throw new Error("dataRef inválida (dd/MM/aaaa).");

    const ss = SpreadsheetApp.openById(DEST_SPREADSHEET_ID);
    const shColab = ss.getSheetByName(DEST_ABA_COLAB);
    const shSup   = ss.getSheetByName(DEST_ABA_SUP);
    if(!shColab || !shSup) throw new Error("Abas de destino não encontradas.");

    const coord = String(sess.coordenacao||"").trim();
    const supSess = String(sess.supervisao||"").trim();

    const col = shColab.getDataRange().getValues();
    const sup = shSup.getDataRange().getValues();

    const rowsColab = col.slice(1).filter(r=>{
      const d = String(cellToDMY_(r[0])||"").trim();
      const c = String(r[1]||"").trim();
      const s = String(r[2]||"").trim();
      if(d !== dataRef) return false;
      if(norm_(c) !== norm_(coord)) return false;
      if(supSess && norm_(s) !== norm_(supSess)) return false;
      return true;
    }).map(r=> [dataRef, coord, String(r[2]||""), String(r[3]||""), String(r[4]||"")] );

    const rowsSup = sup.slice(1).filter(r=>{
      const d = String(cellToDMY_(r[0])||"").trim();
      const c = String(r[1]||"").trim();
      const s = String(r[2]||"").trim();
      if(d !== dataRef) return false;
      if(norm_(c) !== norm_(coord)) return false;
      if(supSess && norm_(s) !== norm_(supSess)) return false;
      return true;
    }).map(r=> [dataRef, coord, String(r[2]||""), Number(r[3]||0)||0, String(r[4]||"")] );

    const pdf = gerarPDFTamanhos_(sess, dataRef, rowsColab, rowsSup);
    return responder_(true, { pdf });

  }catch(e){
    return responder_(false, { error:String(e.message||e) });
  }
}

function gerarPDFTamanhos_(sess, dataRef, rowsColab, rowsSup){
  const gestor = String(sess?.nome||"GESTOR").trim();
  const coord  = String(sess?.coordenacao||"").trim();
  const supSess= String(sess?.supervisao||"").trim() || "SEM SUPERVISÃO";

  const bodyColab = (rowsColab||[]).map((r,i)=>`
    <tr class="${i%2? "alt":""}">
      <td>${esc_(r[0])}</td>
      <td>${esc_(r[1])}</td>
      <td>${esc_(r[2]||"")}</td>
      <td>${esc_(r[3]||"")}</td>
      <td style="text-align:center;font-weight:700;">${esc_(r[4]||"")}</td>
    </tr>
  `).join("");

  const bodySup = (rowsSup||[]).map((r,i)=>`
    <tr class="${i%2? "alt":""}">
      <td>${esc_(r[0])}</td>
      <td>${esc_(r[1])}</td>
      <td>${esc_(r[2]||"")}</td>
      <td style="text-align:right;font-weight:700;">${esc_(r[3])}</td>
      <td style="text-align:center;font-weight:700;">${esc_(r[4]||"")}</td>
    </tr>
  `).join("");

  const html = `
  <!doctype html>
  <html>
    <head>
      <meta charset="utf-8"/>
      <style>
        @page { size: A4 portrait; margin: 12mm; }
        body { font-family: Arial, sans-serif; color:#111; margin:0; }
        .top{ font-size:12px; margin:0 0 10px 0; }
        .top b{ color:#0b3d1a; }
        h2{ margin:10px 0 6px; font-size:13px; }
        table{ width:100%; border-collapse:collapse; table-layout:fixed; }
        th,td{ border:1px solid #000; padding:5px 6px; font-size:10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        thead th{ background:#166534; color:#fff; text-transform:uppercase; }
        tbody tr.alt td{ background:#cfe6c3; }
        .muted{ color:#444; font-size:10px; margin-top:6px; }
      </style>
    </head>
    <body>
      <div class="top">
        <b>Relação de Tamanhos</b><br/>
        Data: <b>${esc_(dataRef)}</b> | Coordenação: <b>${esc_(coord)}</b> | Supervisão: <b>${esc_(supSess)}</b><br/>
        Gestor: <b>${esc_(gestor)}</b>
      </div>

      <h2>1) Colaboradores</h2>
      <table>
        <thead>
          <tr>
            <th style="width:14%;">Data</th>
            <th style="width:26%;">Coordenação</th>
            <th style="width:22%;">Supervisão</th>
            <th style="width:28%;">Colaborador</th>
            <th style="width:10%;">Tamanho</th>
          </tr>
        </thead>
        <tbody>
          ${bodyColab || `<tr><td colspan="5">Nenhum registro.</td></tr>`}
        </tbody>
      </table>

      <h2>2) Resumo por Supervisão (Quantidade = pessoas × 2)</h2>
      <table>
        <thead>
          <tr>
            <th style="width:14%;">Data</th>
            <th style="width:30%;">Coordenação</th>
            <th style="width:30%;">Supervisão</th>
            <th style="width:16%;">Quantidade</th>
            <th style="width:10%;">Tamanho</th>
          </tr>
        </thead>
        <tbody>
          ${bodySup || `<tr><td colspan="5">Nenhum resumo.</td></tr>`}
        </tbody>
      </table>

      <div class="muted">Gerado em: ${esc_(Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss"))}</div>
    </body>
  </html>`;

  const blob = HtmlService.createHtmlOutput(html).getBlob().getAs("application/pdf");
  const fileName = `Tamanhos_${dataRef.replace(/\//g,"-")}_${(coord||"COORD").replace(/[^\w\s-]/g,"").trim()}_${(supSess||"SUP").replace(/[^\w\s-]/g,"").trim()}.pdf`;
  const b64 = Utilities.base64Encode(blob.getBytes());

  return { fileName, b64 };
}
