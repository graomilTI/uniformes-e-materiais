<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gestor ‚Äì Uniformes e Materiais</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    body{ margin:0; font-family:Arial,sans-serif; background:#f5f6f7; }
    .wrap{ max-width:1100px; margin:auto; padding:14px 14px 120px; }
    .card{ background:#fff; border-radius:14px; padding:14px; margin-bottom:12px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    h2,h3{ margin:0 0 8px; }
    .muted{ color:#6b7280; font-size:12px; white-space:pre-line; }
    input,select,button{ width:100%; padding:10px; border-radius:12px; border:1px solid #d1d5db; font-size:14px; box-sizing:border-box; }
    button{ cursor:pointer; border:none; background:#166534; color:#fff; font-weight:800; }
    button.secondary{ background:#374151; }
    button.danger{ background:#111827; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1; min-width:220px; }

    .pill{ display:inline-block; padding:4px 10px; background:#e0f2fe; border-radius:999px; font-size:12px; margin-top:6px; }
    .topbar{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .logoutBtn{ width:auto; padding:9px 14px; border-radius:999px; background:#111827; }

    .list{ margin-top:10px; }

    .supHeader{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      background:#f0fdf4;
      border:1px solid #dcfce7;
      font-weight:900;
      color:#166534;
      font-size:13px;
    }
    .supHeader small{
      display:block;
      margin-top:3px;
      font-weight:700;
      color:#6b7280;
      font-size:11px;
    }

    .bottomBar{ position:fixed; left:0; right:0; bottom:0; background:#f5f6f7; border-top:1px solid #e5e7eb; padding:10px; }
    .bottomBar .inner{ max-width:1100px; margin:auto; display:flex; gap:10px; flex-wrap:wrap; }
    .bottomBar .inner button{ width:auto; min-width:160px; }

    .pdfArea a{ display:inline-block; margin-top:8px; font-weight:900; color:#166534; text-decoration:none; }
    .pdfArea .muted{ margin-top:6px; }

    .menuGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(220px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .menuBtn{
      padding:16px;
      border-radius:14px;
      background:#166534;
      color:#fff;
      font-weight:900;
      text-align:left;
      box-shadow:0 1px 3px rgba(0,0,0,.06);
    }
    .menuBtn .small{ display:block; font-weight:600; opacity:.9; margin-top:6px; font-size:12px; }
    .menuBtn.secondary{ background:#0f172a; }

    /* linhas */
    .qtyRow{
      display:grid;
      grid-template-columns: 1fr 120px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .qtyRow:last-child{ border-bottom:none; }
    .qtyRow .matName{ font-weight:800; font-size:13px; }
    .qtyRow input[type="number"]{ text-align:center; }

    .othersRow{
      display:grid;
      grid-template-columns: 1fr 120px 42px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .othersRow:last-child{ border-bottom:none; }

    .iconBtn{ width:42px; height:42px; border-radius:12px; background:#374151; color:#fff; font-weight:900; }

    /* ‚úÖ UNIFORMES: checkbox + tamanho + qtd + cor */
    .uniRow{
      display:grid;
      grid-template-columns: 28px 1fr 120px 90px 110px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .uniRow:last-child{ border-bottom:none; }
    .uniRow .nm{ font-weight:900; font-size:13px; }
    .uniRow .sub{ font-size:11px; color:#6b7280; margin-top:2px; }
    .uniRow input[type="checkbox"]{ width:18px; height:18px; }

    /* OUTROS UNIFORMES */
    .othersUniRow{
      display:grid;
      grid-template-columns: 1fr 120px 90px 110px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .othersUniRow:last-child{ border-bottom:none; }
    .othersUniRow input[disabled], .othersUniRow select[disabled]{ background:#f3f4f6; color:#111827; opacity:1; cursor:not-allowed; }
    .othersUniRow input[type="number"]{ text-align:center; }

    /* ‚úÖ EPIs - Botina */
    .botinaInlineRow{
      display:grid;
      grid-template-columns: 1fr 120px 52px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .botinaInlineRow:last-child{ border-bottom:none; }
    .botinaInlineRow input[type="number"]{ text-align:center; }
    .botinaPlusBtn{ width:52px; height:42px; border-radius:12px; background:#166534; color:#fff; font-weight:900; }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:86px; transform:translateX(-50%);
      background:#111827; color:#fff;
      padding:10px 14px; border-radius:999px;
      box-shadow:0 8px 24px rgba(0,0,0,.18);
      font-size:13px; font-weight:800;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      max-width: calc(100% - 24px);
      text-align:center;
      z-index:9999;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }

    /* ==========================
       PATRIM√îNIOS (NOVO)
    ========================== */
    .segRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .seg{
      display:flex; gap:6px;
      background:#f3f4f6;
      padding:6px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      width:100%;
      max-width:520px;
    }
    .seg button{
      width:auto; flex:1;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      border:0;
      background:transparent;
      color:#111827;
    }
    .seg button.active{ background:#166534; color:#fff; }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:10px;
      overflow:hidden;
      border-radius:12px;
      border:1px solid #e5e7eb;
    }
    .table thead th{
      background:#166534;
      color:#fff;
      font-size:12px;
      text-align:left;
      padding:10px;
      position:sticky;
      top:0;
      z-index:1;
    }
    .table td{
      background:#fff;
      border-top:1px solid #f3f4f6;
      padding:10px;
      font-size:13px;
      vertical-align:top;
    }
    .table tr:nth-child(even) td{ background:#f9fafb; }

    .chip{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      background:#eef2ff;
      color:#111827;
      border:1px solid #e5e7eb;
      white-space:nowrap;
    }
    .chip.danger{
      background:#fee2e2;
      color:#7f1d1d;
      border-color:#fecaca;
    }

    .patCard{
      border:1px solid #e5e7eb;
      border-radius:14px;
      background:#fff;
      padding:12px;
      margin-top:10px;
      box-shadow:0 1px 3px rgba(0,0,0,.06);
    }
    .patCard h4{ margin:0 0 8px; font-size:13px; color:#111827; }

    .patItem{
      display:grid;
      grid-template-columns: 120px 1fr 140px 120px;
      gap:10px;
      padding:10px 0;
      border-top:1px solid #f3f4f6;
      align-items:start;
    }
    .patItem:first-child{ border-top:none; }
    .patItem .num{ font-weight:900; }
    .patItem .desc{ font-size:13px; }
    .patItem .mut{ color:#6b7280; font-size:12px; }
    .patItem .right{ text-align:right; }

    /* ‚úÖ Accordion (AGRUPADO por colaborador) */
    .patAcc{
      border:1px solid #e5e7eb;
      border-radius:14px;
      background:#fff;
      margin-top:10px;
      box-shadow:0 1px 3px rgba(0,0,0,.06);
      overflow:hidden;
    }
    .patAcc summary{
      list-style:none;
      cursor:pointer;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:900;
    }
    .patAcc summary::-webkit-details-marker{ display:none; }
    .patAcc summary .left{
      display:flex; flex-direction:column; gap:4px;
    }
    .patAcc summary .meta{
      font-weight:700;
      font-size:12px;
      color:#6b7280;
    }
    .patAcc summary .right{
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .patAcc .body{
      padding:0 12px 12px 12px;
    }
    .patAcc .divider{
      height:1px;
      background:#f3f4f6;
      margin:0 0 8px 0;
    }

    @media (max-width: 720px){
      .wrap{ padding:12px 10px 110px; }
      .menuGrid{ grid-template-columns: 1fr; }
      .uniRow{ grid-template-columns: 28px 1fr; }
      .uniRow select, .uniRow input{ grid-column: span 2; }
      .othersUniRow{ grid-template-columns: 1fr; }
      .othersRow{ grid-template-columns: 1fr; }
      .qtyRow{ grid-template-columns: 1fr; }
      .botinaInlineRow{ grid-template-columns: 1fr; }
      .patItem{ grid-template-columns: 1fr; }
      .patItem .right{ text-align:left; }
      .seg{ max-width:none; }
      .patAcc summary .right{ flex-wrap:wrap; justify-content:flex-end; }
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h2>Login do Gestor</h2>
    <div class="muted">Informe seu <b>PIN (4 d√≠gitos)</b> (aba Gestores).</div>

    <div class="row" style="margin-top:10px;">
      <div class="col">
        <input id="pin" placeholder="PIN" inputmode="numeric" maxlength="4" autocomplete="off">
      </div>
      <div class="col">
        <button id="btnLogin" onclick="login()">Entrar</button>
      </div>
    </div>

    <div id="loginStatus" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;">

    <!-- HEADER -->
    <div class="card">
      <div class="topbar">
        <div>
          <h3 style="margin:0;">Portal do Gestor</h3>
          <div id="topInfo" class="muted" style="margin-top:4px;"></div>
          <div id="dataInfo" class="muted"></div>
        </div>
        <button class="logoutBtn" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- MENU -->
    <div id="screenMenu" class="card">
      <h3>Escolha uma op√ß√£o</h3>
      <div class="muted">Selecione o que deseja registrar/consultar.</div>

      <div class="menuGrid">
        <button class="menuBtn" onclick="goUniformes()">
          üëï Uniformes
          <span class="small">Selecione colaboradores, tamanho, qtd (1/2), cor (verde/cinza) e gere PDF.</span>
        </button>

        <button class="menuBtn secondary" onclick="goMateriais()">
          üß∞ Materiais
          <span class="small">Solicite materiais com quantidade e gere PDF.</span>
        </button>

        <button class="menuBtn secondary" onclick="goEPIs()">
          ü¶∫ EPI's
          <span class="small">Solicite EPIs com quantidade, Botina com v√°rios tamanhos e PDF.</span>
        </button>

        <!-- ‚úÖ NOVO -->
        <button class="menuBtn secondary" onclick="goPatrimonios()">
          üè∑Ô∏è Patrim√¥nios
          <span class="small">Consulte n¬∫, descri√ß√£o, √∫ltima leitura e dias sem leitura (alerta &gt; 10).</span>
        </button>
      </div>
    </div>

    <!-- UNIFORMES -->
    <div id="screenUniformes" class="card" style="display:none;">
      <div class="row" style="align-items:center;">
        <div class="col">
          <h3>Uniformes</h3>
          <div class="muted">Escolha a supervis√£o, modo e configure por colaborador.</div>
        </div>
        <div class="col" style="max-width:220px;">
          <button class="secondary" onclick="goMenu()">‚¨ÖÔ∏è Voltar</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <div class="muted"><b>Supervis√£o</b></div>
          <select id="uniSup" onchange="onChangeSup('uniformes')"></select>
        </div>
        <div class="col">
          <div class="muted"><b>Modo</b></div>
          <select id="uniModo" onchange="onChangeModo('uniformes')">
            <option value="NOVA" selected>Nova solicita√ß√£o</option>
            <option value="ATUALIZAR">Atualizar solicita√ß√£o</option>
          </select>
        </div>
      </div>

      <div class="pdfArea" id="pdfAreaUniformesTop"></div>

      <div class="list" id="listaUniformes"></div>

      <h3 style="margin-top:14px;">OUTROS (novas contrata√ß√µes)</h3>
      <div class="muted">OUTROS √© fixo ‚Äî informe tamanho, qtd e cor.</div>
      <div class="list" id="listaOutrosUniformes"></div>

      <div class="pdfArea" id="pdfAreaUniformes"></div>
      <div id="saveStatusUniformes" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- MATERIAIS -->
    <div id="screenMateriais" class="card" style="display:none;">
      <div class="row" style="align-items:center;">
        <div class="col">
          <h3>Materiais</h3>
          <div class="muted">Escolha a supervis√£o, modo e informe quantidades (0 = n√£o solicitar).</div>
        </div>
        <div class="col" style="max-width:220px;">
          <button class="secondary" onclick="goMenu()">‚¨ÖÔ∏è Voltar</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <div class="muted"><b>Supervis√£o</b></div>
          <select id="matSup" onchange="onChangeSup('materiais')"></select>
        </div>
        <div class="col">
          <div class="muted"><b>Modo</b></div>
          <select id="matModo" onchange="onChangeModo('materiais')">
            <option value="NOVA" selected>Nova solicita√ß√£o</option>
            <option value="ATUALIZAR">Atualizar solicita√ß√£o</option>
          </select>
        </div>
      </div>

      <div class="pdfArea" id="pdfAreaMateriaisTop"></div>

      <div id="listaMateriais" class="list"></div>

      <h3 style="margin-top:14px;">Outros (at√© 5)</h3>
      <div class="muted">Preencha o nome do material e a quantidade. Deixe em branco se n√£o usar.</div>
      <div id="listaOutros" class="list"></div>

      <div class="pdfArea" id="pdfAreaMateriais"></div>
      <div id="saveStatusMateriais" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- EPIs -->
    <div id="screenEPIs" class="card" style="display:none;">
      <div class="row" style="align-items:center;">
        <div class="col">
          <h3>EPI's</h3>
          <div class="muted">Escolha a supervis√£o, modo e informe quantidades (0 = n√£o solicitar).</div>
        </div>
        <div class="col" style="max-width:220px;">
          <button class="secondary" onclick="goMenu()">‚¨ÖÔ∏è Voltar</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <div class="muted"><b>Supervis√£o</b></div>
          <select id="epiSup" onchange="onChangeSup('epis')"></select>
        </div>
        <div class="col">
          <div class="muted"><b>Modo</b></div>
          <select id="epiModo" onchange="onChangeModo('epis')">
            <option value="NOVA" selected>Nova solicita√ß√£o</option>
            <option value="ATUALIZAR">Atualizar solicita√ß√£o</option>
          </select>
        </div>
      </div>

      <div class="pdfArea" id="pdfAreaEPIsTop"></div>

      <div id="listaEPIs" class="list"></div>

      <h3 style="margin-top:14px;">Outros (4)</h3>
      <div class="muted">Preencha o nome do EPI e a quantidade. Deixe em branco se n√£o usar.</div>
      <div id="listaOutrosEPIs" class="list"></div>

      <div class="pdfArea" id="pdfAreaEPIs"></div>
      <div id="saveStatusEPIs" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- ‚úÖ PATRIM√îNIOS (NOVA TELA) -->
    <div id="screenPatrimonios" class="card" style="display:none;">
      <div class="row" style="align-items:center;">
        <div class="col">
          <h3>Patrim√¥nios</h3>
          <div class="muted">Consulte por supervis√£o. Dias sem leitura &gt; 10 ficam em vermelho.</div>
        </div>
        <div class="col" style="max-width:220px;">
          <button class="secondary" onclick="goMenu()">‚¨ÖÔ∏è Voltar</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <div class="muted"><b>Supervis√£o</b></div>
          <select id="patSup" onchange="onChangeSup('patrimonios')"></select>
        </div>

        <div class="col">
          <div class="muted"><b>Visualiza√ß√£o</b></div>
          <div class="segRow">
            <div class="seg">
              <button id="btnPatTab" class="active" onclick="setPatView('TABELA')">Tabela √∫nica</button>
              <button id="btnPatGrp" onclick="setPatView('AGRUPADO')">Agrupar por colaborador</button>
            </div>
          </div>
        </div>
      </div>

      <div id="patStatus" class="muted" style="margin-top:10px;"></div>
      <div id="patContent" class="list"></div>
    </div>

  </div>
</div>

<div class="bottomBar" id="bottomBar" style="display:none;">
  <div class="inner" id="bottomActions"></div>
</div>

<div id="toast" class="toast"></div>

<script>
const API_BASE = "https://uniformes-e-materiais.tecnologia-f0c.workers.dev/";

let token = localStorage.getItem("TAM_TOKEN") || "";
let ctx = null;

// estado geral
let selectedSup = {
  uniformes: "",
  materiais: "",
  epis: "",
  patrimonios: "" // ‚úÖ novo
};
let modo = {
  uniformes: "NOVA",
  materiais: "NOVA",
  epis: "NOVA"
};
let lastPedido = {
  uniformes: null, // {pedidoId, pdfUrl, ...}
  materiais: null,
  epis: null
};

// ‚úÖ Patrim√¥nios
let patView = "TABELA"; // TABELA | AGRUPADO
let patCacheBySup = {}; // supNorm -> itens

// uniformes
let formUniformes = {}; // nome -> {on:true, tamanho:"M", qtd:1, cor:"VERDE"}
let formOutrosUni = {}; // tamanho -> {qtd:0, cor:"VERDE"}

// materiais
const MATERIAIS_FIXOS = ["balan√ßa","impressora de laudo","calador","kit peneiras","quarteador","micropipeta","alicate de corte"];
let formMateriais = {};
let formOutros = [
  { nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 }
];

// EPIs
const EPIS_FIXOS = ["Capacete","Protetor auricular","√ìculos Transparente","Luva PU","Mascara PFF2","Botina"];
let formEPIs = {};
let botinaItens = []; // [{tam:"40", qtd:2}, ...]
let botinaTamInput = "";
let botinaQtdInput = 0;
let formOutrosEPIs = [
  { nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 }
];

function onlyDigits(s){ return String(s||"").replace(/\D/g,""); }
function esc(s){ return String(s||"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

function show(id){ document.getElementById(id).style.display="block"; }
function hide(id){ document.getElementById(id).style.display="none"; }

function normKey(s){
  return String(s||"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .trim()
    .toUpperCase();
}
function isSemSup_(s){
  const raw = String(s||"").trim();
  return (!raw || normKey(raw) === normKey("SEM SUPERVIS√ÉO"));
}

let toastTimer = null;
function showToast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg || "Conclu√≠do!";
  el.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> el.classList.remove("show"), 2600);
}

function setBusy(v){
  const b = !!v;
  ["btnLogin"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.disabled = b;
  });
  document.querySelectorAll("#bottomActions button").forEach(x => x.disabled = b);
}

function setBottomActions(html){
  document.getElementById("bottomActions").innerHTML = html || "";
}

async function api(action, args){
  const payload = { action, ...(args||{}) };
  if(token && !payload.token && action !== "loginPIN"){
    payload.token = token;
  }

  let txt = "";
  try{
    const res = await fetch(API_BASE, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    txt = await res.text();
  }catch(e){
    return { ok:false, error:"Falha de rede / CORS", raw:String(e) };
  }

  try{ return JSON.parse(txt); }
  catch(e){ return { ok:false, error:"Resposta inv√°lida do servidor", raw:txt }; }
}

function logout(){
  localStorage.removeItem("TAM_TOKEN");
  token = "";
  ctx = null;

  selectedSup = { uniformes:"", materiais:"", epis:"", patrimonios:"" };
  modo = { uniformes:"NOVA", materiais:"NOVA", epis:"NOVA" };
  lastPedido = { uniformes:null, materiais:null, epis:null };

  // ‚úÖ patrimonios
  patView = "TABELA";
  patCacheBySup = {};

  formUniformes = {};
  formOutrosUni = {};
  formMateriais = {};
  MATERIAIS_FIXOS.forEach(m => formMateriais[m] = 0);
  formOutros = [{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0}];

  formEPIs = {};
  EPIS_FIXOS.forEach(e => formEPIs[e] = 0);
  botinaItens = []; botinaTamInput=""; botinaQtdInput=0;
  formOutrosEPIs = [{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0}];

  document.getElementById("loginStatus").innerText = "Fa√ßa login novamente.";
  hide("app"); hide("bottomBar"); show("loginCard");
}

async function login(){
  const pin = onlyDigits(document.getElementById("pin").value).slice(0,4);
  if(pin.length < 4){
    document.getElementById("loginStatus").innerText = "Informe 4 d√≠gitos.";
    return;
  }

  setBusy(true);
  document.getElementById("loginStatus").innerText = "Entrando...";

  const out = await api("loginPIN", { pin });
  setBusy(false);

  if(!out || !out.ok){
    document.getElementById("loginStatus").innerText = out?.error || "Erro";
    return;
  }

  token = out.token;
  localStorage.setItem("TAM_TOKEN", token);

  hide("loginCard");
  show("app");
  show("bottomBar");
  document.getElementById("loginStatus").innerText = "";

  await bootstrap();
}

function fillSupSelects(){
  const sups = Array.isArray(ctx?.gestor?.supervisoesLiberadas) ? ctx.gestor.supervisoesLiberadas : [];
  const list = sups.length ? sups : ["SEM SUPERVIS√ÉO"];

  // default: primeira
  ["uniSup","matSup","epiSup","patSup"].forEach((id)=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.innerHTML = list.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join("");
  });

  selectedSup.uniformes = list[0] || "SEM SUPERVIS√ÉO";
  selectedSup.materiais = list[0] || "SEM SUPERVIS√ÉO";
  selectedSup.epis = list[0] || "SEM SUPERVIS√ÉO";
  selectedSup.patrimonios = list[0] || "SEM SUPERVIS√ÉO";

  document.getElementById("uniSup").value = selectedSup.uniformes;
  document.getElementById("matSup").value = selectedSup.materiais;
  document.getElementById("epiSup").value = selectedSup.epis;
  document.getElementById("patSup").value = selectedSup.patrimonios;

  // reset view
  setPatViewButtons_();
}

async function bootstrap(){
  setBusy(true);
  const res = await api("carregarListaRecente", {});
  setBusy(false);

  if(!res || !res.ok){
    alert(res?.error || "Erro ao carregar dados do gestor.");
    logout();
    return;
  }

  ctx = res;
  const g = res.gestor || {};

  const supTxt = (Array.isArray(g.supervisoesLiberadas) && g.supervisoesLiberadas.length)
    ? g.supervisoesLiberadas.join("; ")
    : "(todas)";

  document.getElementById("topInfo").innerText =
    `Gestor: ${g.nome||"GESTOR"} | Coordena√ß√£o: ${g.coordenacao||"-"} | Supervis√µes liberadas: ${supTxt}`;

  document.getElementById("dataInfo").innerHTML =
    `<span class="pill">Data mais recente do hist√≥rico: <b>${esc(res.dataRef||"")}</b></span>`;

  fillSupSelects();

  // defaults
  const tamanhos = Array.isArray(res.tamanhos) ? res.tamanhos : ["PP","P","M","G","GG","XG","G1","G2","G3"];
  formUniformes = {};
  const cols = Array.isArray(res.colaboradores) ? res.colaboradores : [];
  cols.forEach(c=>{
    formUniformes[c.colaborador] = { on:true, tamanho:"M", qtd:1, cor:"VERDE" };
  });

  formOutrosUni = {};
  tamanhos.forEach(t => formOutrosUni[String(t).toUpperCase()] = { qtd:0, cor:"VERDE" });

  formMateriais = {}; MATERIAIS_FIXOS.forEach(m => formMateriais[m] = 0);

  formEPIs = {}; EPIS_FIXOS.forEach(e => formEPIs[e] = 0);
  botinaItens=[]; botinaTamInput=""; botinaQtdInput=0;
  formOutrosEPIs = [{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0}];

  // ‚úÖ patrimonios
  patView = "TABELA";
  patCacheBySup = {};
  setPatViewButtons_();

  // limpa √°reas PDF
  ["pdfAreaUniformesTop","pdfAreaMateriaisTop","pdfAreaEPIsTop","pdfAreaUniformes","pdfAreaMateriais","pdfAreaEPIs"]
    .forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML=""; });

  goMenu();
}

function goMenu(){
  show("screenMenu");
  hide("screenUniformes");
  hide("screenMateriais");
  hide("screenEPIs");
  hide("screenPatrimonios");
  setBottomActions(`<button class="secondary" onclick="bootstrap()">Recarregar</button>`);
}

async function goUniformes(){
  hide("screenMenu"); show("screenUniformes"); hide("screenMateriais"); hide("screenEPIs"); hide("screenPatrimonios");
  await refreshUltimoPDF('uniformes');
  renderUniformes();
  setBottomActions(`
    <button class="secondary" onclick="bootstrap()">Recarregar</button>
    <button onclick="salvarUniformes()">Salvar e Gerar PDF</button>
  `);
}

async function goMateriais(){
  hide("screenMenu"); hide("screenUniformes"); show("screenMateriais"); hide("screenEPIs"); hide("screenPatrimonios");
  await refreshUltimoPDF('materiais');
  renderMateriais();
  setBottomActions(`
    <button class="secondary" onclick="bootstrap()">Recarregar</button>
    <button onclick="salvarMateriais()">Salvar e Gerar PDF</button>
  `);
}

async function goEPIs(){
  hide("screenMenu"); hide("screenUniformes"); hide("screenMateriais"); show("screenEPIs"); hide("screenPatrimonios");
  await refreshUltimoPDF('epis');
  renderEPIs();
  setBottomActions(`
    <button class="secondary" onclick="bootstrap()">Recarregar</button>
    <button onclick="salvarEPIs()">Salvar e Gerar PDF</button>
  `);
}

/* ==========================
   PATRIM√îNIOS (NOVO)
========================== */
async function goPatrimonios(){
  hide("screenMenu"); hide("screenUniformes"); hide("screenMateriais"); hide("screenEPIs"); show("screenPatrimonios");
  document.getElementById("patStatus").innerText = "";
  document.getElementById("patContent").innerHTML = "";

  await loadAndRenderPatrimonios();

  setBottomActions(`
    <button class="secondary" onclick="bootstrap()">Recarregar</button>
    <button class="secondary" onclick="refreshPatrimonios()">Atualizar Patrim√¥nios</button>
  `);
}

function setPatViewButtons_(){
  const b1 = document.getElementById("btnPatTab");
  const b2 = document.getElementById("btnPatGrp");
  if(!b1 || !b2) return;
  b1.classList.toggle("active", patView==="TABELA");
  b2.classList.toggle("active", patView==="AGRUPADO");
}

function setPatView(v){
  patView = (v==="AGRUPADO") ? "AGRUPADO" : "TABELA";
  setPatViewButtons_();
  renderPatrimoniosFromCache_();
}

async function refreshPatrimonios(){
  const sup = String(selectedSup.patrimonios||"").trim() || "SEM SUPERVIS√ÉO";
  const key = normKey(sup||"SEM SUPERVIS√ÉO");
  delete patCacheBySup[key];
  await loadAndRenderPatrimonios();
}

async function loadAndRenderPatrimonios(){
  if(!ctx) return;

  const supSel = String(selectedSup.patrimonios||"").trim() || "SEM SUPERVIS√ÉO";
  const key = normKey(supSel||"SEM SUPERVIS√ÉO");

  if(patCacheBySup[key]){
    renderPatrimonios_(patCacheBySup[key], supSel);
    return;
  }

  document.getElementById("patStatus").innerText = "Carregando patrim√¥nios...";
  document.getElementById("patContent").innerHTML = "";

  setBusy(true);

  // ‚úÖ action esperada no backend:
  const res = await api("carregarPatrimonios", { payload: { supervisao: supSel } });

  setBusy(false);

  if(!res || !res.ok){
    document.getElementById("patStatus").innerText = res?.error || "Erro ao carregar patrim√¥nios.";
    return;
  }

  const itens = Array.isArray(res.itens) ? res.itens : [];
  patCacheBySup[key] = itens;

  renderPatrimonios_(itens, supSel);
}

function renderPatrimoniosFromCache_(){
  const supSel = String(selectedSup.patrimonios||"").trim() || "SEM SUPERVIS√ÉO";
  const key = normKey(supSel||"SEM SUPERVIS√ÉO");
  const itens = patCacheBySup[key] || [];
  renderPatrimonios_(itens, supSel);
}

function parseDias_(v){
  const n = parseInt(String(v||"0").replace(/[^\d-]/g,""), 10);
  return isNaN(n) ? 0 : n;
}
function safeStr_(v){
  const s = String(v||"").trim();
  return s || "-";
}

function renderPatrimonios_(itens, supSel){
  const elStatus = document.getElementById("patStatus");
  const el = document.getElementById("patContent");

  const list = (itens||[])
    .map(x=>({
      patrimonio: String(x.patrimonio||x["Patrim√¥nio"]||x["Patrimonio"]||"").trim(),
      funcionario: String(x.funcionario||x["Funcion√°rio"]||x["Funcionario"]||"").trim(),
      identificacao: String(x.identificacao||x["Identifica√ß√£o"]||x["Identificacao"]||"").trim(),
      ultimaLeitura: safeStr_(x.ultimaLeitura||x["Ultima Leitura"]||x["√öltima Leitura"]||x["Ultima leitura"]||x["√öltima leitura"]),
      diasSemLeitura: parseDias_(
        x.diasSemLeitura ||
        x["Dias sem Leitura"] ||
        x["Dias Sem Leitura"] ||
        x["Dias_sem_leitura"] ||
        x["dias_sem_leitura"] ||
        x["diasSemLeitura"]
      )
    }))
    .filter(x=> x.patrimonio || x.identificacao || x.funcionario);

  elStatus.innerText = list.length
    ? `Encontrados ${list.length} patrim√¥nios para: ${supSel}`
    : `Nenhum patrim√¥nio encontrado para: ${supSel}`;

  if(!list.length){
    el.innerHTML = `<div class="muted">Sem registros.</div>`;
    return;
  }

  // ordena por atraso desc, depois nome, depois patrimonio
  list.sort((a,b)=>{
    const d = (b.diasSemLeitura||0) - (a.diasSemLeitura||0);
    if(d!==0) return d;
    const n = normKey(a.funcionario).localeCompare(normKey(b.funcionario));
    if(n!==0) return n;
    return normKey(a.patrimonio).localeCompare(normKey(b.patrimonio));
  });

  if(patView === "TABELA"){
    const rows = list.map(it=>{
      const danger = (it.diasSemLeitura||0) > 10;
      const chip = `<span class="chip ${danger?'danger':''}">${danger ? '‚ö†Ô∏è ' : ''}${esc(it.diasSemLeitura)} dia(s)</span>`;
      return `
        <tr style="${danger ? 'outline:2px solid #fecaca; outline-offset:-2px;' : ''}">
          <td><b>${esc(it.patrimonio||"-")}</b></td>
          <td>${esc(it.identificacao||"-")}</td>
          <td>${esc(it.funcionario||"-")}</td>
          <td>${esc(it.ultimaLeitura||"-")}</td>
          <td>${chip}</td>
        </tr>
      `;
    }).join("");

    el.innerHTML = `
      <table class="table">
        <thead>
          <tr>
            <th style="width:16%;">Patrim√¥nio</th>
            <th style="width:34%;">Descri√ß√£o</th>
            <th style="width:22%;">Colaborador</th>
            <th style="width:14%;">√öltima leitura</th>
            <th style="width:14%;">Dias sem leitura</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
      <div class="muted" style="margin-top:8px;">Regra: Dias sem leitura &gt; 10 = destaque vermelho.</div>
    `;
    return;
  }

  // ‚úÖ AGRUPADO (minimizado/expand√≠vel)
  const grp = new Map();
  list.forEach(it=>{
    const k = it.funcionario || "SEM FUNCION√ÅRIO";
    if(!grp.has(k)) grp.set(k, []);
    grp.get(k).push(it);
  });

  const colabs = Array.from(grp.keys()).map(nome=>{
    const arr = grp.get(nome) || [];
    const maxDias = arr.reduce((m,x)=> Math.max(m, x.diasSemLeitura||0), 0);
    return { nome, maxDias, count: arr.length };
  }).sort((a,b)=>{
    const d = b.maxDias - a.maxDias;
    if(d!==0) return d;
    return normKey(a.nome).localeCompare(normKey(b.nome));
  });

  const cards = colabs.map(c=>{
    const arr = grp.get(c.nome) || [];
    arr.sort((a,b)=>
      ((b.diasSemLeitura||0) - (a.diasSemLeitura||0)) ||
      normKey(a.patrimonio).localeCompare(normKey(b.patrimonio))
    );

    const itensHtml = arr.map(it=>{
      const danger = (it.diasSemLeitura||0) > 10;
      const chip = `<span class="chip ${danger?'danger':''}">${danger ? '‚ö†Ô∏è ' : ''}${esc(it.diasSemLeitura)} dia(s)</span>`;

      return `
        <div class="patItem">
          <div class="num">${esc(it.patrimonio||"-")}</div>
          <div class="desc">
            <div><b>${esc(it.identificacao||"-")}</b></div>
            <div class="mut">${esc(it.funcionario||"")}</div>
          </div>
          <div class="right">
            <div class="mut">√öltima leitura</div>
            <div><b>${esc(it.ultimaLeitura||"-")}</b></div>
          </div>
          <div class="right">
            <div class="mut">Dias</div>
            <div>${chip}</div>
          </div>
        </div>
      `;
    }).join("");

    const headerChip = `<span class="chip ${c.maxDias>10?'danger':''}">${c.maxDias>10?'‚ö†Ô∏è ':''}M√°x: ${esc(c.maxDias)} dia(s)</span>`;
    const openAttr = (c.maxDias > 10) ? "open" : "";

    return `
      <details class="patAcc" ${openAttr}>
        <summary>
          <div class="left">
            <div>üë§ ${esc(c.nome)}</div>
            <div class="meta">${esc(c.count)} item(ns)</div>
          </div>
          <div class="right">
            ${headerChip}
            <span class="chip">Clique p/ ver</span>
          </div>
        </summary>
        <div class="body">
          <div class="divider"></div>
          ${itensHtml}
        </div>
      </details>
    `;
  }).join("");

  el.innerHTML = `
    ${cards}
    <div class="muted" style="margin-top:8px;">Regra: Dias sem leitura &gt; 10 = destaque vermelho.</div>
  `;
}

/* ==========================
   SUP / MODO
========================== */
function onChangeSup(tipo){
  if(tipo==="uniformes") selectedSup.uniformes = document.getElementById("uniSup").value;
  if(tipo==="materiais") selectedSup.materiais = document.getElementById("matSup").value;
  if(tipo==="epis") selectedSup.epis = document.getElementById("epiSup").value;

  // ‚úÖ patrimonios
  if(tipo==="patrimonios"){
    selectedSup.patrimonios = document.getElementById("patSup").value;
    loadAndRenderPatrimonios();
    return;
  }

  onChangeModo(tipo);
}

async function onChangeModo(tipo){
  if(tipo==="uniformes") modo.uniformes = document.getElementById("uniModo").value;
  if(tipo==="materiais") modo.materiais = document.getElementById("matModo").value;
  if(tipo==="epis") modo.epis = document.getElementById("epiModo").value;

  if((tipo==="uniformes" && modo.uniformes==="ATUALIZAR") ||
     (tipo==="materiais" && modo.materiais==="ATUALIZAR") ||
     (tipo==="epis" && modo.epis==="ATUALIZAR")){
    await carregarUltimoPedido(tipo);
  }else{
    await refreshUltimoPDF(tipo);
  }

  if(tipo==="uniformes") renderUniformes();
  if(tipo==="materiais") renderMateriais();
  if(tipo==="epis") renderEPIs();
}

async function carregarUltimoPedido(tipo){
  if(!ctx) return;

  const sup = tipo==="uniformes" ? selectedSup.uniformes : (tipo==="materiais" ? selectedSup.materiais : selectedSup.epis);
  setBusy(true);
  const res = await api("carregarUltimoPedido", { payload:{ tipo, supervisao: sup } });
  setBusy(false);

  if(!res || !res.ok){
    showToast(res?.error || "N√£o foi poss√≠vel carregar o √∫ltimo pedido.");
    await refreshUltimoPDF(tipo);
    return;
  }

  lastPedido[tipo] = res.last || null;

  // aplica no formul√°rio
  if(tipo==="uniformes"){
    const data = res.last?.data || null;
    if(data){
      (data.itens||[]).forEach(it=>{
        if(!formUniformes[it.colaborador]) return;
        formUniformes[it.colaborador].on = true;
        formUniformes[it.colaborador].tamanho = (it.tamanho||"M").toUpperCase();
        formUniformes[it.colaborador].qtd = Number(it.qtd||1)||1;
        formUniformes[it.colaborador].cor = (it.cor||"VERDE").toUpperCase();
      });
      const tamanhos = Array.isArray(ctx?.tamanhos) ? ctx.tamanhos : ["PP","P","M","G","GG","XG","G1","G2","G3"];
      tamanhos.forEach(t=>{
        const T = String(t).toUpperCase();
        const x = (data.outros||{})[T];
        if(x){
          formOutrosUni[T] = { qtd:Number(x.qtd||0)||0, cor:(x.cor||"VERDE").toUpperCase() };
        }else{
          formOutrosUni[T] = { qtd:0, cor:"VERDE" };
        }
      });
    }
  }

  if(tipo==="materiais"){
    const data = res.last?.data || null;
    if(data){
      MATERIAIS_FIXOS.forEach(m=> formMateriais[m]=0);
      formOutros = [{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0}];

      const itens = data.itens||[];
      let outrosIdx = 0;
      itens.forEach(it=>{
        const nome = String(it.material||"").trim();
        const qtd = Number(it.un||0)||0;
        const found = MATERIAIS_FIXOS.find(x=> normKey(x)===normKey(nome));
        if(found){
          formMateriais[found] = qtd;
        }else if(outrosIdx < formOutros.length){
          formOutros[outrosIdx] = { nome, qtd };
          outrosIdx++;
        }
      });
    }
  }

  if(tipo==="epis"){
    const data = res.last?.data || null;
    if(data){
      EPIS_FIXOS.forEach(e=> formEPIs[e]=0);
      botinaItens=[]; botinaTamInput=""; botinaQtdInput=0;
      formOutrosEPIs = [{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0}];

      const itens = data.itens||[];
      const outros = data.outros||[];

      itens.forEach(it=>{
        if(normKey(it.epi)==="BOTINA"){
          if(it.tamanho){
            botinaItens.push({ tam:String(it.tamanho), qtd:Number(it.un||0)||0 });
          }else{
            formEPIs["Botina"] = Number(it.un||0)||0;
          }
        }else{
          const key = EPIS_FIXOS.find(x=> normKey(x)===normKey(it.epi));
          if(key) formEPIs[key] = Number(it.un||0)||0;
        }
      });

      outros.slice(0,4).forEach((o,i)=>{
        formOutrosEPIs[i] = { nome:String(o.nome||""), qtd:Number(o.un||0)||0 };
      });
    }
  }

  await refreshUltimoPDF(tipo);
}

async function refreshUltimoPDF(tipo){
  const sup = tipo==="uniformes" ? selectedSup.uniformes : (tipo==="materiais" ? selectedSup.materiais : selectedSup.epis);
  const res = await api("carregarUltimoPDF", { payload:{ tipo, supervisao: sup } });
  const pdfUrl = res?.ok ? (res.pdfUrl||"") : "";

  const targetTop = tipo==="uniformes" ? "pdfAreaUniformesTop" : (tipo==="materiais" ? "pdfAreaMateriaisTop" : "pdfAreaEPIsTop");
  const el = document.getElementById(targetTop);
  if(!el) return;

  if(pdfUrl){
    el.innerHTML = `<a href="${esc(pdfUrl)}" target="_blank">üìÑ √öltimo PDF desta supervis√£o</a>
                    <div class="muted">Se estiver em modo Atualizar, ao salvar ele substitui o √∫ltimo pedido.</div>`;
  }else{
    el.innerHTML = `<div class="muted">Nenhum PDF encontrado para esta supervis√£o.</div>`;
  }
}

/* ==========================
   UNIFORMES
========================== */
function renderUniformes(){
  const colsRaw = Array.isArray(ctx?.colaboradores) ? ctx.colaboradores : [];
  const supSel = String(selectedSup.uniformes||"").trim();

  const cols = colsRaw
    .filter(c=>{
      const s = String(c.supervisao||"").trim() || "SEM SUPERVIS√ÉO";
      return normKey(s) === normKey(supSel || "SEM SUPERVIS√ÉO");
    })
    .sort((a,b)=> normKey(a.colaborador).localeCompare(normKey(b.colaborador)));

  const tamanhos = Array.isArray(ctx?.tamanhos) ? ctx.tamanhos : ["PP","P","M","G","GG","XG","G1","G2","G3"];

  document.getElementById("pdfAreaUniformes").innerHTML = "";
  document.getElementById("saveStatusUniformes").innerText = "";

  if(!cols.length){
    document.getElementById("listaUniformes").innerHTML =
      `<div class="muted">Nenhum colaborador encontrado para esta supervis√£o.</div>`;
  }else{
    const html = cols.map(c=>{
      const nome = c.colaborador;
      if(!formUniformes[nome]) formUniformes[nome] = { on:true, tamanho:"M", qtd:1, cor:"VERDE" };

      const valT = (formUniformes[nome].tamanho||"M").toUpperCase();
      const valQ = Number(formUniformes[nome].qtd||1)||1;
      const valC = (formUniformes[nome].cor||"VERDE").toUpperCase();
      const on   = !!formUniformes[nome].on;

      return `
        <div class="uniRow">
          <input type="checkbox" ${on?"checked":""} onchange="onUniToggle('${encodeURIComponent(nome)}', this.checked)">
          <div>
            <div class="nm">${esc(nome)}</div>
            <div class="sub">Supervis√£o: ${esc(supSel||"SEM SUPERVIS√ÉO")}</div>
          </div>

          <select onchange="onUniformSizeChange('${encodeURIComponent(nome)}', this.value)">
            ${tamanhos.map(t=>`<option ${String(t).toUpperCase()===valT?"selected":""}>${esc(String(t).toUpperCase())}</option>`).join("")}
          </select>

          <select onchange="onUniformQtdChange('${encodeURIComponent(nome)}', this.value)">
            <option value="1" ${valQ===1?"selected":""}>1</option>
            <option value="2" ${valQ===2?"selected":""}>2</option>
          </select>

          <select onchange="onUniformCorChange('${encodeURIComponent(nome)}', this.value)">
            <option value="VERDE" ${valC==="VERDE"?"selected":""}>Verde</option>
            <option value="CINZA" ${valC==="CINZA"?"selected":""}>Cinza</option>
          </select>
        </div>
      `;
    }).join("");

    document.getElementById("listaUniformes").innerHTML = html;
  }

  // OUTROS
  const outrosHtml = tamanhos.map((t)=>{
    const T = String(t).toUpperCase();
    if(!formOutrosUni[T]) formOutrosUni[T] = { qtd:0, cor:"VERDE" };

    const qtd = Number(formOutrosUni[T].qtd||0)||0;
    const cor = (formOutrosUni[T].cor||"VERDE").toUpperCase();

    return `
      <div class="othersUniRow">
        <input value="OUTROS" disabled>
        <select disabled><option selected>${esc(T)}</option></select>

        <select onchange="onOutroQtdChangeUniforme('${encodeURIComponent(T)}', this.value)">
          <option value="0" ${qtd===0?"selected":""}>0</option>
          <option value="1" ${qtd===1?"selected":""}>1</option>
          <option value="2" ${qtd===2?"selected":""}>2</option>
        </select>

        <select onchange="onOutroCorChangeUniforme('${encodeURIComponent(T)}', this.value)">
          <option value="VERDE" ${cor==="VERDE"?"selected":""}>Verde</option>
          <option value="CINZA" ${cor==="CINZA"?"selected":""}>Cinza</option>
        </select>
      </div>
    `;
  }).join("");

  document.getElementById("listaOutrosUniformes").innerHTML = outrosHtml;
}

function onUniToggle(encNome, v){
  const nome = decodeURIComponent(encNome);
  if(!formUniformes[nome]) formUniformes[nome] = { on:true, tamanho:"M", qtd:1, cor:"VERDE" };
  formUniformes[nome].on = !!v;
}

function onUniformSizeChange(encNome, val){
  const nome = decodeURIComponent(encNome);
  if(!formUniformes[nome]) formUniformes[nome] = { on:true, tamanho:"M", qtd:1, cor:"VERDE" };
  formUniformes[nome].tamanho = String(val||"M").toUpperCase();
}
function onUniformQtdChange(encNome, val){
  const nome = decodeURIComponent(encNome);
  if(!formUniformes[nome]) formUniformes[nome] = { on:true, tamanho:"M", qtd:1, cor:"VERDE" };
  const n = (String(val)==="2") ? 2 : 1;
  formUniformes[nome].qtd = n;
}
function onUniformCorChange(encNome, val){
  const nome = decodeURIComponent(encNome);
  if(!formUniformes[nome]) formUniformes[nome] = { on:true, tamanho:"M", qtd:1, cor:"VERDE" };
  const c = (String(val).toUpperCase()==="CINZA") ? "CINZA" : "VERDE";
  formUniformes[nome].cor = c;
}

function onOutroQtdChangeUniforme(encT, v){
  const t = decodeURIComponent(encT);
  const n = (String(v)==="2") ? 2 : (String(v)==="1" ? 1 : 0);
  if(!formOutrosUni[t]) formOutrosUni[t] = { qtd:0, cor:"VERDE" };
  formOutrosUni[t].qtd = n;
}
function onOutroCorChangeUniforme(encT, v){
  const t = decodeURIComponent(encT);
  const c = (String(v).toUpperCase()==="CINZA") ? "CINZA" : "VERDE";
  if(!formOutrosUni[t]) formOutrosUni[t] = { qtd:0, cor:"VERDE" };
  formOutrosUni[t].cor = c;
}

function b64ToBlob(b64, mime){
  const bin = atob(b64);
  const len = bin.length;
  const bytes = new Uint8Array(len);
  for(let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
  return new Blob([bytes], { type: mime || "application/pdf" });
}
function autoDownloadBlob(url, filename){
  const a = document.createElement("a");
  a.href = url;
  a.download = filename || "Pedido.pdf";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* ==========================
   SALVAR UNIFORMES
========================== */
async function salvarUniformes(){
  if(!ctx) return;

  const dataRef = ctx.dataRef;
  const supSel = String(selectedSup.uniformes||"").trim() || "SEM SUPERVIS√ÉO";
  const modoSel = modo.uniformes;

  const colsRaw = Array.isArray(ctx.colaboradores) ? ctx.colaboradores : [];
  const cols = colsRaw.filter(c => normKey(String(c.supervisao||"")||"SEM SUPERVIS√ÉO") === normKey(supSel));

  const itens = cols
    .filter(c=>{
      const nome = c.colaborador;
      return !!(formUniformes[nome]?.on);
    })
    .map(c=>{
      const nome = c.colaborador;
      return {
        colaborador: nome,
        supervisao: supSel,
        tamanho: (formUniformes[nome]?.tamanho || "M").toUpperCase(),
        qtd: Number(formUniformes[nome]?.qtd || 1) || 1,
        cor: (formUniformes[nome]?.cor || "VERDE").toUpperCase()
      };
    });

  const tamanhos = Array.isArray(ctx?.tamanhos) ? ctx.tamanhos : ["PP","P","M","G","GG","XG","G1","G2","G3"];
  const outros = {};
  tamanhos.forEach(t=>{
    const T = String(t).toUpperCase();
    const q = Number(formOutrosUni?.[T]?.qtd || 0) || 0;
    if(q > 0){
      outros[T] = { qtd:q, cor:(formOutrosUni?.[T]?.cor || "VERDE").toUpperCase() };
    }
  });

  if(!itens.length && Object.keys(outros).length===0){
    document.getElementById("saveStatusUniformes").innerText = "Selecione ao menos 1 colaborador ou OUTROS.";
    return;
  }

  setBusy(true);
  document.getElementById("saveStatusUniformes").innerText = "Salvando e gerando PDF...";
  document.getElementById("pdfAreaUniformes").innerHTML = "";

  const pedidoId = (modoSel==="ATUALIZAR" && lastPedido.uniformes?.pedidoId) ? lastPedido.uniformes.pedidoId : "";
  const res = await api("salvarTamanhos", {
    payload: { dataRef, supervisao: supSel, modo: modoSel, pedidoId, itens, outros }
  });

  setBusy(false);

  if(!res || !res.ok){
    document.getElementById("saveStatusUniformes").innerText = res?.error || "Erro ao salvar";
    return;
  }

  document.getElementById("saveStatusUniformes").innerText =
    `‚úÖ Salvo! Pedido: ${res.pedidoId} | Linhas: ${res.saved_rows || 0}`;

  showToast(res.message || "Uniformes enviados com sucesso!");

  const pdf = res.pdf || {};
  if(pdf.b64){
    const blob = b64ToBlob(pdf.b64, "application/pdf");
    const url = URL.createObjectURL(blob);
    const fileName = (pdf.fileName || "Pedido_Uniformes.pdf");

    document.getElementById("pdfAreaUniformes").innerHTML = `
      <a href="${url}" download="${esc(fileName)}">‚¨áÔ∏è Baixar PDF</a>
      ${pdf.driveUrl ? `<div><a href="${esc(pdf.driveUrl)}" target="_blank">üìÅ PDF salvo no Drive</a></div>` : ``}
      <div class="muted">Se n√£o baixar automaticamente, clique no link.</div>
    `;

    autoDownloadBlob(url, fileName);
  }else{
    document.getElementById("pdfAreaUniformes").innerHTML = `<div class="muted">PDF n√£o retornou.</div>`;
  }

  await refreshUltimoPDF('uniformes');
  renderUniformes();
}

/* ==========================
   MATERIAIS
========================== */
function renderMateriais(){
  document.getElementById("saveStatusMateriais").innerText = "";
  document.getElementById("pdfAreaMateriais").innerHTML = "";

  const fixosHtml = MATERIAIS_FIXOS.map(m=>{
    const qtd = Number(formMateriais[m] || 0);
    return `
      <div class="qtyRow">
        <div class="matName">${esc(m)}</div>
        <input type="number" min="0" step="1" value="${qtd}"
               oninput="onMaterialQtyChange('${encodeURIComponent(m)}', this.value)"
               placeholder="Qtd">
      </div>
    `;
  }).join("");

  document.getElementById("listaMateriais").innerHTML = fixosHtml;

  const outrosHtml = formOutros.map((it, idx)=>{
    return `
      <div class="othersRow">
        <input value="${esc(it.nome)}" placeholder="Nome do material (outros)"
               oninput="onOutroNomeChange(${idx}, this.value)">
        <input type="number" min="0" step="1" value="${Number(it.qtd||0)}"
               oninput="onOutroQtdChangeMat(${idx}, this.value)"
               placeholder="Qtd">
        <button class="iconBtn" onclick="limparOutroMat(${idx})" title="Limpar">‚úï</button>
      </div>
    `;
  }).join("");

  document.getElementById("listaOutros").innerHTML = outrosHtml;
}
function onMaterialQtyChange(encMat, v){
  const mat = decodeURIComponent(encMat);
  const n = Math.max(0, parseInt(v || "0", 10) || 0);
  formMateriais[mat] = n;
}
function onOutroNomeChange(i, v){ formOutros[i].nome = String(v || "").trim(); }
function onOutroQtdChangeMat(i, v){ formOutros[i].qtd = Math.max(0, parseInt(v || "0", 10) || 0); }
function limparOutroMat(i){ formOutros[i] = { nome:"", qtd:0 }; renderMateriais(); }

async function salvarMateriais(){
  if(!ctx) return;

  const dataRef = ctx.dataRef || "";
  const supSel = String(selectedSup.materiais||"").trim() || "SEM SUPERVIS√ÉO";
  const modoSel = modo.materiais;

  const itens = [];

  MATERIAIS_FIXOS.forEach(m=>{
    const qtd = Number(formMateriais[m] || 0);
    if(qtd > 0) itens.push({ material: m, un: qtd });
  });

  formOutros.forEach(o=>{
    const nome = String(o.nome||"").trim();
    const qtd = Number(o.qtd||0);
    if(nome && qtd > 0) itens.push({ material: nome, un: qtd });
  });

  if(!itens.length){
    document.getElementById("saveStatusMateriais").innerText =
      "Informe pelo menos 1 material com quantidade maior que 0.";
    return;
  }

  setBusy(true);
  document.getElementById("saveStatusMateriais").innerText = "Salvando e gerando PDF...";
  document.getElementById("pdfAreaMateriais").innerHTML = "";

  const pedidoId = (modoSel==="ATUALIZAR" && lastPedido.materiais?.pedidoId) ? lastPedido.materiais.pedidoId : "";
  const res = await api("salvarMateriais", { payload: { dataRef, supervisao:supSel, modo:modoSel, pedidoId, itens } });
  setBusy(false);

  if(!res || !res.ok){
    document.getElementById("saveStatusMateriais").innerText = res?.error || "Erro ao enviar";
    return;
  }

  document.getElementById("saveStatusMateriais").innerText =
    `‚úÖ Salvo! Pedido: ${res.pedidoId} | Linhas: ${res.saved_rows || 0}`;

  showToast(res.message || "Materiais enviados com sucesso!");

  const pdf = res.pdf || {};
  if(pdf.b64){
    const blob = b64ToBlob(pdf.b64, "application/pdf");
    const url = URL.createObjectURL(blob);
    const fileName = (pdf.fileName || "Pedido_Materiais.pdf");

    document.getElementById("pdfAreaMateriais").innerHTML = `
      <a href="${url}" download="${esc(fileName)}">‚¨áÔ∏è Baixar PDF</a>
      ${pdf.driveUrl ? `<div><a href="${esc(pdf.driveUrl)}" target="_blank">üìÅ PDF salvo no Drive</a></div>` : ``}
      <div class="muted">Se n√£o baixar automaticamente, clique no link.</div>
    `;
    autoDownloadBlob(url, fileName);
  }else{
    document.getElementById("pdfAreaMateriais").innerHTML = `<div class="muted">PDF n√£o retornou.</div>`;
  }

  MATERIAIS_FIXOS.forEach(m => formMateriais[m] = 0);
  formOutros = [{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0}];

  await refreshUltimoPDF('materiais');
  renderMateriais();
}

/* ==========================
   EPIs
========================== */
function renderEPIs(){
  document.getElementById("saveStatusEPIs").innerText = "";
  document.getElementById("pdfAreaEPIs").innerHTML = "";

  const fixosHtml = EPIS_FIXOS.map(epi=>{
    if(epi === "Botina"){
      const lista = botinaItens.map((it, idx)=>`
        <div class="othersRow" style="border-bottom:none; padding:8px 0;">
          <input value="Tam ${esc(it.tam)}" disabled>
          <input type="number" min="0" step="1" value="${Number(it.qtd||0)}"
                 oninput="onBotinaQtdChange(${idx}, this.value)"
                 placeholder="Un">
          <button class="iconBtn" onclick="removerBotina(${idx})" title="Remover">‚úï</button>
        </div>
      `).join("");

      return `
        <div style="padding:10px 0; border-bottom:1px solid #f3f4f6;">
          <div class="qtyRow" style="border-bottom:none; padding:0 0 6px 0;">
            <div class="matName"><b>Botina</b> <span class="muted">Digite o tamanho (opcional)</span></div>
            <div></div>
          </div>

          <div class="botinaInlineRow">
            <input value="${esc(botinaTamInput)}"
                   placeholder="Digite o tamanho"
                   inputmode="numeric"
                   oninput="onBotinaTamInput(this.value)">
            <input type="number" min="0" step="1" value="${Number(botinaQtdInput||0)}"
                   oninput="onBotinaQtdInput(this.value)"
                   placeholder="Un">
            <button class="botinaPlusBtn" onclick="addBotina()" title="Adicionar">+</button>
          </div>

          <div>${lista || `<div class="muted" style="margin-top:6px;">Nenhum tamanho adicionado.</div>`}</div>
        </div>
      `;
    }

    const qtd = Number(formEPIs[epi] || 0);
    return `
      <div class="qtyRow">
        <div class="matName">${esc(epi)}</div>
        <input type="number" min="0" step="1" value="${qtd}"
               oninput="onEpiQtyChange('${encodeURIComponent(epi)}', this.value)"
               placeholder="Un">
      </div>
    `;
  }).join("");

  document.getElementById("listaEPIs").innerHTML = fixosHtml;

  const outrosHtml = formOutrosEPIs.map((it, idx)=>{
    return `
      <div class="othersRow">
        <input value="${esc(it.nome)}" placeholder="Nome do EPI (outros)"
               oninput="onOutroEpiNomeChange(${idx}, this.value)">
        <input type="number" min="0" step="1" value="${Number(it.qtd||0)}"
               oninput="onOutroEpiQtdChange(${idx}, this.value)"
               placeholder="Un">
        <button class="iconBtn" onclick="limparOutroEpi(${idx})" title="Limpar">‚úï</button>
      </div>
    `;
  }).join("");

  document.getElementById("listaOutrosEPIs").innerHTML = outrosHtml;
}

function onEpiQtyChange(encEpi, v){
  const epi = decodeURIComponent(encEpi);
  const n = Math.max(0, parseInt(v || "0", 10) || 0);
  formEPIs[epi] = n;
}
function onBotinaTamInput(v){ botinaTamInput = String(v||"").trim(); }
function onBotinaQtdInput(v){ botinaQtdInput = Math.max(0, parseInt(v||"0", 10) || 0); }
function onBotinaQtdChange(i, v){
  const n = Math.max(0, parseInt(v||"0", 10) || 0);
  if(botinaItens[i]) botinaItens[i].qtd = n;
}
function removerBotina(i){ botinaItens.splice(i, 1); renderEPIs(); }

function addBotina(){
  const tam = String(botinaTamInput||"").trim();
  const qtd = Math.max(0, parseInt(botinaQtdInput||"0", 10) || 0);

  if(qtd <= 0){
    document.getElementById("saveStatusEPIs").innerText = "Botina: informe a unidade (> 0).";
    return;
  }

  const tamKey = tam ? tam.replace(/\s+/g," ").trim() : "";

  if(tamKey){
    const idx = botinaItens.findIndex(x => String(x.tam) === tamKey);
    if(idx >= 0) botinaItens[idx].qtd = Number(botinaItens[idx].qtd||0) + qtd;
    else botinaItens.push({ tam: tamKey, qtd });
  }else{
    formEPIs["Botina"] = (Number(formEPIs["Botina"]||0)||0) + qtd;
  }

  botinaTamInput = "";
  botinaQtdInput = 0;
  document.getElementById("saveStatusEPIs").innerText = "";
  renderEPIs();
}

function onOutroEpiNomeChange(i, v){ formOutrosEPIs[i].nome = String(v || "").trim(); }
function onOutroEpiQtdChange(i, v){ formOutrosEPIs[i].qtd = Math.max(0, parseInt(v || "0", 10) || 0); }
function limparOutroEpi(i){ formOutrosEPIs[i] = { nome:"", qtd:0 }; renderEPIs(); }

async function salvarEPIs(){
  if(!ctx) return;

  const dataRef = ctx.dataRef || "";
  const supSel = String(selectedSup.epis||"").trim() || "SEM SUPERVIS√ÉO";
  const modoSel = modo.epis;

  const itens = [];

  EPIS_FIXOS.forEach(epi=>{
    if(epi === "Botina") return;
    const qtd = Number(formEPIs[epi] || 0);
    if(qtd > 0) itens.push({ epi, un: qtd });
  });

  const botinaFixa = Number(formEPIs["Botina"]||0)||0;
  if(botinaFixa > 0) itens.push({ epi:"Botina", un: botinaFixa });

  botinaItens.forEach(it=>{
    const qtd = Number(it.qtd||0);
    const tam = String(it.tam||"").trim();
    if(tam && qtd > 0) itens.push({ epi:"Botina", tamanho: tam, un: qtd });
  });

  const outros = formOutrosEPIs.map(o=>({
    nome: String(o.nome||"").trim(),
    un: Math.max(0, parseInt(o.qtd||0, 10) || 0)
  }));

  const hasOutros = outros.some(o => o.nome && o.un > 0);
  if(!itens.length && !hasOutros){
    document.getElementById("saveStatusEPIs").innerText =
      "Informe pelo menos 1 EPI com unidade maior que 0.";
    return;
  }

  setBusy(true);
  document.getElementById("saveStatusEPIs").innerText = "Salvando e gerando PDF...";
  document.getElementById("pdfAreaEPIs").innerHTML = "";

  const pedidoId = (modoSel==="ATUALIZAR" && lastPedido.epis?.pedidoId) ? lastPedido.epis.pedidoId : "";
  const res = await api("salvarEPIs", { payload: { dataRef, supervisao:supSel, modo:modoSel, pedidoId, itens, outros } });
  setBusy(false);

  if(!res || !res.ok){
    document.getElementById("saveStatusEPIs").innerText = res?.error || "Erro ao enviar";
    return;
  }

  document.getElementById("saveStatusEPIs").innerText =
    `‚úÖ Salvo! Pedido: ${res.pedidoId} | Linhas: ${res.saved_rows || 0}`;

  showToast(res.message || "EPI's enviados com sucesso!");

  const pdf = res.pdf || {};
  if(pdf.b64){
    const blob = b64ToBlob(pdf.b64, "application/pdf");
    const url = URL.createObjectURL(blob);
    const fileName = (pdf.fileName || "Pedido_EPIs.pdf");

    document.getElementById("pdfAreaEPIs").innerHTML = `
      <a href="${url}" download="${esc(fileName)}">‚¨áÔ∏è Baixar PDF</a>
      ${pdf.driveUrl ? `<div><a href="${esc(pdf.driveUrl)}" target="_blank">üìÅ PDF salvo no Drive</a></div>` : ``}
      <div class="muted">Se n√£o baixar automaticamente, clique no link.</div>
    `;
    autoDownloadBlob(url, fileName);
  }else{
    document.getElementById("pdfAreaEPIs").innerHTML = `<div class="muted">PDF n√£o retornou.</div>`;
  }

  EPIS_FIXOS.forEach(e => formEPIs[e] = 0);
  botinaItens=[]; botinaTamInput=""; botinaQtdInput=0;
  formOutrosEPIs = [{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0}];

  await refreshUltimoPDF('epis');
  renderEPIs();
}

/* init */
window.onload = async ()=>{
  const pin = document.getElementById("pin");
  pin.addEventListener("input", ()=> pin.value = onlyDigits(pin.value).slice(0,4));
  pin.addEventListener("keydown", (e)=>{ if(e.key==="Enter") login(); });

  show("loginCard");
  hide("app"); hide("bottomBar");

  if(token){
    const p = await api("ping", {});
    if(p && p.ok){
      hide("loginCard"); show("app"); show("bottomBar");
      await bootstrap();
    }else{
      logout();
    }
  }
};
</script>
</body>
</html>
