<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gestor ‚Äì Uniformes e Materiais</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    body{ margin:0; font-family:Arial,sans-serif; background:#f5f6f7; }
    .wrap{ max-width:1100px; margin:auto; padding:14px 14px 120px; }
    .card{ background:#fff; border-radius:14px; padding:14px; margin-bottom:12px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    h2,h3{ margin:0 0 8px; }
    .muted{ color:#6b7280; font-size:12px; white-space:pre-line; }
    input,select,button{ width:100%; padding:10px; border-radius:12px; border:1px solid #d1d5db; font-size:14px; box-sizing:border-box; }
    button{ cursor:pointer; border:none; background:#166534; color:#fff; font-weight:800; }
    button.secondary{ background:#374151; }
    button.danger{ background:#111827; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1; min-width:220px; }

    .pill{ display:inline-block; padding:4px 10px; background:#e0f2fe; border-radius:999px; font-size:12px; margin-top:6px; }
    .topbar{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .logoutBtn{ width:auto; padding:9px 14px; border-radius:999px; background:#111827; }

    .list{ margin-top:10px; }

    .supHeader{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      background:#f0fdf4;
      border:1px solid #dcfce7;
      font-weight:900;
      color:#166534;
      font-size:13px;
    }
    .supHeader small{
      display:block;
      margin-top:3px;
      font-weight:700;
      color:#6b7280;
      font-size:11px;
    }

    .bottomBar{ position:fixed; left:0; right:0; bottom:0; background:#f5f6f7; border-top:1px solid #e5e7eb; padding:10px; }
    .bottomBar .inner{ max-width:1100px; margin:auto; display:flex; gap:10px; flex-wrap:wrap; }
    .bottomBar .inner button{ width:auto; min-width:160px; }

    .pdfArea a{ display:inline-block; margin-top:8px; font-weight:900; color:#166534; text-decoration:none; }
    .pdfArea .muted{ margin-top:6px; }

    .menuGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(220px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .menuBtn{
      padding:16px;
      border-radius:14px;
      background:#166534;
      color:#fff;
      font-weight:900;
      text-align:left;
      box-shadow:0 1px 3px rgba(0,0,0,.06);
    }
    .menuBtn .small{ display:block; font-weight:600; opacity:.9; margin-top:6px; font-size:12px; }
    .menuBtn.secondary{ background:#0f172a; }

    /* linhas */
    .qtyRow{
      display:grid;
      grid-template-columns: 1fr 120px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .qtyRow:last-child{ border-bottom:none; }
    .qtyRow .matName{ font-weight:800; font-size:13px; }
    .qtyRow input[type="number"]{ text-align:center; }

    .othersRow{
      display:grid;
      grid-template-columns: 1fr 120px 42px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .othersRow:last-child{ border-bottom:none; }

    .iconBtn{ width:42px; height:42px; border-radius:12px; background:#374151; color:#fff; font-weight:900; }

    /* ‚úÖ UNIFORMES: checkbox + tamanho + qtd + cor */
    .uniRow{
      display:grid;
      grid-template-columns: 28px 1fr 120px 90px 110px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .uniRow:last-child{ border-bottom:none; }
    .uniRow .nm{ font-weight:900; font-size:13px; }
    .uniRow .sub{ font-size:11px; color:#6b7280; margin-top:2px; }
    .uniRow input[type="checkbox"]{ width:18px; height:18px; }

    /* OUTROS UNIFORMES */
    .othersUniRow{
      display:grid;
      grid-template-columns: 1fr 120px 90px 110px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .othersUniRow:last-child{ border-bottom:none; }
    .othersUniRow input[disabled], .othersUniRow select[disabled]{ background:#f3f4f6; color:#111827; opacity:1; cursor:not-allowed; }
    .othersUniRow input[type="number"]{ text-align:center; }

    /* ‚úÖ EPIs - Botina */
    .botinaInlineRow{
      display:grid;
      grid-template-columns: 1fr 120px 52px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .botinaInlineRow:last-child{ border-bottom:none; }
    .botinaInlineRow input[type="number"]{ text-align:center; }
    .botinaPlusBtn{ width:52px; height:42px; border-radius:12px; background:#166534; color:#fff; font-weight:900; }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:86px; transform:translateX(-50%);
      background:#111827; color:#fff;
      padding:10px 14px; border-radius:999px;
      box-shadow:0 8px 24px rgba(0,0,0,.18);
      font-size:13px; font-weight:800;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      max-width: calc(100% - 24px);
      text-align:center;
      z-index:9999;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }

    /* ==========================
       PATRIM√îNIOS (NOVO)
    ========================== */
    .segRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .seg{
      display:flex; gap:6px;
      background:#f3f4f6;
      padding:6px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      width:100%;
      max-width:520px;
    }
    .seg button{
      width:auto; flex:1;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      border:0;
      background:transparent;
      color:#111827;
    }
    .seg button.active{ background:#166534; color:#fff; }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:10px;
      overflow:hidden;
      border-radius:12px;
      border:1px solid #e5e7eb;
    }
    .table thead th{
      background:#166534;
      color:#fff;
      font-size:12px;
      text-align:left;
      padding:10px;
      position:sticky;
      top:0;
      z-index:1;
    }
    .table td{
      background:#fff;
      border-top:1px solid #f3f4f6;
      padding:10px;
      font-size:13px;
      vertical-align:top;
    }
    .table tr:nth-child(even) td{ background:#f9fafb; }

    .chip{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      background:#eef2ff;
      color:#111827;
      border:1px solid #e5e7eb;
      white-space:nowrap;
    }
    .chip.danger{
      background:#fee2e2;
      color:#7f1d1d;
      border-color:#fecaca;
    }

    .patItem{
      display:grid;
      grid-template-columns: 120px 1fr 140px 120px;
      gap:10px;
      padding:10px 0;
      border-top:1px solid #f3f4f6;
      align-items:start;
    }
    .patItem:first-child{ border-top:none; }
    .patItem .num{ font-weight:900; }
    .patItem .desc{ font-size:13px; }
    .patItem .mut{ color:#6b7280; font-size:12px; }
    .patItem .right{ text-align:right; }

    /* ‚úÖ Accordion (AGRUPADO por colaborador) */
    .patAcc{
      border:1px solid #e5e7eb;
      border-radius:14px;
      background:#fff;
      margin-top:10px;
      box-shadow:0 1px 3px rgba(0,0,0,.06);
      overflow:hidden;
    }
    .patAcc summary{
      list-style:none;
      cursor:pointer;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:900;
    }
    .patAcc summary::-webkit-details-marker{ display:none; }
    .patAcc summary .left{
      display:flex; flex-direction:column; gap:4px;
    }
    .patAcc summary .meta{
      font-weight:700;
      font-size:12px;
      color:#6b7280;
    }
    .patAcc summary .right{
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .patAcc .body{
      padding:0 12px 12px 12px;
    }
    .patAcc .divider{
      height:1px;
      background:#f3f4f6;
      margin:0 0 8px 0;
    }

    @media (max-width: 720px){
      .wrap{ padding:12px 10px 110px; }
      .menuGrid{ grid-template-columns: 1fr; }
      .uniRow{ grid-template-columns: 28px 1fr; }
      .uniRow select, .uniRow input{ grid-column: span 2; }
      .othersUniRow{ grid-template-columns: 1fr; }
      .othersRow{ grid-template-columns: 1fr; }
      .qtyRow{ grid-template-columns: 1fr; }
      .botinaInlineRow{ grid-template-columns: 1fr; }
      .patItem{ grid-template-columns: 1fr; }
      .patItem .right{ text-align:left; }
      .seg{ max-width:none; }
      .patAcc summary .right{ flex-wrap:wrap; justify-content:flex-end; }
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h2>Login do Gestor</h2>
    <div class="muted">Informe seu <b>PIN (4 d√≠gitos)</b> (aba Gestores).</div>

    <div class="row" style="margin-top:10px;">
      <div class="col">
        <input id="pin" placeholder="PIN" inputmode="numeric" maxlength="4" autocomplete="off">
      </div>
      <div class="col">
        <button id="btnLogin" onclick="login()">Entrar</button>
      </div>
    </div>

    <div id="loginStatus" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;">

    <!-- HEADER -->
    <div class="card">
      <div class="topbar">
        <div>
          <h3 style="margin:0;">Portal do Gestor</h3>
          <div id="topInfo" class="muted" style="margin-top:4px;"></div>
          <div id="dataInfo" class="muted"></div>
        </div>
        <button class="logoutBtn" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- MENU -->
    <div id="screenMenu" class="card">
      <h3>Escolha uma op√ß√£o</h3>
      <div class="muted">Selecione o que deseja registrar/consultar.</div>

      <div class="menuGrid">
        <button class="menuBtn" onclick="goUniformes()">
          üëï Uniformes
          <span class="small">Selecione colaboradores, tamanho, qtd (1/2), cor (verde/cinza) e gere PDF.</span>
        </button>

        <button class="menuBtn secondary" onclick="goMateriais()">
          üß∞ Materiais
          <span class="small">Solicite materiais com quantidade e gere PDF.</span>
        </button>

        <button class="menuBtn secondary" onclick="goEPIs()">
          ü¶∫ EPI's
          <span class="small">Solicite EPIs com quantidade, Botina com v√°rios tamanhos e PDF.</span>
        </button>

        <button class="menuBtn secondary" onclick="goPatrimonios()">
          üè∑Ô∏è Patrim√¥nios
          <span class="small">Consulte n¬∫, descri√ß√£o, √∫ltima leitura e dias sem leitura (alerta &gt; 10).</span>
        </button>
      </div>
    </div>

    <!-- UNIFORMES -->
    <div id="screenUniformes" class="card" style="display:none;">
      <div class="row" style="align-items:center;">
        <div class="col">
          <h3>Uniformes</h3>
          <div class="muted">Escolha a supervis√£o, modo e configure por colaborador.</div>
        </div>
        <div class="col" style="max-width:220px;">
          <button class="secondary" onclick="goMenu()">‚¨ÖÔ∏è Voltar</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <div class="muted"><b>Supervis√£o</b></div>
          <select id="uniSup" onchange="onChangeSup('uniformes')"></select>
        </div>
        <div class="col">
          <div class="muted"><b>Modo</b></div>
          <select id="uniModo" onchange="onChangeModo('uniformes')">
            <option value="NOVA" selected>Nova solicita√ß√£o</option>
            <option value="ATUALIZAR">Atualizar solicita√ß√£o</option>
          </select>
        </div>
      </div>

      <div class="pdfArea" id="pdfAreaUniformesTop"></div>

      <div class="list" id="listaUniformes"></div>

      <h3 style="margin-top:14px;">OUTROS (novas contrata√ß√µes)</h3>
      <div class="muted">OUTROS √© fixo ‚Äî informe tamanho, qtd e cor.</div>
      <div class="list" id="listaOutrosUniformes"></div>

      <div class="pdfArea" id="pdfAreaUniformes"></div>
      <div id="saveStatusUniformes" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- MATERIAIS -->
    <div id="screenMateriais" class="card" style="display:none;">
      <div class="row" style="align-items:center;">
        <div class="col">
          <h3>Materiais</h3>
          <div class="muted">Escolha a supervis√£o, modo e informe quantidades (0 = n√£o solicitar).</div>
        </div>
        <div class="col" style="max-width:220px;">
          <button class="secondary" onclick="goMenu()">‚¨ÖÔ∏è Voltar</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <div class="muted"><b>Supervis√£o</b></div>
          <select id="matSup" onchange="onChangeSup('materiais')"></select>
        </div>
        <div class="col">
          <div class="muted"><b>Modo</b></div>
          <select id="matModo" onchange="onChangeModo('materiais')">
            <option value="NOVA" selected>Nova solicita√ß√£o</option>
            <option value="ATUALIZAR">Atualizar solicita√ß√£o</option>
          </select>
        </div>
      </div>

      <div class="pdfArea" id="pdfAreaMateriaisTop"></div>

      <div id="listaMateriais" class="list"></div>

      <h3 style="margin-top:14px;">Outros (at√© 5)</h3>
      <div class="muted">Preencha o nome do material e a quantidade. Deixe em branco se n√£o usar.</div>
      <div id="listaOutros" class="list"></div>

      <div class="pdfArea" id="pdfAreaMateriais"></div>
      <div id="saveStatusMateriais" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- EPIs -->
    <div id="screenEPIs" class="card" style="display:none;">
      <div class="row" style="align-items:center;">
        <div class="col">
          <h3>EPI's</h3>
          <div class="muted">Escolha a supervis√£o, modo e informe quantidades (0 = n√£o solicitar).</div>
        </div>
        <div class="col" style="max-width:220px;">
          <button class="secondary" onclick="goMenu()">‚¨ÖÔ∏è Voltar</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <div class="muted"><b>Supervis√£o</b></div>
          <select id="epiSup" onchange="onChangeSup('epis')"></select>
        </div>
        <div class="col">
          <div class="muted"><b>Modo</b></div>
          <select id="epiModo" onchange="onChangeModo('epis')">
            <option value="NOVA" selected>Nova solicita√ß√£o</option>
            <option value="ATUALIZAR">Atualizar solicita√ß√£o</option>
          </select>
        </div>
      </div>

      <div class="pdfArea" id="pdfAreaEPIsTop"></div>

      <div id="listaEPIs" class="list"></div>

      <h3 style="margin-top:14px;">Outros (4)</h3>
      <div class="muted">Preencha o nome do EPI e a quantidade. Deixe em branco se n√£o usar.</div>
      <div id="listaOutrosEPIs" class="list"></div>

      <div class="pdfArea" id="pdfAreaEPIs"></div>
      <div id="saveStatusEPIs" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- ‚úÖ PATRIM√îNIOS -->
    <div id="screenPatrimonios" class="card" style="display:none;">
      <div class="row" style="align-items:center;">
        <div class="col">
          <h3>Patrim√¥nios</h3>
          <div class="muted">Consulte por supervis√£o. Dias sem leitura &gt; 10 ficam em vermelho.</div>
        </div>
        <div class="col" style="max-width:220px;">
          <button class="secondary" onclick="goMenu()">‚¨ÖÔ∏è Voltar</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <div class="muted"><b>Supervis√£o</b></div>
          <select id="patSup" onchange="onChangeSup('patrimonios')"></select>
        </div>

        <div class="col">
          <div class="muted"><b>Visualiza√ß√£o</b></div>
          <div class="segRow">
            <div class="seg">
              <button id="btnPatTab" class="active" onclick="setPatView('TABELA')">Tabela √∫nica</button>
              <button id="btnPatGrp" onclick="setPatView('AGRUPADO')">Agrupar por colaborador</button>
            </div>
          </div>
        </div>
      </div>

      <div id="patStatus" class="muted" style="margin-top:10px;"></div>
      <div id="patContent" class="list"></div>
    </div>

  </div>
</div>

<div class="bottomBar" id="bottomBar" style="display:none;">
  <div class="inner" id="bottomActions"></div>
</div>

<div id="toast" class="toast"></div>

<script>
const API_BASE = "https://uniformes-e-materiais.tecnologia-f0c.workers.dev/";

let token = localStorage.getItem("TAM_TOKEN") || "";
let ctx = null;

// estado geral
let selectedSup = { uniformes:"", materiais:"", epis:"", patrimonios:"" };
let modo = { uniformes:"NOVA", materiais:"NOVA", epis:"NOVA" };
let lastPedido = { uniformes:null, materiais:null, epis:null };

// Patrim√¥nios
let patView = "TABELA"; // TABELA | AGRUPADO
let patCacheBySup = {}; // supNorm -> itens

// uniformes
let formUniformes = {}; // keyNorm -> {nome,on,tamanho,qtd,cor}
let formOutrosUni = {}; // TAM -> {qtd,cor}

// materiais
const MATERIAIS_FIXOS = ["balan√ßa","impressora de laudo","calador","kit peneiras","quarteador","micropipeta","alicate de corte"];
let formMateriais = {}; // nomeFix -> qtd
let formOutros = [{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0}];

// EPIs
const EPIS_FIXOS = ["Capacete","Protetor auricular","√ìculos Transparente","Luva PU","Mascara PFF2","Botina"];
let formEPIs = {}; // epiFix -> qtd (exceto botina multi)
let botinaItens = []; // [{tam,qtd}]
let botinaTamInput = "";
let botinaQtdInput = 0;
let formOutrosEPIs = [{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0}];

function onlyDigits(s){ return String(s||"").replace(/\D/g,""); }
function esc(s){ return String(s||"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

function show(id){ document.getElementById(id).style.display="block"; }
function hide(id){ document.getElementById(id).style.display="none"; }

function normKey(s){
  return String(s||"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .trim()
    .toUpperCase();
}
function isSemSup_(s){
  const raw = String(s||"").trim();
  return (!raw || normKey(raw) === normKey("SEM SUPERVIS√ÉO"));
}

/* ==========================
   ‚úÖ FIX PRINCIPAL (UNIFORMES)
   - chave normalizada para colaborador
   - filtro por supervis√£o robusto
========================== */
function colKey_(nome){ return normKey(nome||""); }

function listColsBySup_(supSel){
  const arr = Array.isArray(ctx?.colaboradores) ? ctx.colaboradores : [];
  const supN = normKey(supSel || "");
  return arr.filter(c=>{
    const s = String(c?.supervisao || "").trim();
    if(isSemSup_(supSel)) return isSemSup_(s);
    return normKey(s) === supN;
  });
}

let toastTimer = null;
function showToast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg || "Conclu√≠do!";
  el.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> el.classList.remove("show"), 2600);
}

function setBusy(v){
  const b = !!v;
  ["btnLogin"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.disabled = b;
  });
  document.querySelectorAll("#bottomActions button").forEach(x => x.disabled = b);
}

function setBottomActions(html){
  document.getElementById("bottomActions").innerHTML = html || "";
}

async function api(action, args){
  const payload = { action, ...(args||{}) };
  if(token && !payload.token && action !== "loginPIN"){
    payload.token = token;
  }

  let txt = "";
  try{
    const res = await fetch(API_BASE, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    txt = await res.text();
  }catch(e){
    return { ok:false, error:"Falha de rede / CORS", raw:String(e) };
  }

  try{ return JSON.parse(txt); }
  catch(e){ return { ok:false, error:"Resposta inv√°lida do servidor", raw:txt }; }
}

function logout(){
  localStorage.removeItem("TAM_TOKEN");
  token = "";
  ctx = null;

  selectedSup = { uniformes:"", materiais:"", epis:"", patrimonios:"" };
  modo = { uniformes:"NOVA", materiais:"NOVA", epis:"NOVA" };
  lastPedido = { uniformes:null, materiais:null, epis:null };

  patView = "TABELA";
  patCacheBySup = {};

  formUniformes = {};
  formOutrosUni = {};

  formMateriais = {};
  MATERIAIS_FIXOS.forEach(m => formMateriais[m] = 0);
  formOutros = [{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0}];

  formEPIs = {};
  EPIS_FIXOS.forEach(e => formEPIs[e] = 0);
  botinaItens = []; botinaTamInput=""; botinaQtdInput=0;
  formOutrosEPIs = [{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0}];

  document.getElementById("loginStatus").innerText = "Fa√ßa login novamente.";
  hide("app"); hide("bottomBar"); show("loginCard");
}

async function login(){
  const pin = onlyDigits(document.getElementById("pin").value).slice(0,4);
  if(pin.length < 4){
    document.getElementById("loginStatus").innerText = "Informe 4 d√≠gitos.";
    return;
  }

  setBusy(true);
  document.getElementById("loginStatus").innerText = "Entrando...";

  const out = await api("loginPIN", { pin });
  setBusy(false);

  if(!out || !out.ok){
    document.getElementById("loginStatus").innerText = out?.error || "Erro";
    return;
  }

  token = out.token;
  localStorage.setItem("TAM_TOKEN", token);

  hide("loginCard");
  show("app");
  show("bottomBar");
  document.getElementById("loginStatus").innerText = "";

  await bootstrap();
}

function fillSupSelects(){
  const sups = Array.isArray(ctx?.gestor?.supervisoesLiberadas) ? ctx.gestor.supervisoesLiberadas : [];
  const list = sups.length ? sups : ["SEM SUPERVIS√ÉO"];

  ["uniSup","matSup","epiSup","patSup"].forEach((id)=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.innerHTML = list.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join("");
  });

  selectedSup.uniformes = list[0] || "SEM SUPERVIS√ÉO";
  selectedSup.materiais = list[0] || "SEM SUPERVIS√ÉO";
  selectedSup.epis = list[0] || "SEM SUPERVIS√ÉO";
  selectedSup.patrimonios = list[0] || "SEM SUPERVIS√ÉO";

  document.getElementById("uniSup").value = selectedSup.uniformes;
  document.getElementById("matSup").value = selectedSup.materiais;
  document.getElementById("epiSup").value = selectedSup.epis;
  document.getElementById("patSup").value = selectedSup.patrimonios;

  setPatViewButtons_();
}

async function bootstrap(){
  setBusy(true);
  const res = await api("carregarListaRecente", {});
  setBusy(false);

  if(!res || !res.ok){
    alert(res?.error || "Erro ao carregar dados do gestor.");
    logout();
    return;
  }

  ctx = res;
  const g = res.gestor || {};

  const supTxt = (Array.isArray(g.supervisoesLiberadas) && g.supervisoesLiberadas.length)
    ? g.supervisoesLiberadas.join("; ")
    : "(todas)";

  document.getElementById("topInfo").innerText =
    `Gestor: ${g.nome||"GESTOR"} | Coordena√ß√£o: ${g.coordenacao||"-"} | Supervis√µes liberadas: ${supTxt}`;

  document.getElementById("dataInfo").innerHTML =
    `<span class="pill">Data mais recente do hist√≥rico: <b>${esc(res.dataRef||"")}</b></span>`;

  fillSupSelects();

  const tamanhos = Array.isArray(res.tamanhos) ? res.tamanhos : ["PP","P","M","G","GG","XG","G1","G2","G3"];

  // ‚úÖ FIX: formUniformes com chave normalizada (evita sumir colaborador)
  formUniformes = {};
  const cols = Array.isArray(res.colaboradores) ? res.colaboradores : [];
  cols.forEach(c=>{
    const nome = String(c?.colaborador || "").trim();
    if(!nome) return;
    const k = colKey_(nome);
    formUniformes[k] = { nome, on:true, tamanho:"M", qtd:1, cor:"VERDE" };
  });

  formOutrosUni = {};
  tamanhos.forEach(t => formOutrosUni[String(t).toUpperCase()] = { qtd:0, cor:"VERDE" });

  formMateriais = {}; MATERIAIS_FIXOS.forEach(m => formMateriais[m] = 0);

  formEPIs = {}; EPIS_FIXOS.forEach(e => formEPIs[e] = 0);
  botinaItens=[]; botinaTamInput=""; botinaQtdInput=0;
  formOutrosEPIs = [{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0}];

  patView = "TABELA";
  patCacheBySup = {};
  setPatViewButtons_();

  ["pdfAreaUniformesTop","pdfAreaMateriaisTop","pdfAreaEPIsTop","pdfAreaUniformes","pdfAreaMateriais","pdfAreaEPIs"]
    .forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML=""; });

  goMenu();
}

function goMenu(){
  show("screenMenu");
  hide("screenUniformes");
  hide("screenMateriais");
  hide("screenEPIs");
  hide("screenPatrimonios");
  setBottomActions(`<button class="secondary" onclick="bootstrap()">Recarregar</button>`);
}

async function goUniformes(){
  hide("screenMenu"); show("screenUniformes"); hide("screenMateriais"); hide("screenEPIs"); hide("screenPatrimonios");
  await refreshUltimoPDF('uniformes');
  renderUniformes();
  renderOutrosUniformes();
  setBottomActions(`
    <button class="secondary" onclick="bootstrap()">Recarregar</button>
    <button onclick="salvarUniformes()">Salvar e Gerar PDF</button>
  `);
}

async function goMateriais(){
  hide("screenMenu"); hide("screenUniformes"); show("screenMateriais"); hide("screenEPIs"); hide("screenPatrimonios");
  await refreshUltimoPDF('materiais');
  renderMateriais();
  renderOutrosMateriais();
  setBottomActions(`
    <button class="secondary" onclick="bootstrap()">Recarregar</button>
    <button onclick="salvarMateriais()">Salvar e Gerar PDF</button>
  `);
}

async function goEPIs(){
  hide("screenMenu"); hide("screenUniformes"); hide("screenMateriais"); show("screenEPIs"); hide("screenPatrimonios");
  await refreshUltimoPDF('epis');
  renderEPIs();
  renderOutrosEPIs();
  setBottomActions(`
    <button class="secondary" onclick="bootstrap()">Recarregar</button>
    <button onclick="salvarEPIs()">Salvar e Gerar PDF</button>
  `);
}

/* ==========================
   ‚úÖ RENDER UNIFORMES (FIX)
========================== */
function renderUniformes(){
  const supSel = String(selectedSup.uniformes || "").trim() || "SEM SUPERVIS√ÉO";
  const list = listColsBySup_(supSel);
  const el = document.getElementById("listaUniformes");
  if(!el) return;

  if(!list.length){
    const total = Array.isArray(ctx?.colaboradores) ? ctx.colaboradores.length : 0;
    el.innerHTML = `
      <div class="muted">
        Nenhum colaborador encontrado para esta supervis√£o.<br>
        <b>Sup selecionada:</b> ${esc(supSel)}<br>
        <b>Total retornado pelo backend:</b> ${esc(total)}
      </div>
    `;
    return;
  }

  const tamanhos = Array.isArray(ctx?.tamanhos) ? ctx.tamanhos : ["PP","P","M","G","GG","XG","G1","G2","G3"];
  list.sort((a,b)=> normKey(a.colaborador).localeCompare(normKey(b.colaborador)));

  el.innerHTML = list.map(c=>{
    const nome = String(c?.colaborador || "").trim();
    const sub = String(c?.supervisao || "").trim();
    const k = colKey_(nome);

    if(!formUniformes[k]){
      formUniformes[k] = { nome, on:true, tamanho:"M", qtd:1, cor:"VERDE" };
    }
    const st = formUniformes[k];

    return `
      <div class="uniRow">
        <input type="checkbox" ${st.on ? "checked":""}
          onchange="formUniformes['${esc(k)}'].on = this.checked">

        <div>
          <div class="nm">${esc(nome)}</div>
          <div class="sub">${esc(sub)}</div>
        </div>

        <select onchange="formUniformes['${esc(k)}'].tamanho = this.value">
          ${tamanhos.map(t=>{
            const T = String(t).toUpperCase();
            const cur = String(st.tamanho||"M").toUpperCase();
            return `<option value="${esc(T)}" ${cur===T?"selected":""}>${esc(T)}</option>`;
          }).join("")}
        </select>

        <select onchange="formUniformes['${esc(k)}'].qtd = Number(this.value)||1">
          ${[1,2].map(n=>`<option value="${n}" ${(Number(st.qtd||1)===n)?"selected":""}>${n}</option>`).join("")}
        </select>

        <select onchange="formUniformes['${esc(k)}'].cor = this.value">
          ${["VERDE","CINZA"].map(cor=>{
            const cur = String(st.cor||"VERDE").toUpperCase();
            return `<option value="${esc(cor)}" ${cur===cor?"selected":""}>${esc(cor)}</option>`;
          }).join("")}
        </select>
      </div>
    `;
  }).join("");
}

function renderOutrosUniformes(){
  const el = document.getElementById("listaOutrosUniformes");
  if(!el) return;

  const tamanhos = Array.isArray(ctx?.tamanhos) ? ctx.tamanhos : ["PP","P","M","G","GG","XG","G1","G2","G3"];
  el.innerHTML = tamanhos.map(t=>{
    const T = String(t).toUpperCase();
    if(!formOutrosUni[T]) formOutrosUni[T] = { qtd:0, cor:"VERDE" };
    const st = formOutrosUni[T];

    return `
      <div class="othersUniRow">
        <div class="matName"><b>${esc(T)}</b></div>

        <input type="number" min="0" step="1" value="${esc(Number(st.qtd||0))}"
          oninput="formOutrosUni['${esc(T)}'].qtd = Math.max(0, Number(this.value)||0)">

        <select onchange="formOutrosUni['${esc(T)}'].cor = this.value">
          ${["VERDE","CINZA"].map(cor=>{
            const cur = String(st.cor||"VERDE").toUpperCase();
            return `<option value="${esc(cor)}" ${cur===cor?"selected":""}>${esc(cor)}</option>`;
          }).join("")}
        </select>

        <input value="OUTROS" disabled>
      </div>
    `;
  }).join("");
}

/* ==========================
   RENDER MATERIAIS
========================== */
function renderMateriais(){
  const el = document.getElementById("listaMateriais");
  if(!el) return;

  el.innerHTML = MATERIAIS_FIXOS.map(m=>{
    if(formMateriais[m] == null) formMateriais[m] = 0;
    return `
      <div class="qtyRow">
        <div class="matName">${esc(m)}</div>
        <input type="number" min="0" step="1" value="${esc(Number(formMateriais[m]||0))}"
          oninput="formMateriais['${esc(m)}'] = Math.max(0, Number(this.value)||0)">
      </div>
    `;
  }).join("");
}

function renderOutrosMateriais(){
  const el = document.getElementById("listaOutros");
  if(!el) return;

  el.innerHTML = formOutros.map((it, idx)=>{
    return `
      <div class="othersRow">
        <input placeholder="Nome do material" value="${esc(it.nome||"")}"
          oninput="formOutros[${idx}].nome = this.value">
        <input type="number" min="0" step="1" value="${esc(Number(it.qtd||0))}"
          oninput="formOutros[${idx}].qtd = Math.max(0, Number(this.value)||0)">
        <button class="iconBtn" onclick="formOutros[${idx}]={nome:'',qtd:0}; renderOutrosMateriais();">‚úï</button>
      </div>
    `;
  }).join("");
}

/* ==========================
   RENDER EPIs
========================== */
function renderEPIs(){
  const el = document.getElementById("listaEPIs");
  if(!el) return;

  // fixos (exceto botina multi)
  const fixos = EPIS_FIXOS.filter(x=> normKey(x) !== "BOTINA");
  const rowsFixos = fixos.map(e=>{
    if(formEPIs[e] == null) formEPIs[e] = 0;
    return `
      <div class="qtyRow">
        <div class="matName">${esc(e)}</div>
        <input type="number" min="0" step="1" value="${esc(Number(formEPIs[e]||0))}"
          oninput="formEPIs['${esc(e)}'] = Math.max(0, Number(this.value)||0)">
      </div>
    `;
  }).join("");

  // botina multi
  const botinaList = (botinaItens||[]).map((it, idx)=>{
    return `
      <div class="botinaInlineRow">
        <div class="matName"><b>Botina</b> ‚Äî Tam ${esc(it.tam)}</div>
        <input type="number" min="0" step="1" value="${esc(Number(it.qtd||0))}"
          oninput="botinaItens[${idx}].qtd = Math.max(0, Number(this.value)||0)">
        <button class="iconBtn" onclick="botinaItens.splice(${idx},1); renderEPIs();">‚úï</button>
      </div>
    `;
  }).join("");

  const botinaAdd = `
    <div class="botinaInlineRow">
      <input placeholder="Tamanho (ex: 38)" value="${esc(botinaTamInput||"")}"
        oninput="botinaTamInput=this.value">
      <input type="number" min="0" step="1" value="${esc(Number(botinaQtdInput||0))}"
        oninput="botinaQtdInput=Math.max(0, Number(this.value)||0)">
      <button class="botinaPlusBtn" onclick="addBotinaItem_()">Ôºã</button>
    </div>
    <div class="muted">Botina: voc√™ pode adicionar v√°rios tamanhos. (Se preferir, deixe tudo 0.)</div>
  `;

  el.innerHTML = `
    ${rowsFixos}
    <div class="supHeader">Botina (m√∫ltiplos tamanhos)<small>Adicione tamanhos e quantidades.</small></div>
    ${botinaList}
    ${botinaAdd}
  `;
}

function addBotinaItem_(){
  const t = String(botinaTamInput||"").trim();
  const q = Math.max(0, Number(botinaQtdInput||0));
  if(!t || q <= 0){
    showToast("Informe tamanho e quantidade da botina.");
    return;
  }
  const key = normKey(t);
  const idx = botinaItens.findIndex(x=> normKey(x.tam)===key);
  if(idx >= 0){
    botinaItens[idx].qtd = Math.max(0, Number(botinaItens[idx].qtd||0) + q);
  }else{
    botinaItens.push({ tam:t, qtd:q });
  }
  botinaTamInput = "";
  botinaQtdInput = 0;
  renderEPIs();
}

function renderOutrosEPIs(){
  const el = document.getElementById("listaOutrosEPIs");
  if(!el) return;

  el.innerHTML = formOutrosEPIs.map((it, idx)=>{
    return `
      <div class="othersRow">
        <input placeholder="Nome do EPI" value="${esc(it.nome||"")}"
          oninput="formOutrosEPIs[${idx}].nome = this.value">
        <input type="number" min="0" step="1" value="${esc(Number(it.qtd||0))}"
          oninput="formOutrosEPIs[${idx}].qtd = Math.max(0, Number(this.value)||0)">
        <button class="iconBtn" onclick="formOutrosEPIs[${idx}]={nome:'',qtd:0}; renderOutrosEPIs();">‚úï</button>
      </div>
    `;
  }).join("");
}

async function salvarUniformes(){
  const sup = String(selectedSup.uniformes||"").trim() || "SEM SUPERVIS√ÉO";

  const payload = {
    tipo: "uniformes",
    modo: modo.uniformes,
    supervisao: sup,
    itens: [],
    outros: formOutrosUni
  };

  const list = listColsBySup_(sup).sort((a,b)=> normKey(a.colaborador).localeCompare(normKey(b.colaborador)));
  list.forEach(c=>{
    const nome = String(c?.colaborador||"").trim();
    const k = colKey_(nome);
    const st = formUniformes[k];
    if(!st || !st.on) return;
    payload.itens.push({
      colaborador: nome,
      tamanho: String(st.tamanho||"M").toUpperCase(),
      qtd: Number(st.qtd||1)||1,
      cor: String(st.cor||"VERDE").toUpperCase()
    });
  });

  document.getElementById("saveStatusUniformes").innerText = "Salvando...";
  setBusy(true);

  // ‚úÖ AQUI: envia dentro de payload:
  const res = await api("salvarPedido", { payload });

  setBusy(false);

  if(!res || !res.ok){
    const msg = res?.error || "Erro ao salvar.";
    document.getElementById("saveStatusUniformes").innerText = msg;
    showToast(msg);

    // ‚úÖ ajuda MUITO pra descobrir o motivo:
    console.log("SALVAR UNIFORMES -> resposta:", res);
    return;
  }

  document.getElementById("saveStatusUniformes").innerText = "Salvo com sucesso.";
  showToast("Salvo!");
  await refreshUltimoPDF("uniformes");
}
async function salvarMateriais(){
  const sup = String(selectedSup.materiais||"").trim() || "SEM SUPERVIS√ÉO";

  const itens = [];
  MATERIAIS_FIXOS.forEach(m=>{
    const q = Math.max(0, Number(formMateriais[m]||0));
    if(q>0) itens.push({ material:m, un:q });
  });

  formOutros.forEach(o=>{
    const nome = String(o.nome||"").trim();
    const q = Math.max(0, Number(o.qtd||0));
    if(nome && q>0) itens.push({ material:nome, un:q });
  });

  const payload = { tipo:"materiais", modo:modo.materiais, supervisao:sup, itens };

  document.getElementById("saveStatusMateriais").innerText = "Salvando...";
  setBusy(true);

  const res = await api("salvarPedido", { payload }); // ‚úÖ

  setBusy(false);

  if(!res || !res.ok){
    const msg = res?.error || "Erro ao salvar.";
    document.getElementById("saveStatusMateriais").innerText = msg;
    showToast(msg);
    console.log("SALVAR MATERIAIS -> resposta:", res);
    return;
  }

  document.getElementById("saveStatusMateriais").innerText = "Salvo com sucesso.";
  showToast("Salvo!");
  await refreshUltimoPDF("materiais");
}
async function salvarEPIs(){
  const sup = String(selectedSup.epis||"").trim() || "SEM SUPERVIS√ÉO";

  const itens = [];

  EPIS_FIXOS.forEach(e=>{
    if(normKey(e)==="BOTINA") return;
    const q = Math.max(0, Number(formEPIs[e]||0));
    if(q>0) itens.push({ epi:e, un:q });
  });

  (botinaItens||[]).forEach(b=>{
    const t = String(b.tam||"").trim();
    const q = Math.max(0, Number(b.qtd||0));
    if(t && q>0) itens.push({ epi:"Botina", tamanho:t, un:q });
  });

  const outros = [];
  formOutrosEPIs.forEach(o=>{
    const nome = String(o.nome||"").trim();
    const q = Math.max(0, Number(o.qtd||0));
    if(nome && q>0) outros.push({ nome, un:q });
  });

  const payload = { tipo:"epis", modo:modo.epis, supervisao:sup, itens, outros };

  document.getElementById("saveStatusEPIs").innerText = "Salvando...";
  setBusy(true);

  const res = await api("salvarPedido", { payload }); // ‚úÖ

  setBusy(false);

  if(!res || !res.ok){
    const msg = res?.error || "Erro ao salvar.";
    document.getElementById("saveStatusEPIs").innerText = msg;
    showToast(msg);
    console.log("SALVAR EPIs -> resposta:", res);
    return;
  }

  document.getElementById("saveStatusEPIs").innerText = "Salvo com sucesso.";
  showToast("Salvo!");
  await refreshUltimoPDF("epis");
}

  if(!res || !res.ok){
    document.getElementById("saveStatusEPIs").innerText = res?.error || "Erro ao salvar.";
    showToast("Erro ao salvar.");
    return;
  }

  document.getElementById("saveStatusEPIs").innerText = "Salvo com sucesso.";
  showToast("Salvo!");
  await refreshUltimoPDF("epis");
}

/* ==========================
   PATRIM√îNIOS (igual ao seu)
========================== */
async function goPatrimonios(){
  hide("screenMenu"); hide("screenUniformes"); hide("screenMateriais"); hide("screenEPIs"); show("screenPatrimonios");
  document.getElementById("patStatus").innerText = "";
  document.getElementById("patContent").innerHTML = "";
  await loadAndRenderPatrimonios();
  setBottomActions(`
    <button class="secondary" onclick="bootstrap()">Recarregar</button>
    <button class="secondary" onclick="refreshPatrimonios()">Atualizar Patrim√¥nios</button>
  `);
}

function setPatViewButtons_(){
  const b1 = document.getElementById("btnPatTab");
  const b2 = document.getElementById("btnPatGrp");
  if(!b1 || !b2) return;
  b1.classList.toggle("active", patView==="TABELA");
  b2.classList.toggle("active", patView==="AGRUPADO");
}

function setPatView(v){
  patView = (v==="AGRUPADO") ? "AGRUPADO" : "TABELA";
  setPatViewButtons_();
  renderPatrimoniosFromCache_();
}

async function refreshPatrimonios(){
  const sup = String(selectedSup.patrimonios||"").trim() || "SEM SUPERVIS√ÉO";
  const key = normKey(sup||"SEM SUPERVIS√ÉO");
  delete patCacheBySup[key];
  await loadAndRenderPatrimonios();
}

async function loadAndRenderPatrimonios(){
  if(!ctx) return;

  const supSel = String(selectedSup.patrimonios||"").trim() || "SEM SUPERVIS√ÉO";
  const key = normKey(supSel||"SEM SUPERVIS√ÉO");

  if(patCacheBySup[key]){
    renderPatrimonios_(patCacheBySup[key], supSel);
    return;
  }

  document.getElementById("patStatus").innerText = "Carregando patrim√¥nios...";
  document.getElementById("patContent").innerHTML = "";

  setBusy(true);
  const res = await api("carregarPatrimonios", { payload: { supervisao: supSel } });
  setBusy(false);

  if(!res || !res.ok){
    document.getElementById("patStatus").innerText = res?.error || "Erro ao carregar patrim√¥nios.";
    return;
  }

  const itens = Array.isArray(res.itens) ? res.itens : [];
  patCacheBySup[key] = itens;

  renderPatrimonios_(itens, supSel);
}

function renderPatrimoniosFromCache_(){
  const supSel = String(selectedSup.patrimonios||"").trim() || "SEM SUPERVIS√ÉO";
  const key = normKey(supSel||"SEM SUPERVIS√ÉO");
  const itens = patCacheBySup[key] || [];
  renderPatrimonios_(itens, supSel);
}

function pickAny_(obj, keys){
  for(const k of keys){
    if(obj && Object.prototype.hasOwnProperty.call(obj, k)){
      const v = obj[k];
      if(v !== null && v !== undefined && String(v).trim() !== "") return v;
    }
  }
  return "";
}
function parseDias_(v){
  const s = String(v ?? "").trim().replace(",", ".");
  const n = parseFloat(s.replace(/[^\d.-]/g,""));
  return isNaN(n) ? 0 : Math.round(n);
}
function parseDMY_(s){
  const m = String(s||"").trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if(!m) return null;
  const dd = parseInt(m[1],10), mm = parseInt(m[2],10), yy = parseInt(m[3],10);
  const d = new Date(yy, mm-1, dd);
  if(d && d.getFullYear()===yy && d.getMonth()===(mm-1) && d.getDate()===dd) return d;
  return null;
}
function daysDiffFromToday_(d){
  if(!d) return 0;
  const today = new Date();
  const a = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const b = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const ms = a.getTime() - b.getTime();
  return Math.max(0, Math.floor(ms / 86400000));
}
function safeStr_(v){
  const s = String(v||"").trim();
  return s || "-";
}

function renderPatrimonios_(itens, supSel){
  const elStatus = document.getElementById("patStatus");
  const el = document.getElementById("patContent");

  const list = (itens||[])
    .map(x=>{
      const patrimonio = String(pickAny_(x, ["patrimonio","Patrim√¥nio","Patrimonio","N¬∫ Patrim√¥nio","Numero Patrimonio"]) || "").trim();
      const funcionario = String(pickAny_(x, ["funcionario","Funcion√°rio","Funcionario","Colaborador","Nome"]) || "").trim();
      const identificacao = String(pickAny_(x, ["identificacao","Identifica√ß√£o","Identificacao","Descri√ß√£o","Descricao","Item"]) || "").trim();

      const ultimaLeituraRaw = pickAny_(x, ["ultimaLeitura","Ultima Leitura","√öltima Leitura","Ultima leitura","√öltima leitura","Data √∫ltima leitura","Data ultima leitura"]);
      const ultimaLeitura = safeStr_(ultimaLeituraRaw);

      const diasRaw = pickAny_(x, [
        "diasSemLeitura","dias_sem_leitura",
        "Dias sem Leitura",
        "Dias Sem Leitura",
        "Dias sem leitura",
        "DIAS SEM LEITURA",
        "Dias_sem_Leitura",
        "Dias_sem_leitura"
      ]);

      let diasSemLeitura = parseDias_(diasRaw);

      if(!diasSemLeitura && ultimaLeitura && ultimaLeitura !== "-"){
        const d = parseDMY_(ultimaLeitura);
        diasSemLeitura = daysDiffFromToday_(d);
      }

      return { patrimonio, funcionario, identificacao, ultimaLeitura, diasSemLeitura };
    })
    .filter(x=> x.patrimonio || x.identificacao || x.funcionario);

  elStatus.innerText = list.length
    ? `Encontrados ${list.length} patrim√¥nios para: ${supSel}`
    : `Nenhum patrim√¥nio encontrado para: ${supSel}`;

  if(!list.length){
    el.innerHTML = `<div class="muted">Sem registros.</div>`;
    return;
  }

  if(patView === "TABELA"){
    const tableList = list.slice().sort((a,b)=>{
      const d = (b.diasSemLeitura||0) - (a.diasSemLeitura||0);
      if(d!==0) return d;
      const n = normKey(a.funcionario).localeCompare(normKey(b.funcionario));
      if(n!==0) return n;
      return normKey(a.patrimonio).localeCompare(normKey(b.patrimonio));
    });

    const rows = tableList.map(it=>{
      const danger = (it.diasSemLeitura||0) > 10;
      const chip = `<span class="chip ${danger?'danger':''}">${danger ? '‚ö†Ô∏è ' : ''}${esc(it.diasSemLeitura)} dia(s)</span>`;
      return `
        <tr style="${danger ? 'outline:2px solid #fecaca; outline-offset:-2px;' : ''}">
          <td><b>${esc(it.patrimonio||"-")}</b></td>
          <td>${esc(it.identificacao||"-")}</td>
          <td>${esc(it.funcionario||"-")}</td>
          <td>${esc(it.ultimaLeitura||"-")}</td>
          <td>${chip}</td>
        </tr>
      `;
    }).join("");

    el.innerHTML = `
      <table class="table">
        <thead>
          <tr>
            <th style="width:16%;">Patrim√¥nio</th>
            <th style="width:34%;">Descri√ß√£o</th>
            <th style="width:22%;">Colaborador</th>
            <th style="width:14%;">√öltima leitura</th>
            <th style="width:14%;">Dias sem leitura</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
      <div class="muted" style="margin-top:8px;">Regra: Dias sem leitura &gt; 10 = destaque vermelho.</div>
    `;
    return;
  }

  const listForGroup = list.slice().sort((a,b)=>{
    const n = normKey(a.funcionario).localeCompare(normKey(b.funcionario));
    if(n!==0) return n;
    return normKey(a.patrimonio).localeCompare(normKey(b.patrimonio));
  });

  const grp = new Map();
  listForGroup.forEach(it=>{
    const k = it.funcionario || "SEM FUNCION√ÅRIO";
    if(!grp.has(k)) grp.set(k, []);
    grp.get(k).push(it);
  });

  const nomes = Array.from(grp.keys()).sort((a,b)=> normKey(a).localeCompare(normKey(b)));

  const cards = nomes.map(nome=>{
    const arr = (grp.get(nome) || []).slice();
    arr.sort((a,b)=>
      ((b.diasSemLeitura||0) - (a.diasSemLeitura||0)) ||
      normKey(a.patrimonio).localeCompare(normKey(b.patrimonio))
    );

    const maxDias = arr.reduce((m,x)=> Math.max(m, x.diasSemLeitura||0), 0);
    const headerChip = `<span class="chip ${maxDias>10?'danger':''}">${maxDias>10?'‚ö†Ô∏è ':''}M√°x: ${esc(maxDias)} dia(s)</span>`;
    const openAttr = (maxDias > 10) ? "open" : "";

    const itensHtml = arr.map(it=>{
      const danger = (it.diasSemLeitura||0) > 10;
      const chip = `<span class="chip ${danger?'danger':''}">${danger ? '‚ö†Ô∏è ' : ''}${esc(it.diasSemLeitura)} dia(s)</span>`;
      return `
        <div class="patItem">
          <div class="num">${esc(it.patrimonio||"-")}</div>
          <div class="desc">
            <div><b>${esc(it.identificacao||"-")}</b></div>
            <div class="mut">${esc(it.funcionario||"")}</div>
          </div>
          <div class="right">
            <div class="mut">√öltima leitura</div>
            <div><b>${esc(it.ultimaLeitura||"-")}</b></div>
          </div>
          <div class="right">
            <div class="mut">Dias</div>
            <div>${chip}</div>
          </div>
        </div>
      `;
    }).join("");

    return `
      <details class="patAcc" ${openAttr}>
        <summary>
          <div class="left">
            <div>üë§ ${esc(nome)}</div>
            <div class="meta">${esc(arr.length)} item(ns)</div>
          </div>
          <div class="right">
            ${headerChip}
            <span class="chip">Clique p/ ver</span>
          </div>
        </summary>
        <div class="body">
          <div class="divider"></div>
          ${itensHtml}
        </div>
      </details>
    `;
  }).join("");

  el.innerHTML = `
    ${cards}
    <div class="muted" style="margin-top:8px;">Regra: Dias sem leitura &gt; 10 = destaque vermelho.</div>
  `;
}

/* ==========================
   SUP / MODO
========================== */
function onChangeSup(tipo){
  if(tipo==="uniformes") selectedSup.uniformes = document.getElementById("uniSup").value;
  if(tipo==="materiais") selectedSup.materiais = document.getElementById("matSup").value;
  if(tipo==="epis") selectedSup.epis = document.getElementById("epiSup").value;

  if(tipo==="patrimonios"){
    selectedSup.patrimonios = document.getElementById("patSup").value;
    loadAndRenderPatrimonios();
    return;
  }
  onChangeModo(tipo);
}

async function onChangeModo(tipo){
  if(tipo==="uniformes") modo.uniformes = document.getElementById("uniModo").value;
  if(tipo==="materiais") modo.materiais = document.getElementById("matModo").value;
  if(tipo==="epis") modo.epis = document.getElementById("epiModo").value;

  // Se estiver ATUALIZAR, tenta carregar o √∫ltimo pedido
  if((tipo==="uniformes" && modo.uniformes==="ATUALIZAR") ||
     (tipo==="materiais" && modo.materiais==="ATUALIZAR") ||
     (tipo==="epis" && modo.epis==="ATUALIZAR")){
    await carregarUltimoPedido(tipo);
  }else{
    await refreshUltimoPDF(tipo);
  }

  if(tipo==="uniformes"){ renderUniformes(); renderOutrosUniformes(); }
  if(tipo==="materiais"){ renderMateriais(); renderOutrosMateriais(); }
  if(tipo==="epis"){ renderEPIs(); renderOutrosEPIs(); }
}

/* ==========================
   CARREGAR √öLTIMO PEDIDO (AJUSTADO)
   - uniformes agora usa chave normalizada
========================== */
async function carregarUltimoPedido(tipo){
  if(!ctx) return;

  const sup = tipo==="uniformes" ? selectedSup.uniformes : (tipo==="materiais" ? selectedSup.materiais : selectedSup.epis);
  setBusy(true);
  const res = await api("carregarUltimoPedido", { payload:{ tipo, supervisao: sup } });
  setBusy(false);

  if(!res || !res.ok){
    showToast(res?.error || "N√£o foi poss√≠vel carregar o √∫ltimo pedido.");
    await refreshUltimoPDF(tipo);
    return;
  }

  lastPedido[tipo] = res.last || null;

  if(tipo==="uniformes"){
    const data = res.last?.data || null;
    if(data){
      (data.itens||[]).forEach(it=>{
        const nome = String(it.colaborador||"").trim();
        const k = colKey_(nome);
        if(!k) return;
        if(!formUniformes[k]) formUniformes[k] = { nome, on:true, tamanho:"M", qtd:1, cor:"VERDE" };

        formUniformes[k].on = true;
        formUniformes[k].tamanho = (it.tamanho||"M").toUpperCase();
        formUniformes[k].qtd = Number(it.qtd||1)||1;
        formUniformes[k].cor = (it.cor||"VERDE").toUpperCase();
      });

      const tamanhos = Array.isArray(ctx?.tamanhos) ? ctx.tamanhos : ["PP","P","M","G","GG","XG","G1","G2","G3"];
      tamanhos.forEach(t=>{
        const T = String(t).toUpperCase();
        const x = (data.outros||{})[T];
        if(x){
          formOutrosUni[T] = { qtd:Number(x.qtd||0)||0, cor:(x.cor||"VERDE").toUpperCase() };
        }else{
          formOutrosUni[T] = { qtd:0, cor:"VERDE" };
        }
      });
    }
  }

  if(tipo==="materiais"){
    const data = res.last?.data || null;
    if(data){
      MATERIAIS_FIXOS.forEach(m=> formMateriais[m]=0);
      formOutros = [{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0}];

      const itens = data.itens||[];
      let outrosIdx = 0;
      itens.forEach(it=>{
        const nome = String(it.material||"").trim();
        const qtd = Number(it.un||0)||0;
        const found = MATERIAIS_FIXOS.find(x=> normKey(x)===normKey(nome));
        if(found){
          formMateriais[found] = qtd;
        }else if(outrosIdx < formOutros.length){
          formOutros[outrosIdx] = { nome, qtd };
          outrosIdx++;
        }
      });
    }
  }

  if(tipo==="epis"){
    const data = res.last?.data || null;
    if(data){
      EPIS_FIXOS.forEach(e=> formEPIs[e]=0);
      botinaItens=[]; botinaTamInput=""; botinaQtdInput=0;
      formOutrosEPIs = [{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0},{nome:"",qtd:0}];

      const itens = data.itens||[];
      const outros = data.outros||[];

      itens.forEach(it=>{
        if(normKey(it.epi)==="BOTINA"){
          if(it.tamanho){
            botinaItens.push({ tam:String(it.tamanho), qtd:Number(it.un||0)||0 });
          }
        }else{
          const key = EPIS_FIXOS.find(x=> normKey(x)===normKey(it.epi));
          if(key) formEPIs[key] = Number(it.un||0)||0;
        }
      });

      outros.slice(0,4).forEach((o,i)=>{
        formOutrosEPIs[i] = { nome:String(o.nome||""), qtd:Number(o.un||0)||0 };
      });
    }
  }

  await refreshUltimoPDF(tipo);
}

/* ==========================
   √öLTIMO PDF
========================== */
async function refreshUltimoPDF(tipo){
  const sup = tipo==="uniformes" ? selectedSup.uniformes : (tipo==="materiais" ? selectedSup.materiais : selectedSup.epis);
  const res = await api("carregarUltimoPDF", { payload:{ tipo, supervisao: sup } });
  const pdfUrl = res?.ok ? (res.pdfUrl||"") : "";

  const targetTop = tipo==="uniformes" ? "pdfAreaUniformesTop" : (tipo==="materiais" ? "pdfAreaMateriaisTop" : "pdfAreaEPIsTop");
  const el = document.getElementById(targetTop);
  if(!el) return;

  if(pdfUrl){
    el.innerHTML = `<a href="${esc(pdfUrl)}" target="_blank">üìÑ √öltimo PDF desta supervis√£o</a>
                    <div class="muted">Se estiver em modo Atualizar, ao salvar ele substitui o √∫ltimo pedido.</div>`;
  }else{
    el.innerHTML = `<div class="muted">Nenhum PDF encontrado para esta supervis√£o.</div>`;
  }
}

/* init */
window.onload = async ()=>{
  const pin = document.getElementById("pin");
  pin.addEventListener("input", ()=> pin.value = onlyDigits(pin.value).slice(0,4));
  pin.addEventListener("keydown", (e)=>{ if(e.key==="Enter") login(); });

  show("loginCard");
  hide("app"); hide("bottomBar");

  if(token){
    const p = await api("ping", {});
    if(p && p.ok){
      hide("loginCard"); show("app"); show("bottomBar");
      await bootstrap();
    }else{
      logout();
    }
  }
};
</script>
</body>
</html>
