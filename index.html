<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gestor ‚Äì Uniformes e Materiais</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    body{ margin:0; font-family:Arial,sans-serif; background:#f5f6f7; }
    .wrap{ max-width:1100px; margin:auto; padding:14px 14px 120px; }
    .card{ background:#fff; border-radius:14px; padding:14px; margin-bottom:12px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    h2,h3{ margin:0 0 8px; }
    .muted{ color:#6b7280; font-size:12px; white-space:pre-line; }
    input,select,button{ width:100%; padding:10px; border-radius:12px; border:1px solid #d1d5db; font-size:14px; box-sizing:border-box; }
    button{ cursor:pointer; border:none; background:#166534; color:#fff; font-weight:800; }
    button.secondary{ background:#374151; }
    button.danger{ background:#111827; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1; min-width:220px; }

    .pill{ display:inline-block; padding:4px 10px; background:#e0f2fe; border-radius:999px; font-size:12px; margin-top:6px; }

    .topbar{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .logoutBtn{ width:auto; padding:9px 14px; border-radius:999px; background:#111827; }

    .list{ margin-top:10px; }

    .item{
      display:grid;
      grid-template-columns: 1fr 220px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .item:last-child{ border-bottom:none; }
    .nm{ font-weight:800; font-size:13px; }
    .sub{ font-size:11px; color:#6b7280; margin-top:2px; }

    /* ‚úÖ Cabe√ßalho/Separador por Supervis√£o */
    .supHeader{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      background:#f0fdf4;
      border:1px solid #dcfce7;
      font-weight:900;
      color:#166534;
      font-size:13px;
    }
    .supHeader small{
      display:block;
      margin-top:3px;
      font-weight:700;
      color:#6b7280;
      font-size:11px;
    }

    .bottomBar{ position:fixed; left:0; right:0; bottom:0; background:#f5f6f7; border-top:1px solid #e5e7eb; padding:10px; }
    .bottomBar .inner{ max-width:1100px; margin:auto; display:flex; gap:10px; flex-wrap:wrap; }
    .bottomBar .inner button{ width:auto; min-width:160px; }

    .pdfArea a{ display:inline-block; margin-top:8px; font-weight:800; color:#166534; text-decoration:none; }

    .menuGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(220px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .menuBtn{
      padding:16px;
      border-radius:14px;
      background:#166534;
      color:#fff;
      font-weight:900;
      text-align:left;
      box-shadow:0 1px 3px rgba(0,0,0,.06);
    }
    .menuBtn .small{
      display:block;
      font-weight:600;
      opacity:.9;
      margin-top:6px;
      font-size:12px;
    }
    .menuBtn.secondary{ background:#0f172a; }

    .qtyRow{
      display:grid;
      grid-template-columns: 1fr 120px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .qtyRow:last-child{ border-bottom:none; }
    .qtyRow .matName{ font-weight:800; font-size:13px; }
    .qtyRow input[type="number"]{ text-align:center; }

    .othersRow{
      display:grid;
      grid-template-columns: 1fr 120px 42px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .othersRow:last-child{ border-bottom:none; }

    .iconBtn{
      width:42px;
      height:42px;
      border-radius:12px;
      background:#374151;
      color:#fff;
      font-weight:900;
    }

    /* OUTROS UNIFORMES: OUTROS fixo + tamanho fixo + unidade */
    .othersUniRow{
      display:grid;
      grid-template-columns: 1fr 120px 120px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .othersUniRow:last-child{ border-bottom:none; }
    .othersUniRow input[disabled], .othersUniRow select[disabled]{
      background:#f3f4f6;
      color:#111827;
      opacity:1;
      cursor:not-allowed;
    }
    .othersUniRow input[type="number"]{ text-align:center; }

    /* ‚úÖ EPIs - Botina: tamanho + un + bot√£o "+" NA MESMA LINHA */
    .botinaInlineRow{
      display:grid;
      grid-template-columns: 1fr 120px 52px;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .botinaInlineRow:last-child{ border-bottom:none; }
    .botinaInlineRow input[type="number"]{ text-align:center; }
    .botinaPlusBtn{
      width:52px;
      height:42px;
      border-radius:12px;
      background:#166534;
      color:#fff;
      font-weight:900;
    }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:86px; transform:translateX(-50%);
      background:#111827; color:#fff;
      padding:10px 14px; border-radius:999px;
      box-shadow:0 8px 24px rgba(0,0,0,.18);
      font-size:13px; font-weight:800;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      max-width: calc(100% - 24px);
      text-align:center;
      z-index:9999;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }

    @media (max-width: 720px){
      .wrap{ padding:12px 10px 110px; }
      .item{ grid-template-columns: 1fr; }
      .col{ min-width:160px; }
      .menuGrid{ grid-template-columns: 1fr; }
      .othersUniRow{ grid-template-columns: 1fr; }
      .othersRow{ grid-template-columns: 1fr; }
      .qtyRow{ grid-template-columns: 1fr; }
      .botinaInlineRow{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h2>Login do Gestor</h2>
    <div class="muted">Informe seu <b>PIN (4 d√≠gitos)</b> (aba Gestores).</div>

    <div class="row" style="margin-top:10px;">
      <div class="col">
        <input id="pin" placeholder="PIN" inputmode="numeric" maxlength="4" autocomplete="off">
      </div>
      <div class="col">
        <button id="btnLogin" onclick="login()">Entrar</button>
      </div>
    </div>

    <div id="loginStatus" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;">

    <!-- HEADER -->
    <div class="card">
      <div class="topbar">
        <div>
          <h3 style="margin:0;">Portal do Gestor</h3>
          <div id="topInfo" class="muted" style="margin-top:4px;"></div>
          <div id="dataInfo" class="muted"></div>
        </div>
        <button class="logoutBtn" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- MENU -->
    <div id="screenMenu" class="card">
      <h3>Escolha uma op√ß√£o</h3>
      <div class="muted">Selecione o que deseja registrar.</div>

      <div class="menuGrid">
        <button class="menuBtn" onclick="goUniformes()">
          üëï Uniformes
          <span class="small">Registre tamanhos por colaborador, OUTROS por tamanho e gere PDF.</span>
        </button>

        <button class="menuBtn secondary" onclick="goMateriais()">
          üß∞ Materiais
          <span class="small">Solicite materiais com quantidade e envie para a planilha.</span>
        </button>

        <button class="menuBtn secondary" onclick="goEPIs()">
          ü¶∫ EPI's
          <span class="small">Solicite EPIs com quantidade, Botina com v√°rios tamanhos e 4 OUTROS.</span>
        </button>
      </div>
    </div>

    <!-- UNIFORMES -->
    <div id="screenUniformes" class="card" style="display:none;">
      <div class="row" style="align-items:center;">
        <div class="col">
          <h3>Uniformes</h3>
          <div class="muted">Defina o tamanho por colaborador.</div>
        </div>
        <div class="col" style="max-width:220px;">
          <button class="secondary" onclick="goMenu()">‚¨ÖÔ∏è Voltar</button>
        </div>
      </div>

      <div class="list" id="listaUniformes"></div>

      <h3 style="margin-top:14px;">OUTROS (novas contrata√ß√µes)</h3>
      <div class="muted">Informe apenas a <b>unidade</b> por tamanho (OUTROS √© fixo).</div>
      <div class="list" id="listaOutrosUniformes"></div>

      <div class="pdfArea" id="pdfArea"></div>
      <div id="saveStatusUniformes" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- MATERIAIS -->
    <div id="screenMateriais" class="card" style="display:none;">
      <div class="row" style="align-items:center;">
        <div class="col">
          <h3>Materiais</h3>
          <div class="muted">Informe a quantidade para cada material (0 = n√£o solicitar).</div>
        </div>
        <div class="col" style="max-width:220px;">
          <button class="secondary" onclick="goMenu()">‚¨ÖÔ∏è Voltar</button>
        </div>
      </div>

      <div id="listaMateriais" class="list"></div>

      <h3 style="margin-top:14px;">Outros (at√© 5)</h3>
      <div class="muted">Preencha o nome do material e a quantidade. Deixe em branco se n√£o usar.</div>
      <div id="listaOutros" class="list"></div>

      <div id="saveStatusMateriais" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- EPIs -->
    <div id="screenEPIs" class="card" style="display:none;">
      <div class="row" style="align-items:center;">
        <div class="col">
          <h3>EPI's</h3>
          <div class="muted">Informe as quantidades (0 = n√£o solicitar). Botina permite v√°rios tamanhos.</div>
        </div>
        <div class="col" style="max-width:220px;">
          <button class="secondary" onclick="goMenu()">‚¨ÖÔ∏è Voltar</button>
        </div>
      </div>

      <div id="listaEPIs" class="list"></div>

      <h3 style="margin-top:14px;">Outros (4)</h3>
      <div class="muted">Preencha o nome do EPI e a quantidade. Deixe em branco se n√£o usar.</div>
      <div id="listaOutrosEPIs" class="list"></div>

      <div id="saveStatusEPIs" class="muted" style="margin-top:8px;"></div>
    </div>

  </div>
</div>

<div class="bottomBar" id="bottomBar" style="display:none;">
  <div class="inner" id="bottomActions"></div>
</div>

<div id="toast" class="toast"></div>

<script>
/**
 * ‚úÖ URL do Worker publicado (mantenha com / no final)
 */
const API_BASE = "https://uniformes-e-materiais.tecnologia-f0c.workers.dev/";

let token = localStorage.getItem("TAM_TOKEN") || "";
let ctx = null;

// uniformes (por colaborador)
let formUniformes = {};

// materiais
const MATERIAIS_FIXOS = [
  "balan√ßa",
  "impressora de laudo",
  "calador",
  "kit peneiras",
  "quarteador",
  "micropipeta",
  "alicate de corte"
];
let formMateriais = {};
let formOutros = [
  { nome:"", qtd:0 },
  { nome:"", qtd:0 },
  { nome:"", qtd:0 },
  { nome:"", qtd:0 },
  { nome:"", qtd:0 }
];

// OUTROS uniformes
let formOutrosQtd = {};

// EPIs
const EPIS_FIXOS = [
  "Capacete",
  "Protetor auricular",
  "√ìculos Transparente",
  "Luva PU",
  "Mascara PFF2",
  "Botina"
];
let formEPIs = {};
let botinaItens = []; // [{tam:"40", qtd:2}, ...]
let botinaTamInput = "";
let botinaQtdInput = 0;

let formOutrosEPIs = [
  { nome:"", qtd:0 },
  { nome:"", qtd:0 },
  { nome:"", qtd:0 },
  { nome:"", qtd:0 }
];

function onlyDigits(s){ return String(s||"").replace(/\D/g,""); }
function esc(s){ return String(s||"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

function show(id){ document.getElementById(id).style.display="block"; }
function hide(id){ document.getElementById(id).style.display="none"; }

function normKey(s){
  return String(s||"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .trim()
    .toUpperCase();
}
function isSemSup_(s){
  const raw = String(s||"").trim();
  return (!raw || normKey(raw) === normKey("SEM SUPERVIS√ÉO"));
}
/** Ordena: Supervis√£o (A-Z, SEM SUPERVIS√ÉO por √∫ltimo) + Nome (A-Z) */
function sortColabsBySupThenName(arr){
  return (Array.isArray(arr) ? [...arr] : []).sort((a,b)=>{
    const saRaw = String(a?.supervisao || "").trim();
    const sbRaw = String(b?.supervisao || "").trim();

    const sa = isSemSup_(saRaw) ? "ZZZ" : normKey(saRaw);
    const sb = isSemSup_(sbRaw) ? "ZZZ" : normKey(sbRaw);

    if(sa !== sb) return sa.localeCompare(sb);

    const na = normKey(a?.colaborador || "");
    const nb = normKey(b?.colaborador || "");
    return na.localeCompare(nb);
  });
}

let toastTimer = null;
function showToast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg || "Conclu√≠do!";
  el.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> el.classList.remove("show"), 2600);
}

function setBusy(v){
  const b = !!v;
  ["btnLogin"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.disabled = b;
  });

  const btns = document.querySelectorAll("#bottomActions button");
  btns.forEach(x => x.disabled = b);
}

function setBottomActions(html){
  document.getElementById("bottomActions").innerHTML = html || "";
}

async function api(action, args){
  const payload = { action, ...(args||{}) };
  if(token && !payload.token && action !== "loginPIN"){
    payload.token = token;
  }

  let txt = "";
  try{
    const res = await fetch(API_BASE, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    txt = await res.text();
  }catch(e){
    return { ok:false, error:"Falha de rede / CORS", raw:String(e) };
  }

  try{ return JSON.parse(txt); }
  catch(e){ return { ok:false, error:"Resposta inv√°lida do servidor", raw:txt }; }
}

function logout(){
  localStorage.removeItem("TAM_TOKEN");
  token = "";
  ctx = null;

  formUniformes = {};

  formMateriais = {};
  MATERIAIS_FIXOS.forEach(m => formMateriais[m] = 0);
  formOutros = [
    { nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 }
  ];

  formOutrosQtd = {};

  formEPIs = {};
  EPIS_FIXOS.forEach(e => formEPIs[e] = 0);
  botinaItens = [];
  botinaTamInput = "";
  botinaQtdInput = 0;
  formOutrosEPIs = [
    { nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 }
  ];

  document.getElementById("loginStatus").innerText = "Fa√ßa login novamente.";
  hide("app"); hide("bottomBar"); show("loginCard");
}

async function login(){
  const pin = onlyDigits(document.getElementById("pin").value).slice(0,4);
  if(pin.length < 4){
    document.getElementById("loginStatus").innerText = "Informe 4 d√≠gitos.";
    return;
  }

  setBusy(true);
  document.getElementById("loginStatus").innerText = "Entrando...";

  const out = await api("loginPIN", { pin });
  setBusy(false);

  if(!out || !out.ok){
    document.getElementById("loginStatus").innerText = out?.error || "Erro";
    return;
  }

  token = out.token;
  localStorage.setItem("TAM_TOKEN", token);

  hide("loginCard");
  show("app");
  show("bottomBar");
  document.getElementById("loginStatus").innerText = "";

  await bootstrap();
}

async function bootstrap(){
  setBusy(true);
  const res = await api("carregarListaRecente", {});
  setBusy(false);

  if(!res || !res.ok){
    alert(res?.error || "Erro ao carregar dados do gestor.");
    logout();
    return;
  }

  ctx = res;
  const g = res.gestor || {};

  const supTxt = (Array.isArray(g.supervisoesLiberadas) && g.supervisoesLiberadas.length)
    ? g.supervisoesLiberadas.join("; ")
    : "(todas)";

  document.getElementById("topInfo").innerText =
    `Gestor: ${g.nome||"GESTOR"} | Coordena√ß√£o: ${g.coordenacao||"-"} | Supervis√µes liberadas: ${supTxt}`;

  document.getElementById("dataInfo").innerHTML =
    `<span class="pill">Data mais recente do hist√≥rico: <b>${esc(res.dataRef||"")}</b></span>`;

  // uniformes default
  formUniformes = {};
  const cols = Array.isArray(res.colaboradores) ? res.colaboradores : [];
  cols.forEach(c=>{
    formUniformes[c.colaborador] = { tamanho: "M", supervisao: c.supervisao || "" };
  });

  // OUTROS uniformes
  const tamanhos = Array.isArray(res.tamanhos) ? res.tamanhos : ["PP","P","M","G","GG","XG","G1","G2","G3"];
  formOutrosQtd = {};
  tamanhos.forEach(t => formOutrosQtd[String(t).toUpperCase()] = 0);

  // materiais default
  formMateriais = {};
  MATERIAIS_FIXOS.forEach(m => formMateriais[m] = 0);

  // EPIs default
  formEPIs = {};
  EPIS_FIXOS.forEach(e => formEPIs[e] = 0);
  botinaItens = [];
  botinaTamInput = "";
  botinaQtdInput = 0;
  formOutrosEPIs = [
    { nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 }
  ];

  goMenu();
}

/** navega√ß√£o */
function goMenu(){
  show("screenMenu");
  hide("screenUniformes");
  hide("screenMateriais");
  hide("screenEPIs");

  setBottomActions(`
    <button class="secondary" onclick="bootstrap()">Recarregar</button>
  `);
}

function goUniformes(){
  hide("screenMenu");
  show("screenUniformes");
  hide("screenMateriais");
  hide("screenEPIs");

  renderUniformes();

  setBottomActions(`
    <button class="secondary" onclick="bootstrap()">Recarregar</button>
    <button onclick="salvarUniformes()">Salvar e Gerar PDF</button>
  `);
}

function goMateriais(){
  hide("screenMenu");
  hide("screenUniformes");
  show("screenMateriais");
  hide("screenEPIs");

  renderMateriais();

  setBottomActions(`
    <button class="secondary" onclick="bootstrap()">Recarregar</button>
    <button onclick="salvarMateriais()">Enviar Solicita√ß√£o</button>
  `);
}

function goEPIs(){
  hide("screenMenu");
  hide("screenUniformes");
  hide("screenMateriais");
  show("screenEPIs");

  renderEPIs();

  setBottomActions(`
    <button class="secondary" onclick="bootstrap()">Recarregar</button>
    <button onclick="salvarEPIs()">Enviar Solicita√ß√£o</button>
  `);
}

/** UNIFORMES (‚úÖ ordena por supervis√£o -> nome + separador por supervis√£o) */
function renderUniformes(){
  const colsRaw = Array.isArray(ctx?.colaboradores) ? ctx.colaboradores : [];
  const cols = sortColabsBySupThenName(colsRaw);
  const tamanhos = Array.isArray(ctx?.tamanhos) ? ctx.tamanhos : ["PP","P","M","G","GG","XG","G1","G2","G3"];

  document.getElementById("pdfArea").innerHTML = "";
  document.getElementById("saveStatusUniformes").innerText = "";

  if(!cols.length){
    document.getElementById("listaUniformes").innerHTML =
      `<div class="muted">Nenhum colaborador encontrado para este gestor.</div>`;
  }else{
    let lastSupKey = null;

    const html = cols.map(c=>{
      const nome = c.colaborador;
      const sup = String(c.supervisao || "").trim();
      const supLabel = sup || "SEM SUPERVIS√ÉO";

      const supKey = isSemSup_(supLabel) ? "ZZZ" : normKey(supLabel);
      const showHeader = (supKey !== lastSupKey);
      lastSupKey = supKey;

      const val = (formUniformes[nome]?.tamanho || "M").toUpperCase();

      return `
        ${showHeader ? `
          <div class="supHeader">
            ${esc(supLabel)}
            <small>Colaboradores desta supervis√£o</small>
          </div>
        ` : ""}

        <div class="item">
          <div>
            <div class="nm">${esc(nome)}</div>
            <div class="sub">Supervis√£o: ${esc(supLabel)}</div>
          </div>
          <select onchange="onUniformSizeChange('${encodeURIComponent(nome)}', this.value)">
            ${tamanhos.map(t=>`<option ${String(t).toUpperCase()===val?"selected":""}>${esc(String(t).toUpperCase())}</option>`).join("")}
          </select>
        </div>
      `;
    }).join("");

    document.getElementById("listaUniformes").innerHTML = html;
  }

  const outrosHtml = tamanhos.map((t)=>{
    const T = String(t).toUpperCase();
    const qtd = Number(formOutrosQtd?.[T] || 0);

    return `
      <div class="othersUniRow">
        <input value="OUTROS" disabled>
        <select disabled><option selected>${esc(T)}</option></select>
        <input type="number" min="0" step="1" value="${qtd}"
               oninput="onOutroQtdChangeUniforme('${encodeURIComponent(T)}', this.value)"
               placeholder="Un">
      </div>
    `;
  }).join("");

  document.getElementById("listaOutrosUniformes").innerHTML = outrosHtml;
}

function onUniformSizeChange(encNome, val){
  const nome = decodeURIComponent(encNome);
  if(!formUniformes[nome]) formUniformes[nome] = {};
  formUniformes[nome].tamanho = String(val||"M").toUpperCase();
}

function onOutroQtdChangeUniforme(encT, v){
  const t = decodeURIComponent(encT);
  const n = Math.max(0, parseInt(v || "0", 10) || 0);
  formOutrosQtd[t] = n;
}

function b64ToBlob(b64, mime){
  const bin = atob(b64);
  const len = bin.length;
  const bytes = new Uint8Array(len);
  for(let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
  return new Blob([bytes], { type: mime || "application/pdf" });
}

function autoDownloadBlob(url, filename){
  const a = document.createElement("a");
  a.href = url;
  a.download = filename || "Relacao_Tamanhos.pdf";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

async function salvarUniformes(){
  if(!ctx) return;

  const dataRef = ctx.dataRef;
  const cols = Array.isArray(ctx.colaboradores) ? ctx.colaboradores : [];
  const tamanhos = Array.isArray(ctx?.tamanhos) ? ctx.tamanhos : ["PP","P","M","G","GG","XG","G1","G2","G3"];

  if(!cols.length){
    alert("Nenhum colaborador na lista.");
    return;
  }

  const itens = cols.map(c=>{
    const nome = c.colaborador;
    return {
      colaborador: nome,
      supervisao: c.supervisao || "",
      // coordenacao: c.coordenacao || "",
      tamanho: (formUniformes[nome]?.tamanho || "M").toUpperCase()
    };
  });

  const outros = {};
  tamanhos.forEach(t=>{
    const T = String(t).toUpperCase();
    const qtd = Number(formOutrosQtd?.[T] || 0);
    if(qtd > 0) outros[T] = qtd;
  });

  setBusy(true);
  document.getElementById("saveStatusUniformes").innerText = "Salvando e gerando PDF...";
  document.getElementById("pdfArea").innerHTML = "";

  const res = await api("salvarTamanhos", { payload: { dataRef, itens, outros } });
  setBusy(false);

  if(!res || !res.ok){
    document.getElementById("saveStatusUniformes").innerText = res?.error || "Erro ao salvar";
    return;
  }

  document.getElementById("saveStatusUniformes").innerText =
    `‚úÖ Salvo! Linhas gravadas: ${res.saved_colaboradores} | Supervis√µes: ${res.saved_supervisao}`;

  showToast(res.message || "Uniformes enviados com sucesso!");

  const pdf = res.pdf || {};
  if(pdf.b64){
    const blob = b64ToBlob(pdf.b64, "application/pdf");
    const url = URL.createObjectURL(blob);
    const fileName = (pdf.fileName || "Relacao_Tamanhos.pdf");

    document.getElementById("pdfArea").innerHTML = `
      <a href="${url}" download="${esc(fileName)}">‚¨áÔ∏è Baixar PDF</a>
      <div class="muted">Se n√£o baixar automaticamente, clique no link.</div>
    `;

    autoDownloadBlob(url, fileName);
  }else{
    document.getElementById("pdfArea").innerHTML = `<div class="muted">PDF n√£o retornou.</div>`;
  }

  tamanhos.forEach(t => formOutrosQtd[String(t).toUpperCase()] = 0);
  renderUniformes();
}

/** MATERIAIS */
function renderMateriais(){
  document.getElementById("saveStatusMateriais").innerText = "";

  const fixosHtml = MATERIAIS_FIXOS.map(m=>{
    const qtd = Number(formMateriais[m] || 0);
    return `
      <div class="qtyRow">
        <div class="matName">${esc(m)}</div>
        <input type="number" min="0" step="1" value="${qtd}"
               oninput="onMaterialQtyChange('${encodeURIComponent(m)}', this.value)"
               placeholder="Qtd">
      </div>
    `;
  }).join("");

  document.getElementById("listaMateriais").innerHTML = fixosHtml;

  const outrosHtml = formOutros.map((it, idx)=>{
    return `
      <div class="othersRow">
        <input value="${esc(it.nome)}" placeholder="Nome do material (outros)"
               oninput="onOutroNomeChange(${idx}, this.value)">
        <input type="number" min="0" step="1" value="${Number(it.qtd||0)}"
               oninput="onOutroQtdChangeMat(${idx}, this.value)"
               placeholder="Qtd">
        <button class="iconBtn" onclick="limparOutroMat(${idx})" title="Limpar">‚úï</button>
      </div>
    `;
  }).join("");

  document.getElementById("listaOutros").innerHTML = outrosHtml;
}

function onMaterialQtyChange(encMat, v){
  const mat = decodeURIComponent(encMat);
  const n = Math.max(0, parseInt(v || "0", 10) || 0);
  formMateriais[mat] = n;
}

function onOutroNomeChange(i, v){ formOutros[i].nome = String(v || "").trim(); }
function onOutroQtdChangeMat(i, v){ formOutros[i].qtd = Math.max(0, parseInt(v || "0", 10) || 0); }
function limparOutroMat(i){ formOutros[i] = { nome:"", qtd:0 }; renderMateriais(); }

async function salvarMateriais(){
  if(!ctx) return;

  const dataRef = ctx.dataRef || "";
  const itens = [];

  MATERIAIS_FIXOS.forEach(m=>{
    const qtd = Number(formMateriais[m] || 0);
    if(qtd > 0) itens.push({ material: m, un: qtd });
  });

  formOutros.forEach(o=>{
    const nome = String(o.nome||"").trim();
    const qtd = Number(o.qtd||0);
    if(nome && qtd > 0) itens.push({ material: nome, un: qtd });
  });

  if(!itens.length){
    document.getElementById("saveStatusMateriais").innerText =
      "Informe pelo menos 1 material com quantidade maior que 0.";
    return;
  }

  setBusy(true);
  document.getElementById("saveStatusMateriais").innerText = "Enviando solicita√ß√£o...";
  const res = await api("salvarMateriais", { payload: { dataRef, itens } });
  setBusy(false);

  if(!res || !res.ok){
    document.getElementById("saveStatusMateriais").innerText = res?.error || "Erro ao enviar";
    return;
  }

  document.getElementById("saveStatusMateriais").innerText =
    `‚úÖ Solicita√ß√£o enviada! Linhas gravadas: ${res.saved || 0}`;

  showToast(res.message || "Materiais enviados com sucesso!");

  MATERIAIS_FIXOS.forEach(m => formMateriais[m] = 0);
  formOutros = [
    { nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 }
  ];
  renderMateriais();
}

/** EPIs */
function renderEPIs(){
  document.getElementById("saveStatusEPIs").innerText = "";

  const fixosHtml = EPIS_FIXOS.map(epi=>{
    if(epi === "Botina"){
      const lista = botinaItens.map((it, idx)=>`
        <div class="othersRow" style="border-bottom:none; padding:8px 0;">
          <input value="Tam ${esc(it.tam)}" disabled>
          <input type="number" min="0" step="1" value="${Number(it.qtd||0)}"
                 oninput="onBotinaQtdChange(${idx}, this.value)"
                 placeholder="Un">
          <button class="iconBtn" onclick="removerBotina(${idx})" title="Remover">‚úï</button>
        </div>
      `).join("");

      return `
        <div style="padding:10px 0; border-bottom:1px solid #f3f4f6;">
          <div class="qtyRow" style="border-bottom:none; padding:0 0 6px 0;">
            <div class="matName"><b>Botina</b> <span class="muted">Digite o tamanho</span></div>
            <div></div>
          </div>

          <div class="botinaInlineRow">
            <input value="${esc(botinaTamInput)}"
                   placeholder="Digite o tamanho"
                   inputmode="numeric"
                   oninput="onBotinaTamInput(this.value)">
            <input type="number" min="0" step="1" value="${Number(botinaQtdInput||0)}"
                   oninput="onBotinaQtdInput(this.value)"
                   placeholder="Un">
            <button class="botinaPlusBtn" onclick="addBotina()" title="Adicionar">+</button>
          </div>

          <div>${lista || `<div class="muted" style="margin-top:6px;">Nenhum tamanho adicionado.</div>`}</div>
        </div>
      `;
    }

    const qtd = Number(formEPIs[epi] || 0);
    return `
      <div class="qtyRow">
        <div class="matName">${esc(epi)}</div>
        <input type="number" min="0" step="1" value="${qtd}"
               oninput="onEpiQtyChange('${encodeURIComponent(epi)}', this.value)"
               placeholder="Un">
      </div>
    `;
  }).join("");

  document.getElementById("listaEPIs").innerHTML = fixosHtml;

  const outrosHtml = formOutrosEPIs.map((it, idx)=>{
    return `
      <div class="othersRow">
        <input value="${esc(it.nome)}" placeholder="Nome do EPI (outros)"
               oninput="onOutroEpiNomeChange(${idx}, this.value)">
        <input type="number" min="0" step="1" value="${Number(it.qtd||0)}"
               oninput="onOutroEpiQtdChange(${idx}, this.value)"
               placeholder="Un">
        <button class="iconBtn" onclick="limparOutroEpi(${idx})" title="Limpar">‚úï</button>
      </div>
    `;
  }).join("");

  document.getElementById("listaOutrosEPIs").innerHTML = outrosHtml;
}

function onEpiQtyChange(encEpi, v){
  const epi = decodeURIComponent(encEpi);
  const n = Math.max(0, parseInt(v || "0", 10) || 0);
  formEPIs[epi] = n;
}

function onBotinaTamInput(v){
  botinaTamInput = String(v||"").trim();
}
function onBotinaQtdInput(v){
  botinaQtdInput = Math.max(0, parseInt(v||"0", 10) || 0);
}
function onBotinaQtdChange(i, v){
  const n = Math.max(0, parseInt(v||"0", 10) || 0);
  if(botinaItens[i]) botinaItens[i].qtd = n;
}
function removerBotina(i){
  botinaItens.splice(i, 1);
  renderEPIs();
}

function addBotina(){
  const tam = String(botinaTamInput||"").trim();
  const qtd = Math.max(0, parseInt(botinaQtdInput||"0", 10) || 0);

  if(!tam){
    document.getElementById("saveStatusEPIs").innerText = "Botina: digite o tamanho.";
    return;
  }
  if(qtd <= 0){
    document.getElementById("saveStatusEPIs").innerText = "Botina: informe a unidade (> 0).";
    return;
  }

  const tamKey = tam.replace(/\s+/g," ").trim();

  const idx = botinaItens.findIndex(x => String(x.tam) === tamKey);
  if(idx >= 0){
    botinaItens[idx].qtd = Number(botinaItens[idx].qtd||0) + qtd;
  }else{
    botinaItens.push({ tam: tamKey, qtd });
  }

  botinaTamInput = "";
  botinaQtdInput = 0;
  document.getElementById("saveStatusEPIs").innerText = "";
  renderEPIs();
}

function onOutroEpiNomeChange(i, v){ formOutrosEPIs[i].nome = String(v || "").trim(); }
function onOutroEpiQtdChange(i, v){ formOutrosEPIs[i].qtd = Math.max(0, parseInt(v || "0", 10) || 0); }
function limparOutroEpi(i){ formOutrosEPIs[i] = { nome:"", qtd:0 }; renderEPIs(); }

async function salvarEPIs(){
  if(!ctx) return;

  const dataRef = ctx.dataRef || "";
  const itens = [];

  EPIS_FIXOS.forEach(epi=>{
    if(epi === "Botina") return;
    const qtd = Number(formEPIs[epi] || 0);
    if(qtd > 0) itens.push({ epi, un: qtd });
  });

  botinaItens.forEach(it=>{
    const qtd = Number(it.qtd||0);
    const tam = String(it.tam||"").trim();
    if(tam && qtd > 0){
      itens.push({ epi:"Botina", tamanho: tam, un: qtd });
    }
  });

  const outros = formOutrosEPIs.map(o=>({
    nome: String(o.nome||"").trim(),
    un: Math.max(0, parseInt(o.qtd||0, 10) || 0)
  }));

  const hasOutros = outros.some(o => o.nome && o.un > 0);
  if(!itens.length && !hasOutros){
    document.getElementById("saveStatusEPIs").innerText =
      "Informe pelo menos 1 EPI com unidade maior que 0.";
    return;
  }

  setBusy(true);
  document.getElementById("saveStatusEPIs").innerText = "Enviando solicita√ß√£o...";
  const res = await api("salvarEPIs", { payload: { dataRef, itens, outros } });
  setBusy(false);

  if(!res || !res.ok){
    document.getElementById("saveStatusEPIs").innerText = res?.error || "Erro ao enviar";
    return;
  }

  document.getElementById("saveStatusEPIs").innerText =
    `‚úÖ Solicita√ß√£o enviada! Linhas gravadas: ${res.saved || 0}`;

  showToast(res.message || "EPI's enviados com sucesso!");

  EPIS_FIXOS.forEach(e => formEPIs[e] = 0);
  botinaItens = [];
  botinaTamInput = "";
  botinaQtdInput = 0;
  formOutrosEPIs = [
    { nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 },{ nome:"", qtd:0 }
  ];
  renderEPIs();
}

window.onload = async ()=>{
  const pin = document.getElementById("pin");
  pin.addEventListener("input", ()=> pin.value = onlyDigits(pin.value).slice(0,4));
  pin.addEventListener("keydown", (e)=>{ if(e.key==="Enter") login(); });

  show("loginCard");
  hide("app"); hide("bottomBar");

  if(token){
    const p = await api("ping", {});
    if(p && p.ok){
      hide("loginCard"); show("app"); show("bottomBar");
      await bootstrap();
    }else{
      logout();
    }
  }
};
</script>
</body>
</html>
